===== ARCHIVO: FASES.md =====
ğŸ§± 1) NÃšCLEO (Core Platform)
ğŸ“Œ Identidad, seguridad, multiempresa, auditorÃ­a, archivos.

Es el cimiento obligatorio.

Incluye:

Users

User Security Events

User Sessions

Companies

Memberships

Roles

Legal Acceptances

Audit Log

Company Settings

Files + File Links

InstalaciÃ³n inicial

Login / Logout

Regla 4equim

Estados lÃ³gicos

Multiempresa real

ğŸ‘‰ Sin esto, no existe SISA.
Sin esto, no podÃ©s construir ERP.
Sin esto, no podÃ©s garantizar contabilidad.

Este mÃ³dulo SIEMPRE VA PRIMERO.

ğŸ“˜ 2) NEGOCIO (ERP Operativo)
ğŸ“Œ Registra hechos reales, NO los interpreta contablemente.

AcÃ¡ va todo lo operativo del dÃ­a a dÃ­a:

Jobs (Ã³rdenes de trabajo)

Job Time Entries

Job Checklist Items

Quotes

Sales

Purchases

Invoices

Receipts

Payments

Adjustments

Estados, lifecycles, auditorÃ­as

Validaciones cruzadas ERP

ğŸ‘‰ Fase 2 produce eventos operativos inmutables.
These events are the raw material of accounting.

Este mÃ³dulo SIEMPRE VA DESPUÃ‰S DEL NÃšCLEO
y SIEMPRE VA ANTES de la contabilidad.

Si lo invertÃ­s â†’ te explota la consistencia temporal.

ğŸ“™ 3) CONTABILIDAD (ACCCORE â€“ Fase 3)
ğŸ“Œ Interpreta los eventos operativos del ERP y produce informaciÃ³n contable real.

Incluye:

Plan de cuentas

Asientos contables

Centros de costo

IVA

Percepciones / Retenciones

Cierres contables

Mayor analÃ­tico

Balance, PyG

Devengamientos

Contabilidad por empresa

AuditorÃ­a contable

Reglas fiscales

ğŸ‘‰ Contabilidad NO puede existir antes del ERP.
NUNCA se generan asientos directamente desde mÃ³dulos operativos.
SIEMPRE debe hacerse desde eventos auditables.

ğŸ¯ Resumen brutalmente claro
âœ” 1) CORE

FundaciÃ³n del sistema
(lo que hace posible todo)

âœ” 2) NEGOCIO / ERP

Registra hechos
(no interpreta nada)

âœ” 3) CONTABILIDAD

Interpreta hechos â†’ genera asientos

ğŸ¯ Orden obligatorio

1ï¸âƒ£ Core Platform
2ï¸âƒ£ ERP Operativo (Negocio)
3ï¸âƒ£ Contabilidad (ACCCORE)

---

## **âœ… CHECKLIST PREâ€‘IMPLEMENTACIÃ“N (GENERAL)**

- [ ] SeparaciÃ³n de capas: Core â‰  ACL â‰  ERP â‰  Contabilidad.
- [ ] Roles gruesos limitan; no otorgan permisos finos.
- [ ] Permisos finos explÃ­citos; sin herencia implÃ­cita.
- [ ] Hardâ€‘deny por rol grueso aplicado antes de roles finos.
- [ ] AuditorÃ­a obligatoria en cambios de estado, datos y denegaciones crÃ­ticas.
- [ ] Inmutabilidad: sin borrado fÃ­sico; correcciones por eventos.
- [ ] Regla 4equim vigente.
- [ ] Toda escritura en transacciÃ³n.
- [ ] Contabilidad solo vÃ­a AccountingService.
- [ ] `X-Company-Id` y membership activa siempre verificados.
- [ ] Idempotencia cuando corresponda (offline/sync).
- [ ] No lÃ³gica de permisos en UI.

---

## **ğŸ“Œ FASE Y ALCANCE (DECLARACIÃ“N OBLIGATORIA)**

- Fase actual debe declararse explÃ­citamente antes de implementar.
- Core: identidad, seguridad, multiempresa, auditorÃ­a, archivos, 4equim. **Sin permisos finos ni negocio.**
- ACL/RBAC: permisos atÃ³micos, roles finos, overrides, auditorÃ­a de autorizaciÃ³n. **Sin ERP ni contabilidad.**
- ERP: eventos operativos inmutables y lifecycles. **Sin contabilidad ni permisos.**
- Contabilidad: asientos solo desde eventos ERP vÃ­a AccountingService. **Nunca desde UI/endpoints directos.**


===== ARCHIVO: offline-events.md =====
# Offline Events Queue â€” SISA

## ğŸ¯ Objetivo

Definir el **modelo de cola de eventos offline** utilizado por SISA para registrar acciones realizadas sin conectividad y sincronizarlas de forma **segura**, **auditable** y **determinista**.

Esta cola es la **Ãºnica vÃ­a vÃ¡lida** para introducir cambios offline al sistema.

---

## ğŸ§  Principios no negociables

- La cola es **append-only**
- Los eventos **no se editan**
- Los eventos **no se eliminan**
- El servidor es la **fuente de verdad final**
- El orden importa
- La validaciÃ³n siempre ocurre **en el servidor**

---

## ğŸ§± Concepto central

Un **Offline Event** representa **una acciÃ³n del usuario**, no un estado final.

Ejemplo:
- âœ” â€œEl usuario iniciÃ³ el trabajoâ€
- âŒ â€œEl trabajo quedÃ³ en progresoâ€

---

## ğŸ§¾ Estructura lÃ³gica de un Offline Event

Cada evento contiene:

- `event_id` â€” UUID Ãºnico
- `entity_type` â€” Job, ChecklistItem, TimeEntry, File
- `entity_id` â€” ID de la entidad afectada
- `action` â€” AcciÃ³n ejecutada
- `payload` â€” Datos mÃ­nimos necesarios
- `actor_user_id`
- `company_id`
- `device_id`
- `local_timestamp`
- `sequence_number`
- `status` â€” pending / synced / rejected
- `hash` â€” integridad del evento

---

## ğŸ§® Orden y secuencia

- Cada dispositivo mantiene un `sequence_number` incremental
- El servidor valida:
  - duplicados
  - saltos de secuencia
  - reenvÃ­os
- El orden de procesamiento es **estricto por dispositivo**
- No existe orden global entre dispositivos

---

## ğŸ”„ Tipos de eventos permitidos

### Jobs
- `job_started`
- `job_paused`
- `job_resumed`
- `job_note_added`

### Checklists
- `checklist_item_completed`
- `checklist_item_failed`
- `checklist_item_note_added`

### Tiempos
- `time_entry_started`
- `time_entry_stopped`
- `time_entry_corrected`

### Archivos
- `file_captured`
- `file_metadata_updated`

---

## âŒ Eventos explÃ­citamente prohibidos offline

- `job_completed`
- `job_cancelled`
- `accounting_entry_created`
- `invoice_created`
- `user_created`
- `role_changed`

Estos eventos **solo existen online**.

---

## ğŸ” ValidaciÃ³n en el servidor

Cada evento es validado contra:

- Estado actual de la entidad
- MÃ¡quina de estados
- Permisos del usuario
- Empresa activa
- Consistencia temporal
- DuplicaciÃ³n

Resultado:
- **Aceptado** â†’ aplicado + marcado como synced
- **Rechazado** â†’ marcado como rejected + auditado

---

## âš ï¸ Manejo de conflictos

Ejemplos:
- Evento aplicado sobre estado invÃ¡lido
- Evento duplicado
- Evento fuera de orden

Regla:
- El evento **no se reintenta automÃ¡ticamente**
- Se registra el rechazo
- Se notifica al usuario
- Un rechazo **no bloquea** los eventos posteriores

---

## ğŸ§¾ AuditorÃ­a

Cada evento queda registrado con:

- Payload original
- Timestamps (local + server)
- Resultado de validaciÃ³n
- Motivo de rechazo (si aplica)

Nunca se borra.

---

## ğŸ†” Identidad del dispositivo

- `device_id` se registra y **no se recicla**
- Revocar un dispositivo:
  - invalida eventos futuros
  - **no invalida eventos pasados**

---

## â™»ï¸ ReinstalaciÃ³n de la app

- La cola offline es **volÃ¡til por diseÃ±o**
- No se garantiza persistencia cross-install
- Si el usuario desinstala, **asume la pÃ©rdida** de eventos locales

Esto debe informarse explÃ­citamente en UX.

---

## â±ï¸ Timestamps

- Siempre se guardan:
  - `local_timestamp`
  - `server_timestamp`
- Las reglas se evalÃºan contra:
  - server time (primario)
  - local time (referencial)
- Nunca se â€œcorrigeâ€ el tiempo local

---

## ğŸ§± Persistencia local

- Base local (SQLite / almacenamiento seguro)
- Cola transaccional
- ConfirmaciÃ³n explÃ­cita de sync
- Soporte para reintentos manuales

---

## ğŸ” Seguridad

- Eventos firmados con hash
- Asociados a dispositivo y usuario
- No se aceptan eventos sin autenticaciÃ³n previa vÃ¡lida

---

## ğŸ§­ UX obligatoria

La UI debe mostrar:
- eventos pendientes
- eventos rechazados
- motivo claro
- acciÃ³n sugerida

No mostrar esto = bug funcional.

---

## âœ… ConclusiÃ³n

La cola de eventos offline en SISA:

- No intenta â€œrecrear estadosâ€
- No corrige el pasado
- No asume autoridad

Solo **narra hechos**.

El servidor decide quÃ© hechos son vÃ¡lidos.

---


===== ARCHIVO: offline-scope-boundary.md =====
# Offline Scope Boundary â€” SISA

## ğŸ¯ Objetivo

Definir **lÃ­mites explÃ­citos e inquebrantables** sobre quÃ© **nunca** puede implementarse en modo offline dentro de SISA.

Este documento existe para:
- prevenir degradaciÃ³n arquitectÃ³nica
- evitar â€œexcepciones cÃ³modasâ€
- proteger el core del sistema a largo plazo

---

## ğŸ§  Principio absoluto

> **El offline no define verdad, solo registra intentos.**

Cualquier funcionalidad que contradiga este principio  
**queda automÃ¡ticamente fuera de alcance**.

---

## ğŸš« CategorÃ­as prohibidas para Offline

Las siguientes categorÃ­as **no pueden** operar offline, **bajo ningÃºn escenario**.

---

### 1ï¸âƒ£ Dinero y contabilidad

Incluye (sin excepciÃ³n):

- Asientos contables
- Pagos
- Cobros
- FacturaciÃ³n
- Notas de crÃ©dito / dÃ©bito
- Cierres contables
- Ajustes de balance
- Reversiones financieras

**Motivo**
- Riesgo legal
- Riesgo fiscal
- Dependencias cruzadas
- Impacto irreversible

âŒ Nunca offline  
âŒ Nunca â€œmodo borradorâ€ offline  
âŒ Nunca sincronizaciÃ³n diferida

---

### 2ï¸âƒ£ Estados terminales

Estados finales o irreversibles:

- `completed`
- `cancelled`
- `closed`
- `archived`

**Motivo**
- Disparan efectos colaterales
- Pueden cerrar flujos contables u operativos
- Definen historia final

âœ” Pueden **proponerse** offline  
âŒ Nunca confirmarse offline

---

### 3ï¸âƒ£ Datos maestros estructurales

Incluye:

- Empresas
- Clientes
- Proveedores
- Productos / servicios
- Carpetas raÃ­z
- ConfiguraciÃ³n global
- CatÃ¡logos base

**Motivo**
- Alta dependencia
- Riesgo de duplicaciÃ³n
- Rompen integridad referencial

âŒ No se crean offline  
âŒ No se editan offline  
âŒ No se eliminan offline

---

### 4ï¸âƒ£ Seguridad y permisos

Incluye:

- CreaciÃ³n de usuarios
- Cambios de rol
- AsignaciÃ³n de empresas
- RevocaciÃ³n de accesos
- PolÃ­ticas de seguridad

**Motivo**
- Riesgo de escalamiento de privilegios
- ViolaciÃ³n de modelo de seguridad

âŒ Nunca offline  
âŒ Nunca cache editable

---

### 5ï¸âƒ£ ConfiguraciÃ³n del sistema

Incluye:

- ParÃ¡metros globales
- Reglas de negocio
- MÃ¡quinas de estado
- Flags de comportamiento

**Motivo**
- Cambios sistÃ©micos
- Impacto transversal
- DifÃ­cil rollback

---

## âš ï¸ Zonas grises explÃ­citamente cerradas

Las siguientes ideas **parecen razonables**, pero estÃ¡n **prohibidas**:

- â€œModo borrador offlineâ€ para facturas
- â€œPre-crear clientes offlineâ€
- â€œCerrar trabajos offline y confirmar despuÃ©sâ€
- â€œEditar permisos sin conexiÃ³nâ€
- â€œSincronizar contabilidad al reconectarâ€

Si alguien propone esto:
ğŸ‘‰ la respuesta es **NO**.

---

## âœ… CategorÃ­as permitidas Offline (recordatorio)

El offline **solo** se admite para:

- Registro de acciones operativas
- Checklists
- Tiempos trabajados
- Archivos y evidencias
- Observaciones
- Lectura de datos de referencia

Siempre bajo:
- cola de eventos
- validaciÃ³n server-side
- auditorÃ­a

---

## ğŸ§± Regla de decisiÃ³n rÃ¡pida

Ante cualquier feature nueva, preguntarse:

1. Â¿Afecta dinero?
2. Â¿Define una verdad del sistema?
3. Â¿Cambia permisos o estructura?
4. Â¿Es irreversible?

Si la respuesta es **sÃ­** a cualquiera:
ğŸ‘‰ **No es offline**.

---

## ğŸ” Autoridad final

- Este documento **tiene prioridad** sobre:
  - decisiones de UX
  - pedidos comerciales
  - conveniencias tÃ©cnicas
- Ninguna feature puede violarlo sin **romper SISA**

---

## âœ… ConclusiÃ³n

El offline en SISA:

- es acotado
- es consciente
- es responsable
- es defendible

Este boundary existe para que el sistema **no se desarme con el tiempo**.

---


===== ARCHIVO: offline-strategy.md =====
# Offline Strategy â€” SISA

## ğŸ¯ Objetivo

Definir **cuÃ¡ndo**, **dÃ³nde** y **por quÃ©** SISA aplica el enfoque **offline-first**, evitando inconsistencias, riesgos contables o violaciones de reglas de negocio.

SISA **no es offline-first por defecto**.  
Es **offline-inteligente**.

---

## ğŸ§  Principio rector

> **Si el dato representa un hecho ocurrido â†’ puede ser offline-first**  
> **Si el dato representa una verdad del sistema â†’ es online-only**

Este principio gobierna todas las decisiones offline del sistema.

---

## âœ… Casos donde SÃ aplica Offline-first

### 1. Jobs en ejecuciÃ³n

**Contexto**  
OperaciÃ³n en campo con conectividad inestable o inexistente.

**Acciones permitidas offline**
- VisualizaciÃ³n de Jobs asignados
- Transiciones operativas:
  - `planned â†’ in_progress`
  - `in_progress â†’ paused`
- Registro de observaciones
- AsociaciÃ³n de participantes
- Registro de tramos horarios
- Adjuntar archivos

**Estrategia**
- Cache local estructurada
- Cola de eventos append-only
- SincronizaciÃ³n diferida con validaciÃ³n de estado

---

### 2. Checklists / Consignas operativas

**DescripciÃ³n**
- Ãtems ejecutables
- Pueden realizarse mÃºltiples veces por Job
- Asociados al momento real de ejecuciÃ³n

**Offline**
- EjecuciÃ³n completa offline
- Persistencia local con timestamp real
- SincronizaciÃ³n posterior

---

### 3. Tiempos trabajados

**CaracterÃ­sticas**
- Registro de inicio / fin
- MÃºltiples tramos por Job
- Correcciones permitidas con historial

**Offline**
- Captura local
- ValidaciÃ³n en sincronizaciÃ³n
- Nunca se pisa historial existente

---

### 4. Captura de archivos

**Ejemplos**
- Fotos de equipos
- Videos de fallas
- Evidencias tÃ©cnicas

**Flujo**
1. Guardado local
2. AsociaciÃ³n de metadata
3. Upload diferido
4. VinculaciÃ³n al Job / checklist correspondiente

---

### 5. Datos de referencia (solo lectura)

**Ejemplos**
- Clientes
- Productos / servicios
- Carpetas
- Estados vÃ¡lidos

**RestricciÃ³n**
- Lectura offline permitida
- CreaciÃ³n y ediciÃ³n **solo online**

---

## âŒ Casos donde NO aplica Offline-first

### 1. Contabilidad

**Prohibido offline**
- Asientos contables
- Pagos
- FacturaciÃ³n
- Cierres
- Ajustes

**Motivo**
- Riesgo financiero
- Riesgo legal
- Alta dependencia cruzada

---

### 2. Estados finales de Jobs

Estados:
- `completed`
- `cancelled`

**Regla**
- Nunca se confirman offline
- Pueden proponerse, pero requieren validaciÃ³n online

---

### 3. Usuarios y permisos

**Incluye**
- CreaciÃ³n de usuarios
- AsignaciÃ³n de roles
- VinculaciÃ³n a empresas

**Motivo**
- Riesgo de escalamiento de privilegios
- Seguridad del sistema

---

### 4. Datos maestros estructurales

**Ejemplos**
- Empresas
- Clientes / proveedores
- Productos / servicios
- ConfiguraciÃ³n global
- Estructuras contables

**Regla**
- Siempre online

---

## ğŸ§± PolÃ­tica de sincronizaciÃ³n

- Todos los eventos offline:
  - Son **append-only**
  - Nunca pisan datos existentes
  - Se validan contra el **estado actual**
- Conflictos:
  - Se rechazan eventos invÃ¡lidos
  - Se registran para auditorÃ­a
- El servidor es la **fuente de verdad final**

**Regla explÃ­cita**
- No existe â€œrebobinadoâ€ del estado para acomodar offline.
- Un evento puede ser vÃ¡lido al generarse y **rechazado al sincronizar**.
- Esto es **esperado**, no un error del sistema.

---

## ğŸ” AuditorÃ­a

Cada evento offline sincronizado:
- Tiene timestamp local
- Tiene timestamp de servidor
- Guarda autor, contexto y entidad afectada
- Nunca se elimina

---

## âš ï¸ Advertencias

- Offline-first mal aplicado **rompe sistemas**
- No se admiten â€œexcepciones por comodidadâ€
- Si una acciÃ³n afecta:
  - dinero
  - estructura
  - permisos  
  entonces **no es offline**

---

## âœ… ConclusiÃ³n

SISA aplica offline-first **solo donde agrega valor real**, sin comprometer:

- consistencia
- seguridad
- auditabilidad
- escalabilidad

Offline no es libertad.  
Es **responsabilidad controlada**.

---


===== ARCHIVO: README.md =====
# SISA â€” Sistema Integrado de Servicios Administrativos

SISA es una **plataforma ERP modular**, diseÃ±ada para **empresas reales**, con foco en **trazabilidad total**, **control operativo**, **contabilidad sÃ³lida** y **escalabilidad progresiva**.

No es un MVP de juguete.  
No es un clon liviano de otro sistema.  
Es un **core empresarial serio**, pensado para crecer sin romperse.

---

## ğŸ¯ Objetivo del sistema

Construir un **nÃºcleo administrativo y operativo** que permita:

- Gestionar **empresas, clientes y proveedores**
- Controlar **operaciones (Jobs)** con estados estrictos
- Registrar **consignas, checklists y ejecuciÃ³n real**
- Manejar **tiempos trabajados**, participantes y recursos
- Integrar **contabilidad**, **facturaciÃ³n** y **auditorÃ­a**
- Escalar hacia **automatizaciÃ³n, IA y anÃ¡lisis avanzado**

SISA estÃ¡ pensado como **base estructural**, no como producto descartable.

---

## ğŸ§± Principios no negociables

- âŒ **Nada se borra fÃ­sicamente**
- âœ… Todo es **auditable**
- âœ… Estados con **mÃ¡quinas de estado estrictas**
- âŒ No hay â€œexcepciones mÃ¡gicasâ€
- âœ… El sistema refleja la **realidad operativa**
- âœ… DiseÃ±o orientado a **crecimiento y mantenimiento**

---

## ğŸ§© Arquitectura general

SISA se construye por **capas y mÃ³dulos independientes**:

### Backend
- API REST
- Arquitectura desacoplada
- Validaciones duras
- Control de permisos por rol y empresa
- Registro histÃ³rico automÃ¡tico

### Frontend
- App mÃ³vil + web
- Offline-first (cuando aplica)
- SincronizaciÃ³n controlada
- UI enfocada en operaciÃ³n real, no en estÃ©tica vacÃ­a

### Base de datos
- Modelo relacional estricto
- Historial por entidad
- Estados explÃ­citos
- Relaciones claras y no ambiguas

---

## ğŸ“¦ MÃ³dulos principales

### ğŸ¢ Empresas
- Multi-empresa real
- Usuarios con roles y permisos
- NingÃºn usuario existe sin contexto empresarial

### ğŸ‘¥ Clientes y Proveedores
- Son **referencias a Company**
- No se duplican datos
- Uso de `client_company_id` / `provider_company_id`

### ğŸ›  Jobs (Operaciones)
- NÃºcleo operativo del sistema
- No contiene fechas ni horarios directos
- Se rige por **mÃ¡quina de estados**
- Estados finales inmutables

Estados tÃ­picos:
- planned
- in_progress
- paused
- completed
- cancelled

Transiciones invÃ¡lidas explÃ­citas (ejemplos):
- completed â†’ *
- cancelled â†’ *
- in_progress â†’ planned
- paused â†’ planned

### âœ… Checklists / Consignas
- Ãtems operativos ejecutables
- Asociados al momento real de ejecuciÃ³n
- Permiten mÃºltiples ejecuciones por Job
- Cada ejecuciÃ³n puede tener distintos participantes

### â± Tiempos y Horarios
- Tablas separadas de Jobs
- Registro real de inicio y fin
- MÃºltiples tramos por trabajo
- Correcciones posibles **con historial**

### ğŸ“Š Contabilidad
- Base contable sÃ³lida
- Preparada para:
  - facturaciÃ³n
  - pagos
  - reportes
  - cierres
- DiseÃ±ada como **core independiente**

### ğŸ“ Archivos
- Vinculados a entidades
- Metadata persistente
- Soporte offline
- Historial de cambios

---

## ğŸ” Seguridad y control

- AutenticaciÃ³n obligatoria
- Permisos por rol
- Acceso por empresa
- Registro de acciones crÃ­ticas
- Sin endpoints â€œpÃºblicosâ€ innecesarios

---

## ğŸ§  FilosofÃ­a de diseÃ±o

SISA no intenta â€œhacer todo rÃ¡pidoâ€.  
Intenta **hacer lo correcto primero**.

- Primero estructura
- DespuÃ©s velocidad
- Luego automatizaciÃ³n
- Finalmente inteligencia (IA)

---

## ğŸš€ Estado del proyecto

SISA se encuentra en **desarrollo activo**, con foco en:

- ConsolidaciÃ³n del core
- Reglas duras
- DocumentaciÃ³n exhaustiva
- Base contable profesional

No se prioriza el marketing hasta que el sistema **aguante uso real**.

---

## âš ï¸ Advertencia honesta

Este sistema **no es para improvisados**.  
Si buscÃ¡s algo liviano, rÃ¡pido y descartable, **este no es el proyecto**.

Si buscÃ¡s:
- Control real
- Escalabilidad
- Orden
- Longevidad

Entonces estÃ¡s en el lugar correcto.

---

## ğŸ“„ Licencia

Pendiente de definiciÃ³n.
El core estÃ¡ pensado para uso profesional y comercial.

---

## âœï¸ Autor

Desarrollado por **Mauro Massa**  
Proyecto SISA â€” Core ERP







===== ARCHIVO: sync-conflict-policy.md =====
# Sync Conflict Policy â€” SISA

## ğŸ¯ Objetivo

Definir **cÃ³mo SISA detecta, clasifica y resuelve conflictos** durante la sincronizaciÃ³n de eventos offline, garantizando:

- consistencia
- auditabilidad
- previsibilidad
- ausencia de efectos colaterales silenciosos

En SISA **no existen conflictos â€œautomÃ¡gicosâ€**.

---

## ğŸ§  Principio rector

> **El servidor es la Ãºnica fuente de verdad.**  
> El cliente offline **propone hechos**, el servidor **decide validez**.

---

## ğŸ§© QuÃ© es un conflicto

Un conflicto ocurre cuando un **evento offline**:

- contradice el estado actual del sistema
- viola una regla de negocio
- llega fuera de contexto temporal
- fue generado sin permisos vÃ¡lidos
- ya fue aplicado (duplicado)

---

## ğŸ§± ClasificaciÃ³n de conflictos

### 1ï¸âƒ£ Conflicto de estado

**DescripciÃ³n**  
El evento intenta aplicarse sobre un estado invÃ¡lido.

**Ejemplo**
- Evento: `job_paused`
- Estado actual: `planned`

**ResoluciÃ³n**
- âŒ Evento rechazado
- ğŸ“„ Motivo registrado
- ğŸ”” Usuario notificado

---

### 2ï¸âƒ£ Conflicto de transiciÃ³n prohibida

**DescripciÃ³n**  
La acciÃ³n viola la mÃ¡quina de estados.

**Ejemplo**
- Evento: `job_resumed`
- Estado actual: `completed`

**ResoluciÃ³n**
- âŒ Evento rechazado
- ğŸ“„ AuditorÃ­a completa
- âŒ No se reintenta

---

### 3ï¸âƒ£ Conflicto de permisos

**DescripciÃ³n**
El usuario no tiene permisos vÃ¡lidos al momento de sincronizar.

**Ejemplo**
- Usuario removido de la empresa
- Rol degradado

**ResoluciÃ³n**
- âŒ Evento rechazado
- ğŸ”’ Seguridad prioritaria
- ğŸ“„ Registro de intento

---

### 4ï¸âƒ£ Conflicto temporal

**DescripciÃ³n**
El evento presenta incoherencias de tiempo.

**Ejemplos**
- Fin antes del inicio
- SuperposiciÃ³n imposible de tramos
- Timestamp invÃ¡lido

**ResoluciÃ³n**
- âŒ Evento rechazado
- ğŸ“„ Se conserva el payload original
- ğŸ”” Usuario informado

---

### 5ï¸âƒ£ Conflicto de duplicaciÃ³n

**DescripciÃ³n**
El evento ya fue procesado.

**DetecciÃ³n**
- `event_id`
- `hash`
- `sequence_number`

**ResoluciÃ³n**
- âš ï¸ Evento ignorado
- âœ” Marcado como synced
- ğŸ“„ Sin efectos colaterales

---

### 6ï¸âƒ£ Conflicto estructural

**DescripciÃ³n**
La entidad referenciada ya no existe o cambiÃ³ su contexto.

**Ejemplo**
- Job eliminado virtualmente
- Checklist deshabilitado

**ResoluciÃ³n**
- âŒ Evento rechazado
- ğŸ“„ Registro obligatorio

---

## ğŸ”„ PolÃ­tica de resoluciÃ³n

| Tipo de conflicto | AcciÃ³n |
|------------------|-------|
| Estado invÃ¡lido | Rechazo |
| TransiciÃ³n prohibida | Rechazo |
| Permisos | Rechazo |
| Temporal | Rechazo |
| Duplicado | Ignorar |
| Estructural | Rechazo |

â— **Nunca se corrige un evento automÃ¡ticamente**  
â— **Nunca se reescribe la historia**

---

## âœ… EvaluaciÃ³n independiente

- Cada evento se evalÃºa **de forma independiente**
- Un rechazo **no bloquea** la cola
- No existe rollback en cascada

Ejemplo:
- Evento 1 â†’ rechazado
- Evento 2 â†’ vÃ¡lido  
âœ” Evento 2 se aplica

---

## ğŸ” Reintentos

- âŒ No hay reintentos automÃ¡ticos
- âœ” El usuario puede:
  - revisar el motivo
  - repetir la acciÃ³n manualmente
  - generar un nuevo evento vÃ¡lido

Cada reintento es **un evento nuevo**, no una modificaciÃ³n.

---

## ğŸ§¾ AuditorÃ­a de conflictos

Todo conflicto genera:

- ID del evento
- Tipo de conflicto
- Payload original
- Usuario
- Empresa
- Dispositivo
- Timestamp local y de servidor
- Motivo tÃ©cnico del rechazo

Estos registros **no se eliminan**.

---

## ğŸ”” ComunicaciÃ³n al usuario

El sistema debe:

- Informar claramente el rechazo
- Explicar el motivo en lenguaje operativo
- Evitar mensajes genÃ©ricos

Ejemplo vÃ¡lido:
> â€œEl trabajo ya fue completado por otro usuario antes de sincronizar.â€

Ejemplo invÃ¡lido:
> â€œError de sincronizaciÃ³n.â€

---

## ğŸ” Seguridad

- Un evento rechazado **no degrada** el sistema
- No se bloquea la cola completa
- Cada evento se evalÃºa individualmente
- No hay escalamiento de privilegios offline

---

## ğŸ§  FilosofÃ­a final

SISA **prefiere rechazar un evento vÃ¡lido**  
antes que **aceptar uno incorrecto**.

La integridad del sistema **estÃ¡ por encima de la comodidad del usuario**.

---

## âœ… ConclusiÃ³n

La polÃ­tica de conflictos de SISA garantiza que:

- el offline no corrompe el core
- los errores son visibles
- el sistema es defendible
- la historia nunca se reescribe

Sin esta polÃ­tica, el offline es una mentira peligrosa.

---


===== ARCHIVO: sync-conflicts-schema.md =====
# sync_conflicts â€” Schema Definition (SISA)

## ğŸ¯ Objetivo

Definir la estructura de la tabla `sync_conflicts`, encargada de **registrar de forma inmutable** todos los conflictos detectados durante la sincronizaciÃ³n de eventos offline.

Esta tabla es **parte del sistema de auditorÃ­a** y **no admite borrado ni ediciÃ³n**.

---

## ğŸ§  Principios de diseÃ±o

- Append-only
- AuditorÃ­a completa
- Multi-empresa real
- No depende del estado actual para interpretarse
- ReconstrucciÃ³n histÃ³rica posible sin ambigÃ¼edades

---

## ğŸ—„ Tabla: sync_conflicts

### Campos obligatorios

| Campo | Tipo | DescripciÃ³n |
|-----|-----|------------|
| `id` | UUID | Identificador Ãºnico del registro de conflicto |
| `event_id` | UUID | ID del evento offline que generÃ³ el conflicto |
| `company_id` | UUID | Empresa en la que ocurriÃ³ el conflicto |
| `entity_type` | VARCHAR | Tipo de entidad afectada (job, checklist_item, time_entry, file, etc.) |
| `entity_id` | UUID | ID de la entidad afectada |
| `conflict_type` | VARCHAR | ClasificaciÃ³n del conflicto |
| `action` | VARCHAR | AcciÃ³n intentada (ej: job_paused) |
| `payload` | JSON | Payload original del evento offline |
| `user_id` | UUID | Usuario que generÃ³ el evento |
| `device_id` | VARCHAR | Identificador del dispositivo |
| `local_timestamp` | DATETIME | Timestamp generado en el dispositivo |
| `server_timestamp` | DATETIME | Timestamp del servidor al procesar |
| `rejection_reason` | TEXT | Motivo tÃ©cnico del rechazo |
| `created_at` | DATETIME | Momento de inserciÃ³n del registro |

---

## ğŸ§¾ conflict_type â€” valores esperados

`conflict_type` **no es libre**, debe responder a un set controlado.

Valores recomendados:

- `invalid_state`
- `invalid_transition`
- `permission_denied`
- `temporal_inconsistency`
- `duplicate_event`
- `structural_conflict`
- `unknown_entity`
- `validation_error`

> â— No se usan enums rÃ­gidos para permitir evoluciÃ³n controlada.

---

## ğŸ”— Relaciones conceptuales

- `event_id` â†’ offline_events.event_id
- `company_id` â†’ companies.id
- `user_id` â†’ users.id
- `entity_id` â†’ entidad correspondiente segÃºn `entity_type`

âš ï¸ **No se usan foreign keys obligatorias**  
Motivo: la entidad puede haber sido eliminada virtualmente.

---

## ğŸ§± Reglas duras

- NingÃºn registro se elimina
- NingÃºn registro se modifica
- No se reutiliza `event_id`
- Un mismo evento genera **mÃ¡ximo un conflicto**
- La ausencia de `company_id` invalida el registro

---

## ğŸ” RetenciÃ³n y acceso

- RetenciÃ³n: **indefinida**
- Acceso:
  - solo admins
  - solo lectura
  - nunca editable
- No visible para usuarios finales estÃ¡ndar

---

## ğŸ” Casos de uso cubiertos

- AuditorÃ­a legal
- Debugging tÃ©cnico
- Soporte al usuario
- AnÃ¡lisis de fallas offline
- MÃ©tricas de calidad de sincronizaciÃ³n

---

## âš ï¸ Errores que este schema evita

- Conflictos sin contexto empresarial
- Logs ambiguos
- Reescritura de historia
- Debugging basado en suposiciones
- â€œFuncionÃ³ en mi telÃ©fonoâ€

---

## âœ… ConclusiÃ³n

La tabla `sync_conflicts` es:

- un registro de verdad
- una defensa tÃ©cnica
- una herramienta legal
- un seguro contra corrupciÃ³n silenciosa

Si esta tabla existe y se respeta, el offline **no miente**.

---


===== ARCHIVO: xxx_resultado_unificado.txt =====
===== ARCHIVO: FASES.md =====
ğŸ§± 1) NÃšCLEO (Core Platform)
ğŸ“Œ Identidad, seguridad, multiempresa, auditorÃ­a, archivos.

Es el cimiento obligatorio.

Incluye:

Users

User Security Events

User Sessions

Companies

Memberships

Roles

Legal Acceptances

Audit Log

Company Settings

Files + File Links

InstalaciÃ³n inicial

Login / Logout

Regla 4equim

Estados lÃ³gicos

Multiempresa real

ğŸ‘‰ Sin esto, no existe SISA.
Sin esto, no podÃ©s construir ERP.
Sin esto, no podÃ©s garantizar contabilidad.

Este mÃ³dulo SIEMPRE VA PRIMERO.

ğŸ“˜ 2) NEGOCIO (ERP Operativo)
ğŸ“Œ Registra hechos reales, NO los interpreta contablemente.

AcÃ¡ va todo lo operativo del dÃ­a a dÃ­a:

Jobs (Ã³rdenes de trabajo)

Job Time Entries

Job Checklist Items

Quotes

Sales

Purchases

Invoices

Receipts

Payments

Adjustments

Estados, lifecycles, auditorÃ­as

Validaciones cruzadas ERP

ğŸ‘‰ Fase 2 produce eventos operativos inmutables.
These events are the raw material of accounting.

Este mÃ³dulo SIEMPRE VA DESPUÃ‰S DEL NÃšCLEO
y SIEMPRE VA ANTES de la contabilidad.

Si lo invertÃ­s â†’ te explota la consistencia temporal.

ğŸ“™ 3) CONTABILIDAD (ACCCORE â€“ Fase 3)
ğŸ“Œ Interpreta los eventos operativos del ERP y produce informaciÃ³n contable real.

Incluye:

Plan de cuentas

Asientos contables

Centros de costo

IVA

Percepciones / Retenciones

Cierres contables

Mayor analÃ­tico

Balance, PyG

Devengamientos

Contabilidad por empresa

AuditorÃ­a contable

Reglas fiscales

ğŸ‘‰ Contabilidad NO puede existir antes del ERP.
NUNCA se generan asientos directamente desde mÃ³dulos operativos.
SIEMPRE debe hacerse desde eventos auditables.

ğŸ¯ Resumen brutalmente claro
âœ” 1) CORE

FundaciÃ³n del sistema
(lo que hace posible todo)

âœ” 2) NEGOCIO / ERP

Registra hechos
(no interpreta nada)

âœ” 3) CONTABILIDAD

Interpreta hechos â†’ genera asientos

ğŸ¯ Orden obligatorio

1ï¸âƒ£ Core Platform
2ï¸âƒ£ ERP Operativo (Negocio)
3ï¸âƒ£ Contabilidad (ACCCORE)

---

## **âœ… CHECKLIST PREâ€‘IMPLEMENTACIÃ“N (GENERAL)**

- [ ] SeparaciÃ³n de capas: Core â‰  ACL â‰  ERP â‰  Contabilidad.
- [ ] Roles gruesos limitan; no otorgan permisos finos.
- [ ] Permisos finos explÃ­citos; sin herencia implÃ­cita.
- [ ] Hardâ€‘deny por rol grueso aplicado antes de roles finos.
- [ ] AuditorÃ­a obligatoria en cambios de estado, datos y denegaciones crÃ­ticas.
- [ ] Inmutabilidad: sin borrado fÃ­sico; correcciones por eventos.
- [ ] Regla 4equim vigente.
- [ ] Toda escritura en transacciÃ³n.
- [ ] Contabilidad solo vÃ­a AccountingService.
- [ ] `X-Company-Id` y membership activa siempre verificados.
- [ ] Idempotencia cuando corresponda (offline/sync).
- [ ] No lÃ³gica de permisos en UI.

---

## **ğŸ“Œ FASE Y ALCANCE (DECLARACIÃ“N OBLIGATORIA)**

- Fase actual debe declararse explÃ­citamente antes de implementar.
- Core: identidad, seguridad, multiempresa, auditorÃ­a, archivos, 4equim. **Sin permisos finos ni negocio.**
- ACL/RBAC: permisos atÃ³micos, roles finos, overrides, auditorÃ­a de autorizaciÃ³n. **Sin ERP ni contabilidad.**
- ERP: eventos operativos inmutables y lifecycles. **Sin contabilidad ni permisos.**
- Contabilidad: asientos solo desde eventos ERP vÃ­a AccountingService. **Nunca desde UI/endpoints directos.**


===== ARCHIVO: offline-events.md =====
# Offline Events Queue â€” SISA

## ğŸ¯ Objetivo

Definir el **modelo de cola de eventos offline** utilizado por SISA para registrar acciones realizadas sin conectividad y sincronizarlas de forma **segura**, **auditable** y **determinista**.

Esta cola es la **Ãºnica vÃ­a vÃ¡lida** para introducir cambios offline al sistema.

---

## ğŸ§  Principios no negociables

- La cola es **append-only**
- Los eventos **no se editan**
- Los eventos **no se eliminan**
- El servidor es la **fuente de verdad final**
- El orden importa
- La validaciÃ³n siempre ocurre **en el servidor**

---

## ğŸ§± Concepto central

Un **Offline Event** representa **una acciÃ³n del usuario**, no un estado final.

Ejemplo:
- âœ” â€œEl usuario iniciÃ³ el trabajoâ€
- âŒ â€œEl trabajo quedÃ³ en progresoâ€

---

## ğŸ§¾ Estructura lÃ³gica de un Offline Event

Cada evento contiene:

- `event_id` â€” UUID Ãºnico
- `entity_type` â€” Job, ChecklistItem, TimeEntry, File
- `entity_id` â€” ID de la entidad afectada
- `action` â€” AcciÃ³n ejecutada
- `payload` â€” Datos mÃ­nimos necesarios
- `actor_user_id`
- `company_id`
- `device_id`
- `local_timestamp`
- `sequence_number`
- `status` â€” pending / synced / rejected
- `hash` â€” integridad del evento

---

## ğŸ§® Orden y secuencia

- Cada dispositivo mantiene un `sequence_number` incremental
- El servidor valida:
  - duplicados
  - saltos de secuencia
  - reenvÃ­os
- El orden de procesamiento es **estricto por dispositivo**
- No existe orden global entre dispositivos

---

## ğŸ”„ Tipos de eventos permitidos

### Jobs
- `job_started`
- `job_paused`
- `job_resumed`
- `job_note_added`

### Checklists
- `checklist_item_completed`
- `checklist_item_failed`
- `checklist_item_note_added`

### Tiempos
- `time_entry_started`
- `time_entry_stopped`
- `time_entry_corrected`

### Archivos
- `file_captured`
- `file_metadata_updated`

---

## âŒ Eventos explÃ­citamente prohibidos offline

- `job_completed`
- `job_cancelled`
- `accounting_entry_created`
- `invoice_created`
- `user_created`
- `role_changed`

Estos eventos **solo existen online**.

---

## ğŸ” ValidaciÃ³n en el servidor

Cada evento es validado contra:

- Estado actual de la entidad
- MÃ¡quina de estados
- Permisos del usuario
- Empresa activa
- Consistencia temporal
- DuplicaciÃ³n

Resultado:
- **Aceptado** â†’ aplicado + marcado como synced
- **Rechazado** â†’ marcado como rejected + auditado

---

## âš ï¸ Manejo de conflictos

Ejemplos:
- Evento aplicado sobre estado invÃ¡lido
- Evento duplicado
- Evento fuera de orden

Regla:
- El evento **no se reintenta automÃ¡ticamente**
- Se registra el rechazo
- Se notifica al usuario
- Un rechazo **no bloquea** los eventos posteriores

---

## ğŸ§¾ AuditorÃ­a

Cada evento queda registrado con:

- Payload original
- Timestamps (local + server)
- Resultado de validaciÃ³n
- Motivo de rechazo (si aplica)

Nunca se borra.

---

## ğŸ†” Identidad del dispositivo

- `device_id` se registra y **no se recicla**
- Revocar un dispositivo:
  - invalida eventos futuros
  - **no invalida eventos pasados**

---

## â™»ï¸ ReinstalaciÃ³n de la app

- La cola offline es **volÃ¡til por diseÃ±o**
- No se garantiza persistencia cross-install
- Si el usuario desinstala, **asume la pÃ©rdida** de eventos locales

Esto debe informarse explÃ­citamente en UX.

---

## â±ï¸ Timestamps

- Siempre se guardan:
  - `local_timestamp`
  - `server_timestamp`
- Las reglas se evalÃºan contra:
  - server time (primario)
  - local time (referencial)
- Nunca se â€œcorrigeâ€ el tiempo local

---

## ğŸ§± Persistencia local

- Base local (SQLite / almacenamiento seguro)
- Cola transaccional
- ConfirmaciÃ³n explÃ­cita de sync
- Soporte para reintentos manuales

---

## ğŸ” Seguridad

- Eventos firmados con hash
- Asociados a dispositivo y usuario
- No se aceptan eventos sin autenticaciÃ³n previa vÃ¡lida

---

## ğŸ§­ UX obligatoria

La UI debe mostrar:
- eventos pendientes
- eventos rechazados
- motivo claro
- acciÃ³n sugerida

No mostrar esto = bug funcional.

---

## âœ… ConclusiÃ³n

La cola de eventos offline en SISA:

- No intenta â€œrecrear estadosâ€
- No corrige el pasado
- No asume autoridad

Solo **narra hechos**.

El servidor decide quÃ© hechos son vÃ¡lidos.

---


===== ARCHIVO: offline-scope-boundary.md =====
# Offline Scope Boundary â€” SISA

## ğŸ¯ Objetivo

Definir **lÃ­mites explÃ­citos e inquebrantables** sobre quÃ© **nunca** puede implementarse en modo offline dentro de SISA.

Este documento existe para:
- prevenir degradaciÃ³n arquitectÃ³nica
- evitar â€œexcepciones cÃ³modasâ€
- proteger el core del sistema a largo plazo

---

## ğŸ§  Principio absoluto

> **El offline no define verdad, solo registra intentos.**

Cualquier funcionalidad que contradiga este principio  
**queda automÃ¡ticamente fuera de alcance**.

---

## ğŸš« CategorÃ­as prohibidas para Offline

Las siguientes categorÃ­as **no pueden** operar offline, **bajo ningÃºn escenario**.

---

### 1ï¸âƒ£ Dinero y contabilidad

Incluye (sin excepciÃ³n):

- Asientos contables
- Pagos
- Cobros
- FacturaciÃ³n
- Notas de crÃ©dito / dÃ©bito
- Cierres contables
- Ajustes de balance
- Reversiones financieras

**Motivo**
- Riesgo legal
- Riesgo fiscal
- Dependencias cruzadas
- Impacto irreversible

âŒ Nunca offline  
âŒ Nunca â€œmodo borradorâ€ offline  
âŒ Nunca sincronizaciÃ³n diferida

---

### 2ï¸âƒ£ Estados terminales

Estados finales o irreversibles:

- `completed`
- `cancelled`
- `closed`
- `archived`

**Motivo**
- Disparan efectos colaterales
- Pueden cerrar flujos contables u operativos
- Definen historia final

âœ” Pueden **proponerse** offline  
âŒ Nunca confirmarse offline

---

### 3ï¸âƒ£ Datos maestros estructurales

Incluye:

- Empresas
- Clientes
- Proveedores
- Productos / servicios
- Carpetas raÃ­z
- ConfiguraciÃ³n global
- CatÃ¡logos base

**Motivo**
- Alta dependencia
- Riesgo de duplicaciÃ³n
- Rompen integridad referencial

âŒ No se crean offline  
âŒ No se editan offline  
âŒ No se eliminan offline

---

### 4ï¸âƒ£ Seguridad y permisos

Incluye:

- CreaciÃ³n de usuarios
- Cambios de rol
- AsignaciÃ³n de empresas
- RevocaciÃ³n de accesos
- PolÃ­ticas de seguridad

**Motivo**
- Riesgo de escalamiento de privilegios
- ViolaciÃ³n de modelo de seguridad

âŒ Nunca offline  
âŒ Nunca cache editable

---

### 5ï¸âƒ£ ConfiguraciÃ³n del sistema

Incluye:

- ParÃ¡metros globales
- Reglas de negocio
- MÃ¡quinas de estado
- Flags de comportamiento

**Motivo**
- Cambios sistÃ©micos
- Impacto transversal
- DifÃ­cil rollback

---

## âš ï¸ Zonas grises explÃ­citamente cerradas

Las siguientes ideas **parecen razonables**, pero estÃ¡n **prohibidas**:

- â€œModo borrador offlineâ€ para facturas
- â€œPre-crear clientes offlineâ€
- â€œCerrar trabajos offline y confirmar despuÃ©sâ€
- â€œEditar permisos sin conexiÃ³nâ€
- â€œSincronizar contabilidad al reconectarâ€

Si alguien propone esto:
ğŸ‘‰ la respuesta es **NO**.

---

## âœ… CategorÃ­as permitidas Offline (recordatorio)

El offline **solo** se admite para:

- Registro de acciones operativas
- Checklists
- Tiempos trabajados
- Archivos y evidencias
- Observaciones
- Lectura de datos de referencia

Siempre bajo:
- cola de eventos
- validaciÃ³n server-side
- auditorÃ­a

---

## ğŸ§± Regla de decisiÃ³n rÃ¡pida

Ante cualquier feature nueva, preguntarse:

1. Â¿Afecta dinero?
2. Â¿Define una verdad del sistema?
3. Â¿Cambia permisos o estructura?
4. Â¿Es irreversible?

Si la respuesta es **sÃ­** a cualquiera:
ğŸ‘‰ **No es offline**.

---

## ğŸ” Autoridad final

- Este documento **tiene prioridad** sobre:
  - decisiones de UX
  - pedidos comerciales
  - conveniencias tÃ©cnicas
- Ninguna feature puede violarlo sin **romper SISA**

---

## âœ… ConclusiÃ³n

El offline en SISA:

- es acotado
- es consciente
- es responsable
- es defendible

Este boundary existe para que el sistema **no se desarme con el tiempo**.

---


===== ARCHIVO: offline-strategy.md =====
# Offline Strategy â€” SISA

## ğŸ¯ Objetivo

Definir **cuÃ¡ndo**, **dÃ³nde** y **por quÃ©** SISA aplica el enfoque **offline-first**, evitando inconsistencias, riesgos contables o violaciones de reglas de negocio.

SISA **no es offline-first por defecto**.  
Es **offline-inteligente**.

---

## ğŸ§  Principio rector

> **Si el dato representa un hecho ocurrido â†’ puede ser offline-first**  
> **Si el dato representa una verdad del sistema â†’ es online-only**

Este principio gobierna todas las decisiones offline del sistema.

---

## âœ… Casos donde SÃ aplica Offline-first

### 1. Jobs en ejecuciÃ³n

**Contexto**  
OperaciÃ³n en campo con conectividad inestable o inexistente.

**Acciones permitidas offline**
- VisualizaciÃ³n de Jobs asignados
- Transiciones operativas:
  - `planned â†’ in_progress`
  - `in_progress â†’ paused`
- Registro de observaciones
- AsociaciÃ³n de participantes
- Registro de tramos horarios
- Adjuntar archivos

**Estrategia**
- Cache local estructurada
- Cola de eventos append-only
- SincronizaciÃ³n diferida con validaciÃ³n de estado

---

### 2. Checklists / Consignas operativas

**DescripciÃ³n**
- Ãtems ejecutables
- Pueden realizarse mÃºltiples veces por Job
- Asociados al momento real de ejecuciÃ³n

**Offline**
- EjecuciÃ³n completa offline
- Persistencia local con timestamp real
- SincronizaciÃ³n posterior

---

### 3. Tiempos trabajados

**CaracterÃ­sticas**
- Registro de inicio / fin
- MÃºltiples tramos por Job
- Correcciones permitidas con historial

**Offline**
- Captura local
- ValidaciÃ³n en sincronizaciÃ³n
- Nunca se pisa historial existente

---

### 4. Captura de archivos

**Ejemplos**
- Fotos de equipos
- Videos de fallas
- Evidencias tÃ©cnicas

**Flujo**
1. Guardado local
2. AsociaciÃ³n de metadata
3. Upload diferido
4. VinculaciÃ³n al Job / checklist correspondiente

---

### 5. Datos de referencia (solo lectura)

**Ejemplos**
- Clientes
- Productos / servicios
- Carpetas
- Estados vÃ¡lidos

**RestricciÃ³n**
- Lectura offline permitida
- CreaciÃ³n y ediciÃ³n **solo online**

---

## âŒ Casos donde NO aplica Offline-first

### 1. Contabilidad

**Prohibido offline**
- Asientos contables
- Pagos
- FacturaciÃ³n
- Cierres
- Ajustes

**Motivo**
- Riesgo financiero
- Riesgo legal
- Alta dependencia cruzada

---

### 2. Estados finales de Jobs

Estados:
- `completed`
- `cancelled`

**Regla**
- Nunca se confirman offline
- Pueden proponerse, pero requieren validaciÃ³n online

---

### 3. Usuarios y permisos

**Incluye**
- CreaciÃ³n de usuarios
- AsignaciÃ³n de roles
- VinculaciÃ³n a empresas

**Motivo**
- Riesgo de escalamiento de privilegios
- Seguridad del sistema

---

### 4. Datos maestros estructurales

**Ejemplos**
- Empresas
- Clientes / proveedores
- Productos / servicios
- ConfiguraciÃ³n global
- Estructuras contables

**Regla**
- Siempre online

---

## ğŸ§± PolÃ­tica de sincronizaciÃ³n

- Todos los eventos offline:
  - Son **append-only**
  - Nunca pisan datos existentes
  - Se validan contra el **estado actual**
- Conflictos:
  - Se rechazan eventos invÃ¡lidos
  - Se registran para auditorÃ­a
- El servidor es la **fuente de verdad final**

**Regla explÃ­cita**
- No existe â€œrebobinadoâ€ del estado para acomodar offline.
- Un evento puede ser vÃ¡lido al generarse y **rechazado al sincronizar**.
- Esto es **esperado**, no un error del sistema.

---

## ğŸ” AuditorÃ­a

Cada evento offline sincronizado:
- Tiene timestamp local
- Tiene timestamp de servidor
- Guarda autor, contexto y entidad afectada
- Nunca se elimina

---

## âš ï¸ Advertencias

- Offline-first mal aplicado **rompe sistemas**
- No se admiten â€œexcepciones por comodidadâ€
- Si una acciÃ³n afecta:
  - dinero
  - estructura
  - permisos  
  entonces **no es offline**

---

## âœ… ConclusiÃ³n

SISA aplica offline-first **solo donde agrega valor real**, sin comprometer:

- consistencia
- seguridad
- auditabilidad
- escalabilidad

Offline no es libertad.  
Es **responsabilidad controlada**.

---


===== ARCHIVO: README.md =====
# SISA â€” Sistema Integrado de Servicios Administrativos

SISA es una **plataforma ERP modular**, diseÃ±ada para **empresas reales**, con foco en **trazabilidad total**, **control operativo**, **contabilidad sÃ³lida** y **escalabilidad progresiva**.

No es un MVP de juguete.  
No es un clon liviano de otro sistema.  
Es un **core empresarial serio**, pensado para crecer sin romperse.

---

## ğŸ¯ Objetivo del sistema

Construir un **nÃºcleo administrativo y operativo** que permita:

- Gestionar **empresas, clientes y proveedores**
- Controlar **operaciones (Jobs)** con estados estrictos
- Registrar **consignas, checklists y ejecuciÃ³n real**
- Manejar **tiempos trabajados**, participantes y recursos
- Integrar **contabilidad**, **facturaciÃ³n** y **auditorÃ­a**
- Escalar hacia **automatizaciÃ³n, IA y anÃ¡lisis avanzado**

SISA estÃ¡ pensado como **base estructural**, no como producto descartable.

---

## ğŸ§± Principios no negociables

- âŒ **Nada se borra fÃ­sicamente**
- âœ… Todo es **auditable**
- âœ… Estados con **mÃ¡quinas de estado estrictas**
- âŒ No hay â€œexcepciones mÃ¡gicasâ€
- âœ… El sistema refleja la **realidad operativa**
- âœ… DiseÃ±o orientado a **crecimiento y mantenimiento**

---

## ğŸ§© Arquitectura general

SISA se construye por **capas y mÃ³dulos independientes**:

### Backend
- API REST
- Arquitectura desacoplada
- Validaciones duras
- Control de permisos por rol y empresa
- Registro histÃ³rico automÃ¡tico

### Frontend
- App mÃ³vil + web
- Offline-first (cuando aplica)
- SincronizaciÃ³n controlada
- UI enfocada en operaciÃ³n real, no en estÃ©tica vacÃ­a

### Base de datos
- Modelo relacional estricto
- Historial por entidad
- Estados explÃ­citos
- Relaciones claras y no ambiguas

---

## ğŸ“¦ MÃ³dulos principales

### ğŸ¢ Empresas
- Multi-empresa real
- Usuarios con roles y permisos
- NingÃºn usuario existe sin contexto empresarial

### ğŸ‘¥ Clientes y Proveedores
- Son **referencias a Company**
- No se duplican datos
- Uso de `client_company_id` / `provider_company_id`

### ğŸ›  Jobs (Operaciones)
- NÃºcleo operativo del sistema
- No contiene fechas ni horarios directos
- Se rige por **mÃ¡quina de estados**
- Estados finales inmutables

Estados tÃ­picos:
- planned
- in_progress
- paused
- completed
- cancelled

Transiciones invÃ¡lidas explÃ­citas (ejemplos):
- completed â†’ *
- cancelled â†’ *
- in_progress â†’ planned
- paused â†’ planned

### âœ… Checklists / Consignas
- Ãtems operativos ejecutables
- Asociados al momento real de ejecuciÃ³n
- Permiten mÃºltiples ejecuciones por Job
- Cada ejecuciÃ³n puede tener distintos participantes

### â± Tiempos y Horarios
- Tablas separadas de Jobs
- Registro real de inicio y fin
- MÃºltiples tramos por trabajo
- Correcciones posibles **con historial**

### ğŸ“Š Contabilidad
- Base contable sÃ³lida
- Preparada para:
  - facturaciÃ³n
  - pagos
  - reportes
  - cierres
- DiseÃ±ada como **core independiente**

### ğŸ“ Archivos
- Vinculados a entidades
- Metadata persistente
- Soporte offline
- Historial de cambios

---

## ğŸ” Seguridad y control

- AutenticaciÃ³n obligatoria
- Permisos por rol
- Acceso por empresa
- Registro de acciones crÃ­ticas
- Sin endpoints â€œpÃºblicosâ€ innecesarios

---

## ğŸ§  FilosofÃ­a de diseÃ±o

SISA no intenta â€œhacer todo rÃ¡pidoâ€.  
Intenta **hacer lo correcto primero**.

- Primero estructura
- DespuÃ©s velocidad
- Luego automatizaciÃ³n
- Finalmente inteligencia (IA)

---

## ğŸš€ Estado del proyecto

SISA se encuentra en **desarrollo activo**, con foco en:

- ConsolidaciÃ³n del core
- Reglas duras
- DocumentaciÃ³n exhaustiva
- Base contable profesional

No se prioriza el marketing hasta que el sistema **aguante uso real**.

---

## âš ï¸ Advertencia honesta

Este sistema **no es para improvisados**.  
Si buscÃ¡s algo liviano, rÃ¡pido y descartable, **este no es el proyecto**.

Si buscÃ¡s:
- Control real
- Escalabilidad
- Orden
- Longevidad

Entonces estÃ¡s en el lugar correcto.

---

## ğŸ“„ Licencia

Pendiente de definiciÃ³n.
El core estÃ¡ pensado para uso profesional y comercial.

---

## âœï¸ Autor

Desarrollado por **Mauro Massa**  
Proyecto SISA â€” Core ERP







===== ARCHIVO: sync-conflict-policy.md =====
# Sync Conflict Policy â€” SISA

## ğŸ¯ Objetivo

Definir **cÃ³mo SISA detecta, clasifica y resuelve conflictos** durante la sincronizaciÃ³n de eventos offline, garantizando:

- consistencia
- auditabilidad
- previsibilidad
- ausencia de efectos colaterales silenciosos

En SISA **no existen conflictos â€œautomÃ¡gicosâ€**.

---

## ğŸ§  Principio rector

> **El servidor es la Ãºnica fuente de verdad.**  
> El cliente offline **propone hechos**, el servidor **decide validez**.

---

## ğŸ§© QuÃ© es un conflicto

Un conflicto ocurre cuando un **evento offline**:

- contradice el estado actual del sistema
- viola una regla de negocio
- llega fuera de contexto temporal
- fue generado sin permisos vÃ¡lidos
- ya fue aplicado (duplicado)

---

## ğŸ§± ClasificaciÃ³n de conflictos

### 1ï¸âƒ£ Conflicto de estado

**DescripciÃ³n**  
El evento intenta aplicarse sobre un estado invÃ¡lido.

**Ejemplo**
- Evento: `job_paused`
- Estado actual: `planned`

**ResoluciÃ³n**
- âŒ Evento rechazado
- ğŸ“„ Motivo registrado
- ğŸ”” Usuario notificado

---

### 2ï¸âƒ£ Conflicto de transiciÃ³n prohibida

**DescripciÃ³n**  
La acciÃ³n viola la mÃ¡quina de estados.

**Ejemplo**
- Evento: `job_resumed`
- Estado actual: `completed`

**ResoluciÃ³n**
- âŒ Evento rechazado
- ğŸ“„ AuditorÃ­a completa
- âŒ No se reintenta

---

### 3ï¸âƒ£ Conflicto de permisos

**DescripciÃ³n**
El usuario no tiene permisos vÃ¡lidos al momento de sincronizar.

**Ejemplo**
- Usuario removido de la empresa
- Rol degradado

**ResoluciÃ³n**
- âŒ Evento rechazado
- ğŸ”’ Seguridad prioritaria
- ğŸ“„ Registro de intento

---

### 4ï¸âƒ£ Conflicto temporal

**DescripciÃ³n**
El evento presenta incoherencias de tiempo.

**Ejemplos**
- Fin antes del inicio
- SuperposiciÃ³n imposible de tramos
- Timestamp invÃ¡lido

**ResoluciÃ³n**
- âŒ Evento rechazado
- ğŸ“„ Se conserva el payload original
- ğŸ”” Usuario informado

---

### 5ï¸âƒ£ Conflicto de duplicaciÃ³n

**DescripciÃ³n**
El evento ya fue procesado.

**DetecciÃ³n**
- `event_id`
- `hash`
- `sequence_number`

**ResoluciÃ³n**
- âš ï¸ Evento ignorado
- âœ” Marcado como synced
- ğŸ“„ Sin efectos colaterales

---

### 6ï¸âƒ£ Conflicto estructural

**DescripciÃ³n**
La entidad referenciada ya no existe o cambiÃ³ su contexto.

**Ejemplo**
- Job eliminado virtualmente
- Checklist deshabilitado

**ResoluciÃ³n**
- âŒ Evento rechazado
- ğŸ“„ Registro obligatorio

---

## ğŸ”„ PolÃ­tica de resoluciÃ³n

| Tipo de conflicto | AcciÃ³n |
|------------------|-------|
| Estado invÃ¡lido | Rechazo |
| TransiciÃ³n prohibida | Rechazo |
| Permisos | Rechazo |
| Temporal | Rechazo |
| Duplicado | Ignorar |
| Estructural | Rechazo |

â— **Nunca se corrige un evento automÃ¡ticamente**  
â— **Nunca se reescribe la historia**

---

## âœ… EvaluaciÃ³n independiente

- Cada evento se evalÃºa **de forma independiente**
- Un rechazo **no bloquea** la cola
- No existe rollback en cascada

Ejemplo:
- Evento 1 â†’ rechazado
- Evento 2 â†’ vÃ¡lido  
âœ” Evento 2 se aplica

---

## ğŸ” Reintentos

- âŒ No hay reintentos automÃ¡ticos
- âœ” El usuario puede:
  - revisar el motivo
  - repetir la acciÃ³n manualmente
  - generar un nuevo evento vÃ¡lido

Cada reintento es **un evento nuevo**, no una modificaciÃ³n.

---

## ğŸ§¾ AuditorÃ­a de conflictos

Todo conflicto genera:

- ID del evento
- Tipo de conflicto
- Payload original
- Usuario
- Empresa
- Dispositivo
- Timestamp local y de servidor
- Motivo tÃ©cnico del rechazo

Estos registros **no se eliminan**.

---

## ğŸ”” ComunicaciÃ³n al usuario

El sistema debe:

- Informar claramente el rechazo
- Explicar el motivo en lenguaje operativo
- Evitar mensajes genÃ©ricos

Ejemplo vÃ¡lido:
> â€œEl trabajo ya fue completado por otro usuario antes de sincronizar.â€

Ejemplo invÃ¡lido:
> â€œError de sincronizaciÃ³n.â€

---

## ğŸ” Seguridad

- Un evento rechazado **no degrada** el sistema
- No se bloquea la cola completa
- Cada evento se evalÃºa individualmente
- No hay escalamiento de privilegios offline

---

## ğŸ§  FilosofÃ­a final

SISA **prefiere rechazar un evento vÃ¡lido**  
antes que **aceptar uno incorrecto**.

La integridad del sistema **estÃ¡ por encima de la comodidad del usuario**.

---

## âœ… ConclusiÃ³n

La polÃ­tica de conflictos de SISA garantiza que:

- el offline no corrompe el core
- los errores son visibles
- el sistema es defendible
- la historia nunca se reescribe

Sin esta polÃ­tica, el offline es una mentira peligrosa.

---


===== ARCHIVO: sync-conflicts-schema.md =====
# sync_conflicts â€” Schema Definition (SISA)

## ğŸ¯ Objetivo

Definir la estructura de la tabla `sync_conflicts`, encargada de **registrar de forma inmutable** todos los conflictos detectados durante la sincronizaciÃ³n de eventos offline.

Esta tabla es **parte del sistema de auditorÃ­a** y **no admite borrado ni ediciÃ³n**.

---

## ğŸ§  Principios de diseÃ±o

- Append-only
- AuditorÃ­a completa
- Multi-empresa real
- No depende del estado actual para interpretarse
- ReconstrucciÃ³n histÃ³rica posible sin ambigÃ¼edades

---

## ğŸ—„ Tabla: sync_conflicts

### Campos obligatorios

| Campo | Tipo | DescripciÃ³n |
|-----|-----|------------|
| `id` | UUID | Identificador Ãºnico del registro de conflicto |
| `event_id` | UUID | ID del evento offline que generÃ³ el conflicto |
| `company_id` | UUID | Empresa en la que ocurriÃ³ el conflicto |
| `entity_type` | VARCHAR | Tipo de entidad afectada (job, checklist_item, time_entry, file, etc.) |
| `entity_id` | UUID | ID de la entidad afectada |
| `conflict_type` | VARCHAR | ClasificaciÃ³n del conflicto |
| `action` | VARCHAR | AcciÃ³n intentada (ej: job_paused) |
| `payload` | JSON | Payload original del evento offline |
| `user_id` | UUID | Usuario que generÃ³ el evento |
| `device_id` | VARCHAR | Identificador del dispositivo |
| `local_timestamp` | DATETIME | Timestamp generado en el dispositivo |
| `server_timestamp` | DATETIME | Timestamp del servidor al procesar |
| `rejection_reason` | TEXT | Motivo tÃ©cnico del rechazo |
| `created_at` | DATETIME | Momento de inserciÃ³n del registro |

---

## ğŸ§¾ conflict_type â€” valores esperados

`conflict_type` **no es libre**, debe responder a un set controlado.

Valores recomendados:

- `invalid_state`
- `invalid_transition`
- `permission_denied`
- `temporal_inconsistency`
- `duplicate_event`
- `structural_conflict`
- `unknown_entity`
- `validation_error`

> â— No se usan enums rÃ­gidos para permitir evoluciÃ³n controlada.

---

## ğŸ”— Relaciones conceptuales

- `event_id` â†’ offline_events.event_id
- `company_id` â†’ companies.id
- `user_id` â†’ users.id
- `entity_id` â†’ entidad correspondiente segÃºn `entity_type`

âš ï¸ **No se usan foreign keys obligatorias**  
Motivo: la entidad puede haber sido eliminada virtualmente.

---

## ğŸ§± Reglas duras

- NingÃºn registro se elimina
- NingÃºn registro se modifica
- No se reutiliza `event_id`
- Un mismo evento genera **mÃ¡ximo un conflicto**
- La ausencia de `company_id` invalida el registro

---

## ğŸ” RetenciÃ³n y acceso

- RetenciÃ³n: **indefinida**
- Acceso:
  - solo admins
  - solo lectura
  - nunca editable
- No visible para usuarios finales estÃ¡ndar

---

## ğŸ” Casos de uso cubiertos

- AuditorÃ­a legal
- Debugging tÃ©cnico
- Soporte al usuario
- AnÃ¡lisis de fallas offline
- MÃ©tricas de calidad de sincronizaciÃ³n

---

## âš ï¸ Errores que este schema evita

- Conflictos sin contexto empresarial
- Logs ambiguos
- Reescritura de historia
- Debugging basado en suposiciones
- â€œFuncionÃ³ en mi telÃ©fonoâ€

---

## âœ… ConclusiÃ³n

La tabla `sync_conflicts` es:

- un registro de verdad
- una defensa tÃ©cnica
- una herramienta legal
- un seguro contra corrupciÃ³n silenciosa

Si esta tabla existe y se respeta, el offline **no miente**.

---


===== ARCHIVO: xxx_resultado_unificado.txt =====


===== ARCHIVO: ğŸ“˜ CHECKLIST â€” IMPLEMENTACIÃ“N MÃNIMA VIABLE (MVP) POR MÃ“DULO.md =====
# **ğŸ“˜ CHECKLIST â€” IMPLEMENTACIÃ“N MÃNIMA VIABLE (MVP) POR MÃ“DULO**

**Contrato tÃ©cnico â€” Control de alcance â€” Sin interpretaciÃ³n**

---

## **ğŸ§± 1ï¸âƒ£ CORE PLATFORM â€” MVP**

Sin esto, el sistema **NO existe**.

### **ğŸ” Identidad & Seguridad**

* Users con estados (`pending`, `active`, `locked`, `disabled`, `deleted`)  
* Hash seguro de contraseÃ±a  
* VerificaciÃ³n de email  
* RecuperaciÃ³n de contraseÃ±a  
* Bloqueo automÃ¡tico por intentos fallidos  
* Bloqueo manual administrativo  
* User Security Events (login\_success / failed / lock / unlock)

### **ğŸ”‘ Sesiones**

* Refresh tokens Ãºnicos  
* RevocaciÃ³n inmediata de sesiÃ³n  
* ExpiraciÃ³n configurable  
* Logout idempotente  
* Cambio de empresa por sesiÃ³n

### **ğŸ¢ Multiempresa**

* Companies con lifecycle completo  
* Company Memberships  
* Roles gruesos (owner/admin/member/viewer)  
* ProtecciÃ³n de Ãºltimo owner  
* Invitaciones por email con token

### **ğŸ“ Archivos**

* Files (repositorio universal)  
* File Links (asociaciÃ³n flexible)  
* Borrado lÃ³gico  
* AuditorÃ­a de upload/link/unlink

### **ğŸ§¾ AuditorÃ­a**

* Audit log append-only  
* AuditorÃ­a de cambios de estado  
* AuditorÃ­a de seguridad  
* AuditorÃ­a de denegaciones crÃ­ticas

### **âš™ï¸ InstalaciÃ³n**

* Endpoint de instalaciÃ³n inicial  
* CreaciÃ³n de superadmin  
* Bloqueo permanente post-instalaciÃ³n  
* Evento `install_completed`

---

## **ğŸ” 2ï¸âƒ£ PERMISOS FINOS (ACL / RBAC) â€” MVP**

Controla el acceso **sin tocar negocio**.

### **Permisos**

* Registro de permisos atÃ³micos  
* Identificador Ãºnico por permiso  
* Permisos organizados por dominio

### **Roles Finos**

* Roles base definidos (erp\_operator, erp\_manager, etc.)  
* AsignaciÃ³n por empresa  
* Compatibilidad rol grueso â†” rol fino  
* ValidaciÃ³n hard-deny por rol grueso

### **Overrides**

* Overrides explÃ­citos por usuario  
* Precedencia clara (override \> rol fino)

### **EvaluaciÃ³n**

* Evaluador determinÃ­stico de permisos  
* Resultado binario (ALLOW / DENY)  
* AuditorÃ­a de denegaciones crÃ­ticas

---

## **ğŸ“˜ 3ï¸âƒ£ ERP OPERATIVO â€” MVP**

Registra hechos reales.  
NO interpreta contabilidad.

### **Jobs**

* Jobs con lifecycle completo  
* Sin fechas reales en la tabla principal  
* Job Time Entries (inicio/fin)  
* Job Checklist Items  
* Evidencia y responsables  
* Estados terminales respetados  
* AuditorÃ­a de transiciones

### **Ventas / Compras**

* Sales (draft/confirmed/cancelled)  
* Purchases (simÃ©trico)  
* Validaciones cruzadas

### **Presupuestos**

* Quotes con estados  
* AceptaciÃ³n / rechazo auditados

### **FacturaciÃ³n**

* Invoices (draft/issued/voided)  
* Bloqueo si hay receipts activos

### **Cobros / Pagos**

* Receipts (pending/completed/reversed)  
* Payments (simÃ©trico)  
* AuditorÃ­a de ejecuciÃ³n y reversiÃ³n

### **Eventos**

* Eventos operativos inmutables  
* Idempotencia garantizada  
* Eventos rechazados auditados

---

## **ğŸ§® 4ï¸âƒ£ CONTABILIDAD (ACCCORE) â€” MVP**

Nunca se implementa antes del ERP.

### **Entrada**

* Consumo de eventos ERP  
* ValidaciÃ³n de integridad temporal  
* Reprocesamiento seguro

### **NÃºcleo**

* Plan de cuentas  
* Asientos contables  
* Devengamientos bÃ¡sicos  
* Mayor

### **Cierres**

* Cierre de perÃ­odo  
* Bloqueo post-cierre  
* Reapertura solo por owner

### **AuditorÃ­a**

* AuditorÃ­a contable  
* Trazabilidad evento â†’ asiento  
* No modificaciÃ³n de asientos

---

## **ğŸ§ª 5ï¸âƒ£ VALIDACIONES GLOBALES â€” MVP**

* No borrado fÃ­sico en ningÃºn mÃ³dulo  
* Regla 4equim aplicada en todas las entidades  
* Estados terminales no reversibles  
* Fechas reales inmutables  
* Correcciones solo por eventos  
* Hard-deny antes de ACL  
* Owner bypass documentado

---

## **ğŸš¨ 6ï¸âƒ£ CRITERIOS DE â€œLISTO PARA PRODUCCIÃ“Nâ€**

Un mÃ³dulo estÃ¡ **listo** solo si:

* Todos los Ã­tems del checklist estÃ¡n completos  
* No hay TODOs  
* No hay permisos implÃ­citos  
* No hay lÃ³gica cruzada entre mÃ³dulos  
* AuditorÃ­a completa  
* DocumentaciÃ³n actualizada



===== ARCHIVO: ğŸ“˜ FASE 1 - CORE PLATFORM.md =====


# **ğŸ“˜ CORE PLATFORM** 

**Modelo \+ Reglas \+ Entidades \+ Ciclos de vida \+ Seguridad \+ AuditorÃ­a \+ InstalaciÃ³n inicial**  
**Sin ambigÃ¼edades â€¢ Sin cÃ³digo â€¢ Sin implementaciÃ³n â€¢ Solo contrato de arquitectura**

---

# **ğŸ§± 0\) PRINCIPIOS INMUTABLES**

## **0.1 â€” NO EXISTE EL BORRADO FÃSICO**

Todo dato crÃ­tico **nunca se elimina fÃ­sicamente**, solo cambia de estado:  
`active`, `inactive`, `archived`, `deleted`.

Toda tabla core debe tener:

* `status`  
* `deleted_at`  
* `created_at`  
* `updated_at`

## **0.2 â€” REGLA PADREâ€“HIJO (4EQUIM)**

Un registro **NO puede eliminarse** si tiene:

* hijos activos  
* contenido asociado  
* dependencias lÃ³gicas activas

Opciones permitidas:

1. eliminar primero los hijos  
2. operaciÃ³n explÃ­cita â€œeliminar todo el contenidoâ€  
3. rechazar la operaciÃ³n

## **0.3 â€” AUDITORÃA UNIVERSAL**

Todo cambio relevante â†’ audit\_log  
Nunca se modifica  
Nunca se elimina  
Append-only

## **0.4 â€” INSTALACIÃ“N INICIAL**

Antes de estar instalado:

* `APP_INSTALLED = false`  
* Primer usuario creado â†’ `superadmin`  
* Luego el endpoint queda bloqueado permanentemente

## **0.5 â€” MULTIEMPRESA REAL**

Todo dato operativo requiere `company_id` (cuando corresponde).  
Una sesiÃ³n siempre estÃ¡ asociada a un contexto de empresa activa.

---

# **ğŸ—‚ ENTIDADES UNIFICADAS (POST-FUSIÃ“N)**

**Estas son las tablas DEFINITIVAS**.  
Si no aparece acÃ¡, NO forma parte del Core.

Voy a fusionar donde corresponde para mayor coherencia, simplicidad y potencia.

---

# **1ï¸âƒ£ USERS (usuarios del sistema)**

## **PropÃ³sito**

Identidad digital global. Sin empresa asociada. Nunca se borra fÃ­sicamente.

## **Estados**

`pending`, `active`, `locked`, `disabled`, `deleted`

## **Tabla final (completa)**

Incluye **los campos mÃ¡s completos y seguros** de todas las versiones previas.

users (  
  id CHAR(36) PRIMARY KEY,  
  email VARCHAR(255) NOT NULL UNIQUE,  
  password\_hash VARCHAR(255) NOT NULL,

  status ENUM('pending','active','locked','disabled','deleted') NOT NULL DEFAULT 'pending',  
  locked\_until DATETIME(6) NULL,  
  email\_verified\_at DATETIME(6) NULL,  
  deleted\_at DATETIME(6) NULL,

  created\_at DATETIME(6) NOT NULL,  
  updated\_at DATETIME(6) NOT NULL  
)

---

# **2ï¸âƒ£ USER\_SECURITY\_EVENTS (FUSIÃ“N: login\_attempts \+ seguridad de acceso)**

ğŸ’¡ En vez de dos tablas separadas, lo fusionamos en una estructura de **eventos de seguridad universal**, mÃ¡s poderosa, mÃ¡s auditable y mÃ¡s escalable.

Esto permite registrar:

* login attempts  
* bloqueos automÃ¡ticos  
* desbloqueos  
* resets  
* captchas  
* eventos de credenciales

## **Tabla final**

user\_security\_events (  
  id CHAR(36) PRIMARY KEY,  
  user\_id CHAR(36) NULL,  
  email VARCHAR(255) NOT NULL,  
  ip\_address VARCHAR(100),  
  user\_agent VARCHAR(500),

  event\_type ENUM(  
    'login\_success',  
    'login\_failed',  
    'password\_reset\_requested',  
    'password\_reset\_used',  
    'email\_verification\_sent',  
    'email\_verified',  
    'auto\_lock',  
    'auto\_unlock',  
    'manual\_lock',  
    'manual\_unlock'  
  ) NOT NULL,

  metadata JSON,  
  created\_at DATETIME(6) NOT NULL,

  INDEX (email),  
  INDEX (user\_id),  
  INDEX (event\_type),  
  INDEX (created\_at)  
)

## **Beneficios**

* sustituye login\_attempts  
* registra todos los eventos de seguridad  
* anÃ¡lisis avanzado de ataques  
* lista para machine learning / anomaly detection

---

# **3ï¸âƒ£ USER\_ROLES (roles globales)**

user\_roles (  
  id CHAR(36) PRIMARY KEY,  
  user\_id CHAR(36) NOT NULL,  
  role ENUM('superadmin','system') NOT NULL,  
  status ENUM('active','deleted') NOT NULL DEFAULT 'active',  
  deleted\_at DATETIME(6),  
  created\_at DATETIME(6),  
  updated\_at DATETIME(6)  
)

---

# **4ï¸âƒ£ USER\_SESSIONS (sesiones del usuario)**

## **Mejorada (fusiÃ³n de variantes)**

Incluye usuario, empresa activa y seguridad adicional.

user\_sessions (  
  id CHAR(36) PRIMARY KEY,  
  user\_id CHAR(36) NOT NULL,  
  active\_company\_id CHAR(36) NULL,

  refresh\_token VARCHAR(255) NOT NULL UNIQUE,  
  ip\_address VARCHAR(100),  
  user\_agent VARCHAR(500),

  expires\_at DATETIME(6) NOT NULL,  
  revoked\_at DATETIME(6) NULL,  
  created\_at DATETIME(6) NOT NULL,  
  updated\_at DATETIME(6) NOT NULL  
)

---

# **5ï¸âƒ£ COMPANIES (empresas / tenants)**

Combinando todas las versiones:

companies (  
  id CHAR(36) PRIMARY KEY,  
  legal\_name VARCHAR(255) NOT NULL,  
  trade\_name VARCHAR(255),  
  tax\_id VARCHAR(50),

  status ENUM('active','inactive','archived','deleted') NOT NULL DEFAULT 'active',  
  deleted\_at DATETIME(6),

  created\_at DATETIME(6) NOT NULL,  
  updated\_at DATETIME(6) NOT NULL  
)

Reglas duras:

* no se puede eliminar si tiene owners  
* no se puede eliminar si tiene datos activos  
* no puede quedar sin owner

---

# **6ï¸âƒ£ COMPANY\_INVITATIONS (invitaciones, versiÃ³n final)**

company\_invitations (  
  id CHAR(36) PRIMARY KEY,  
  company\_id CHAR(36) NOT NULL,  
  email VARCHAR(255) NOT NULL,  
  role ENUM('owner','admin','member','viewer') NOT NULL,  
  token CHAR(36) NOT NULL,

  status ENUM('pending','accepted','rejected','expired','revoked') NOT NULL,  
  expires\_at DATETIME(6),  
  accepted\_at DATETIME(6),

  created\_at DATETIME(6) NOT NULL,  
  updated\_at DATETIME(6) NOT NULL  
)

---

# **7ï¸âƒ£ COMPANY\_MEMBERSHIPS (participaciÃ³n)**

company\_memberships (  
  id CHAR(36) PRIMARY KEY,  
  company\_id CHAR(36) NOT NULL,  
  user\_id CHAR(36) NOT NULL,  
  status ENUM('active','invited','revoked','left','deleted') NOT NULL,  
  deleted\_at DATETIME(6),

  created\_at DATETIME(6),  
  updated\_at DATETIME(6)  
)

---

# **8ï¸âƒ£ MEMBERSHIP\_ROLES (roles dentro de empresa)**

membership\_roles (  
  id CHAR(36) PRIMARY KEY,  
  membership\_id CHAR(36) NOT NULL,  
  role ENUM('owner','admin','member','viewer') NOT NULL,  
  status ENUM('active','deleted') NOT NULL DEFAULT 'active',  
  deleted\_at DATETIME(6),

  created\_at DATETIME(6),  
  updated\_at DATETIME(6)  
)

---

# **9ï¸âƒ£ COMPANY\_SETTINGS (config por empresa)**

company\_settings (  
  id CHAR(36) PRIMARY KEY,  
  company\_id CHAR(36) NOT NULL,  
  setting\_key VARCHAR(100) NOT NULL,  
  setting\_value TEXT,  
  status ENUM('active','deleted') NOT NULL DEFAULT 'active',  
  deleted\_at DATETIME(6),

  created\_at DATETIME(6),  
  updated\_at DATETIME(6)  
)

---

# **ğŸ”Ÿ FILES \+ FILE\_LINKS (repositorio universal)**

## **FUSIÃ“N:**

La estructura actual ya es correcta y no se fusiona con otras tablas.

### **files**

files (  
  id CHAR(36) PRIMARY KEY,  
  company\_id CHAR(36) NOT NULL,  
  user\_id CHAR(36) NOT NULL,  
  mime\_type VARCHAR(200),  
  size INT,  
  path VARCHAR(500),

  status ENUM('active','archived','deleted') NOT NULL DEFAULT 'active',  
  deleted\_at DATETIME(6),

  created\_at DATETIME(6)  
)

### **file\_links**

file\_links (  
  id CHAR(36) PRIMARY KEY,  
  file\_id CHAR(36) NOT NULL,  
  entity\_type VARCHAR(100) NOT NULL,  
  entity\_id CHAR(36) NOT NULL,  
  status ENUM('active','deleted') NOT NULL DEFAULT 'active',  
  deleted\_at DATETIME(6),

  created\_at DATETIME(6)  
)

---

# **1ï¸âƒ£1ï¸âƒ£ AUDIT\_LOG (auditorÃ­a universal)**

VersiÃ³n mejorada final:

audit\_log (  
  id CHAR(36) PRIMARY KEY,  
  company\_id CHAR(36) NULL,  
  user\_id CHAR(36) NULL,  
  entity\_type VARCHAR(100) NOT NULL,  
  entity\_id CHAR(36) NOT NULL,

  action ENUM('create','update','delete','archive','restore','security') NOT NULL,  
  snapshot\_before JSON,  
  snapshot\_after JSON,  
  metadata JSON,

  created\_at DATETIME(6) NOT NULL  
)

---

# **1ï¸âƒ£2ï¸âƒ£ USER\_LEGAL\_ACCEPTANCES**

(Normalizado y completo)

user\_legal\_acceptances (  
  id CHAR(36) PRIMARY KEY,  
  user\_id CHAR(36) NOT NULL,  
  document\_type ENUM('tos','privacy','cookies') NOT NULL,  
  document\_version VARCHAR(50) NOT NULL,  
  accepted\_at DATETIME(6) NOT NULL,

  created\_at DATETIME(6)  
)

---

Perfecto. AcÃ¡ tenÃ©s el **DOCUMENTO DE SCOPE OFICIAL**.  
Esto es **contrato de alcance**, corto, explÃ­cito y sin interpretaciones.  
---

## **Documento de Scope Oficial (Congelado)**

---

## **ğŸ¯ PropÃ³sito del documento**

Este documento define **quÃ© incluye y quÃ© NO incluye** la **FASE 1 â€“ CORE PLATFORM**.

Su funciÃ³n es:

* evitar inflaciÃ³n de alcance  
* eliminar ambigÃ¼edades  
* servir como **lÃ­mite contractual**  
* permitir avanzar rÃ¡pido a fases posteriores sin rehacer nada

Si algo **no estÃ¡ explÃ­citamente incluido**, **no pertenece a la Fase 1**.

---

## **ğŸŸ¢ ALCANCE INCLUIDO â€” FASE 1**

La Fase 1 cubre **exclusivamente el nÃºcleo estructural del sistema**.

### **1ï¸âƒ£ Identidad y acceso**

* Usuarios (users)  
* Estados de usuario  
* Bloqueos automÃ¡ticos y manuales  
* VerificaciÃ³n de email  
* RecuperaciÃ³n de contraseÃ±a  
* AceptaciÃ³n de tÃ©rminos legales  
* Sesiones con refresh tokens  
* Eventos de seguridad (login, locks, resets)

### **2ï¸âƒ£ Seguridad**

* Registro de intentos de login  
* DetecciÃ³n de abuso  
* Bloqueos temporales  
* AuditorÃ­a de eventos de seguridad  
* No revelaciÃ³n de existencia de usuarios

### **3ï¸âƒ£ InstalaciÃ³n inicial (bootstrap)**

* Sistema inicia sin usuarios  
* Primer usuario â†’ `superadmin`  
* Bloqueo permanente del modo instalaciÃ³n  
* Sistema idempotente

### **4ï¸âƒ£ Multiempresa (tenancy)**

* Empresas (companies)  
* RelaciÃ³n usuarioâ€“empresa (memberships)  
* Roles por empresa (owner, admin, member, viewer)  
* ProtecciÃ³n de ownership (no dejar empresa sin owner)  
* Invitaciones a empresas por email  
* Cambio de contexto de empresa por sesiÃ³n

### **5ï¸âƒ£ ConfiguraciÃ³n bÃ¡sica**

* ConfiguraciÃ³n por empresa (company\_settings)  
* Preferencias mÃ­nimas de usuario (cuando aplique)

### **6ï¸âƒ£ Archivos**

* Repositorio universal de archivos  
* AsociaciÃ³n flexible de archivos a entidades  
* ProhibiciÃ³n de borrado fÃ­sico automÃ¡tico

### **7ï¸âƒ£ AuditorÃ­a**

* AuditorÃ­a universal de cambios  
* AuditorÃ­a de seguridad separada  
* Registros append-only  
* No modificables  
* No eliminables

### **8ï¸âƒ£ Reglas transversales**

* No borrado fÃ­sico  
* Borrado lÃ³gico con `status` y `deleted_at`  
* Regla padreâ€“hijo tipo 4equim  
* UUID globales  
* Preparado para integraciones futuras (sin implementarlas)

---

## **ğŸ”´ ALCANCE EXCLUIDO â€” FASE 1**

**Todo lo siguiente queda EXPLÃCITAMENTE fuera de la Fase 1**  
y serÃ¡ tratado en fases posteriores.

### **âŒ Negocio / ERP**

* Clientes  
* Proveedores  
* Productos / servicios  
* Ventas  
* Compras  
* Stock  
* Ã“rdenes de trabajo  
* Precios  
* FacturaciÃ³n

### **âŒ Contabilidad (ACCCORE)**

* Asientos contables  
* Plan de cuentas  
* Impuestos  
* Balances  
* Cierres contables  
* Reportes financieros

### **âŒ Permisos finos**

* Permisos por mÃ³dulo  
* Permisos por acciÃ³n  
* ACL detallado  
* Feature flags por rol

### **âŒ AutomatizaciÃ³n y jobs**

* Tareas programadas  
* Workers  
* Colas  
* Procesos automÃ¡ticos

### **âŒ Integraciones**

* API pÃºblica  
* Webhooks  
* Integraciones externas  
* SincronizaciÃ³n con terceros

### **âŒ UI / UX**

* DiseÃ±o visual  
* Frontend  
* Mobile UI  
* Experiencia de usuario

### **âŒ Reporting**

* Dashboards  
* MÃ©tricas de negocio  
* KPIs

---

## **ğŸ§± Regla de oro del Scope**

**FASE 1 \= infraestructura, identidad, seguridad y tenant.**  
**FASE 1 â‰  negocio.**

Cualquier funcionalidad que:

* genere dinero  
* represente operaciones  
* impacte contabilidad  
* dependa de reglas comerciales

ğŸ‘‰ **NO pertenece a Fase 1\.**

---

## **ğŸ”’ Estado del Scope**

* **Estado:** CONGELADO  
* **Modificable:** âŒ No  
* **Cambio de alcance:** solo mediante apertura formal de nueva fase

---

## **âœ… ConclusiÃ³n**

Este documento:

* cierra definitivamente el alcance de la Fase 1  
* protege al sistema de sobreingenierÃ­a  
* habilita avanzar rÃ¡pido a Fase 2 sin deuda  
* sirve como contrato tÃ©cnico y de producto

---

## **EVENTOS AUDITABLES**

### **Objetivo**

Dejar **explÃ­cito** quÃ© acciones **SIEMPRE** generan auditorÃ­a.  
Nada queda implÃ­cito. Nada â€œa criterioâ€.

---

## **ğŸ§¾ EVENTOS QUE DEBEN AUDITARSE (OBLIGATORIOS)**

### **Usuarios**

* create user  
* update user  
* change status (pending/active/locked/disabled/deleted)  
* manual lock / unlock  
* email verified  
* password reset (used)

### **Seguridad**

* login\_success  
* login\_failed  
* auto\_lock  
* auto\_unlock  
* session revoked  
* install completed

### **Empresas**

* create company  
* update company  
* change company status  
* archive company  
* delete (lÃ³gico) company

### **MembresÃ­as**

* invite user  
* accept invitation  
* reject / revoke invitation  
* add membership  
* remove membership (logical)  
* change membership role  
* last owner protection triggered (evento explÃ­cito)

### **ConfiguraciÃ³n**

* create setting  
* update setting  
* delete (logical) setting

### **Archivos**

* upload file  
* link file  
* unlink file  
* archive file  
* delete (logical) file

### **Legal**

* accept TOS / privacy  
* change legal version required

---

## **ğŸ“Œ REGLAS DURAS**

* Todo evento auditado:  
  * **quiÃ©n** (user\_id o system)  
  * **cuÃ¡ndo**  
  * **quÃ© entidad**  
  * **antes / despuÃ©s**  
* AuditorÃ­a:  
  * append-only  
  * no editable  
  * no eliminable  
* Eventos de seguridad **tambiÃ©n** se reflejan en `audit_log` (tipo `security`).

---

## **FLUJO DE INSTALACIÃ“N INICIAL**

### **Objetivo**

Garantizar **arranque desde cero** sin riesgo de takeover.

---

1. **Estado inicial del sistema**  
   * Sistema arranca como **NO INSTALADO**.  
   * No existe ningÃºn usuario vÃ¡lido.  
2. **Endpoint de instalaciÃ³n**  
   * Solo disponible mientras `APP_INSTALLED = false`.  
   * Permite crear **UN SOLO usuario inicial**.  
3. **Primer usuario**  
   * Se convierte automÃ¡ticamente en:  
     * `superadmin`  
     * `owner` de la empresa inicial (si se crea)  
   * Email **debe verificarse**.  
4. **Empresa inicial**  
   * Opcional.  
   * Si se crea, queda asociada al usuario inicial como `owner`.  
5. **Cierre del modo instalaciÃ³n**  
   * Al finalizar:  
     * `APP_INSTALLED = true`  
     * Endpoint de instalaciÃ³n queda **bloqueado permanentemente**.  
   * Evento auditado: `install_completed`.  
6. **Post-instalaciÃ³n**  
   * Cualquier nuevo usuario:  
     * solo por invitaciÃ³n  
     * o por flujo controlado normal

---

## **FLUJO DE LOGIN (AUTENTICACIÃ“N)**

### **Objetivo**

Permitir acceso seguro al sistema **sin revelar informaciÃ³n sensible**, con control de abuso y trazabilidad total.

---

### **ğŸ“Œ Precondiciones**

* Sistema instalado (`APP_INSTALLED = true`)  
* Usuario existente o no (el flujo **no debe revelar** cuÃ¡l de los dos casos aplica)

---

### **ğŸ” Flujo secuencial**

1. **RecepciÃ³n de credenciales**  
   * Se recibe `email + password`  
   * Respuesta genÃ©rica ante error (siempre igual)  
2. **Registro del intento**  
   * Se registra **siempre** un evento de seguridad:  
     * `login_failed` o `login_success`  
   * Se guarda:  
     * email  
     * ip  
     * user\_agent  
     * timestamp  
3. **Validaciones de estado**  
   * Si `status = deleted | disabled` â†’ rechazo silencioso  
   * Si `status = locked`:  
     * si `locked_until` venciÃ³ â†’ desbloqueo automÃ¡tico \+ evento  
     * si no â†’ rechazo  
4. **Chequeo de credenciales**  
   * ComparaciÃ³n segura del hash  
   * Sin early-exit (timing attack safe)  
5. **PolÃ­tica de bloqueo automÃ¡tico**  
   * N intentos fallidos en ventana T â†’ `locked`  
   * Se setea `locked_until`  
   * Evento: `auto_lock`  
6. **Login exitoso**  
   * Se crea sesiÃ³n:  
     * refresh token Ãºnico  
     * expiraciÃ³n  
   * Se asigna empresa activa:  
     * Ãºltima usada  
     * o primera disponible  
   * Evento: `login_success`  
7. **Respuesta**  
   * Tokens \+ metadata mÃ­nima  
   * Nunca:  
     * estados internos  
     * razones de bloqueo  
     * confirmaciÃ³n de existencia de usuario

---

### **ğŸ”’ Reglas duras**

* El sistema **no dice**:  
  * â€œusuario no existeâ€  
  * â€œpassword incorrectoâ€  
  * â€œusuario bloqueadoâ€  
* Todas las respuestas de error son equivalentes.  
* Todos los eventos quedan auditados.  
* Login **nunca** modifica datos de negocio.

---

### **âœ” Resultado**

* Login seguro  
* Sin filtraciones  
* Preparado para rate-limit y MFA futuro  
* Auditable y escalable

---

## **âœ… PASO 9 â€” LOGOUT & REVOCACIÃ“N DE SESIONES**

### **Objetivo**

Garantizar que **una sesiÃ³n pueda invalidarse inmediatamente** sin afectar otras ni dejar residuos de seguridad.

---

### **ğŸ” Flujo de logout (usuario)**

1. **Solicitud de logout**  
   * Se recibe identificador de sesiÃ³n / refresh token.  
   * No se revela estado previo.  
2. **RevocaciÃ³n**  
   * La sesiÃ³n se marca como **revocada**.  
   * Se invalida el refresh token.  
3. **AuditorÃ­a**  
   * Evento de seguridad registrado:  
     * `session_revoked`  
   * Actor \= usuario.  
4. **Respuesta**  
   * Siempre exitosa (idempotente).

---

### **ğŸ”’ RevocaciÃ³n forzada (sistema)**

Se revocan **todas las sesiones activas** del usuario cuando:

* usuario pasa a `locked`  
* usuario pasa a `disabled`  
* usuario pasa a `deleted`  
* cambio de contraseÃ±a  
* reset de contraseÃ±a usado

Eventos auditados correspondientes.

---

### **ğŸ§± Reglas duras**

* Logout **no elimina** la sesiÃ³n, la invalida.  
* Tokens revocados **no pueden reutilizarse**.  
* Revocar una sesiÃ³n **no impacta** otras (salvo revocaciÃ³n forzada).  
* Repetir logout **no genera error**.

---

### **âœ” Resultado**

* Cierre de sesiÃ³n inmediato  
* Control total del acceso  
* Sin efectos colaterales  
* AuditorÃ­a completa

---

---

## **âœ… PASO 10 â€” RECUPERACIÃ“N DE CONTRASEÃ‘A**

### **Objetivo**

Permitir restablecer contraseÃ±a **sin filtrar informaciÃ³n**, con control total y trazabilidad.

---

### **ğŸ” Flujo end-to-end**

1. **Solicitud de reset**  
   * Se recibe email.  
   * Respuesta **siempre genÃ©rica** (exista o no el usuario).  
   * Evento de seguridad registrado:  
     * `password_reset_requested`.  
2. **GeneraciÃ³n de token**  
   * Token:  
     * Ãºnico  
     * de un solo uso  
     * con vencimiento corto.  
   * Asociado al usuario si existe.  
   * Nunca se expone el user\_id.  
3. **EnvÃ­o**  
   * Se envÃ­a link con token.  
   * Reenviable, invalida tokens anteriores activos.  
4. **Uso del token**  
   * Se valida:  
     * no expirado  
     * no usado  
   * Se establece nueva contraseÃ±a.  
   * Se invalidan **todas las sesiones activas**.  
   * Evento: `password_reset_used`.  
5. **Cierre**  
   * Token marcado como usado.  
   * Usuario queda en estado `active` (si no estaba `disabled/deleted`).

---

### **ğŸ”’ Reglas duras**

* Nunca se informa si el email existe.  
* Tokens:  
  * no reutilizables  
  * no extensibles  
* Reset **no desbloquea** usuarios `disabled` o `deleted`.  
* Todo el flujo queda auditado.

---

### **âœ” Resultado**

* RecuperaciÃ³n segura  
* Sin filtraciones  
* Sin sesiones zombie  
* Lista para producciÃ³n real

---

---

## **âœ… PASO 11 â€” VERIFICACIÃ“N DE EMAIL**

### **Objetivo**

Confirmar la **identidad del email** antes de habilitar acceso operativo.

---

### **ğŸ” Flujo end-to-end**

1. **GeneraciÃ³n del token**  
   * Token:  
     * Ãºnico  
     * de un solo uso  
     * con vencimiento.  
   * Asociado al usuario en estado `pending`.  
2. **EnvÃ­o**  
   * Se envÃ­a email con link de verificaciÃ³n.  
   * ReenvÃ­o permitido.  
   * Cada reenvÃ­o invalida tokens previos activos.  
   * Evento: `email_verification_sent`.  
3. **Uso del token**  
   * ValidaciÃ³n:  
     * existe  
     * no expirado  
     * no usado  
   * Se marca:  
     * `email_verified_at`  
     * `status = active`  
   * Evento: `email_verified`.  
4. **Respuesta**  
   * Ã‰xito genÃ©rico.  
   * Nunca revela estado interno previo.

---

### **ğŸ”’ Reglas duras**

* Un usuario **no puede operar** sin email verificado.  
* Verificar email **no crea sesiÃ³n automÃ¡ticamente**.  
* Tokens:  
  * no reutilizables  
  * no prorrogables.  
* Usuarios `disabled` o `deleted` **no pueden verificarse**.  
* Todo evento queda auditado.

---

### **âœ” Resultado**

* Identidad validada  
* Menos spam / cuentas basura  
* Base legal y de seguridad sÃ³lida

---

---

## **âœ… PASO 12 â€” ACEPTACIÃ“N LEGAL OBLIGATORIA**

### **Objetivo**

Garantizar **cumplimiento legal** antes de cualquier uso operativo del sistema.

---

### **ğŸ” Flujo end-to-end**

1. **DefiniciÃ³n de documentos activos**  
   * Tipos: `tos`, `privacy`, `cookies`  
   * Cada uno con **versiÃ³n vigente**.  
2. **Chequeo previo**  
   * En login / primera operaciÃ³n:  
     * si falta aceptaciÃ³n de **algÃºn documento vigente** â†’ acceso **bloqueado** a funciones operativas.  
3. **PresentaciÃ³n**  
   * Se muestra documento \+ versiÃ³n.  
   * AceptaciÃ³n **explÃ­cita** (no implÃ­cita).  
4. **Registro**  
   * Se guarda:  
     * user\_id  
     * document\_type  
     * document\_version  
     * timestamp  
   * Evento auditado: `legal_accepted`.  
5. **Cambio de versiÃ³n**  
   * Nueva versiÃ³n invalida aceptaciones previas.  
   * Usuario debe **reaceptar**.

---

### **ğŸ”’ Reglas duras**

* Sin aceptaciÃ³n â†’ **no hay operaciÃ³n**.  
* AceptaciÃ³n:  
  * es **inmutable**  
  * no se edita  
  * no se elimina.  
* Usuarios `disabled` o `deleted` **no aceptan**.  
* Aceptar legal **no crea sesiÃ³n** ni modifica seguridad.

---

### **âœ” Resultado**

* Cobertura legal sÃ³lida  
* Prueba histÃ³rica de aceptaciÃ³n  
* Preparado para monetizaciÃ³n y compliance

---

---

## **âœ… PASO 13 â€” FLUJOS MULTIEMPRESA (USO REAL)**

### **Objetivo**

Permitir que un usuario **opere correctamente en mÃºltiples empresas** sin cruces, sin ambigÃ¼edad y con control total.

---

### **ğŸ¢ 1\) CreaciÃ³n de empresa**

**QuiÃ©n puede crear**

* Usuario `active`  
* Con rol global vÃ¡lido  
* O miembro con permiso de creaciÃ³n (definido a nivel producto)

**Reglas**

* La empresa nace:  
  * `status = active`  
  * con **al menos un owner**  
* El creador queda como `owner` automÃ¡ticamente.  
* Evento auditado: `company_created`.

---

### **âœ‰ï¸ 2\) InvitaciÃ³n a empresa**

**Flujo**

1. Owner/Admin invita por email.  
2. Se crea invitaciÃ³n con:  
   * rol asignado  
   * expiraciÃ³n  
3. Evento: `company_invite_sent`.

**Reglas**

* InvitaciÃ³n:  
  * es Ãºnica  
  * no reutilizable  
  * expira  
* Invitar a email ya miembro â†’ rechazo explÃ­cito.

---

### **âœ… 3\) AceptaciÃ³n / rechazo**

**Aceptar**

* Si usuario existe â†’ se crea membership.  
* Si no existe â†’ se crea usuario `pending`.  
* Se asigna rol.  
* Evento: `company_invite_accepted`.

**Rechazar**

* No crea membership.  
* Evento: `company_invite_rejected`.

---

### **ğŸ” 4\) Cambio de contexto de empresa**

**Reglas**

* Un usuario solo puede operar dentro de:  
  * una empresa activa  
  * de la que sea miembro activo  
* El contexto:  
  * se guarda por sesiÃ³n  
  * no es implÃ­cito  
* Evento: `company_context_changed`.

---

### **ğŸ”’ 5\) ProtecciÃ³n de ownership**

* Una empresa **nunca** puede quedar sin `owner`.  
* Intentar remover al Ãºltimo owner:  
  * operaciÃ³n bloqueada  
  * evento auditado: `last_owner_protection`.

---

### **ğŸ§± 6\) Salida de empresa**

**Reglas**

* Un usuario puede salir de una empresa.  
* No puede salir si es el Ãºltimo owner.  
* Evento: `membership_left`.

---

### **âœ” Resultado**

* Multiempresa real  
* Sin fugas de datos  
* Flujos claros para usuarios reales  
* Preparado para escalar a ERP

---

---

## **âœ… PASO 14 â€” LIFECYCLE DE EMPRESAS**

### **Objetivo**

Definir **cÃ³mo una empresa cambia de estado** sin pÃ©rdida de datos ni inconsistencias.

---

### **ğŸ§­ Estados permitidos**

* `active` â†’ operativa  
* `inactive` â†’ pausada (sin nuevas operaciones)  
* `archived` â†’ histÃ³rica, solo lectura  
* `deleted` â†’ eliminaciÃ³n lÃ³gica (no visible, no operable)

---

### **ğŸ” Transiciones vÃ¡lidas**

1. **active â†’ inactive**  
   * Permitido siempre.  
   * No elimina datos.  
   * Evento: `company_deactivated`.  
2. **inactive â†’ active**  
   * Permitido si no hay bloqueos legales.  
   * Evento: `company_reactivated`.  
3. **active / inactive â†’ archived**  
   * Requiere:  
     * cero operaciones activas  
     * usuarios notificados  
   * Empresa queda **solo lectura**.  
   * Evento: `company_archived`.  
4. **archived â†’ active**  
   * Permitido por owner/superadmin.  
   * Evento: `company_restored`.  
5. **archived â†’ deleted**  
   * Requiere:  
     * sin datos activos dependientes  
     * confirmaciÃ³n explÃ­cita  
   * Marca `deleted_at`.  
   * Evento: `company_deleted_logical`.

---

### **ğŸ”’ Reglas duras**

* **Nunca** borrado fÃ­sico.  
* **Nunca** dejar empresa sin `owner`.  
* No se puede:  
  * archivar si hay operaciones activas  
  * eliminar si hay dependencias activas  
* Toda transiciÃ³n es **auditada**.

---

### **âœ” Resultado**

* Ciclo de vida claro y seguro  
* Historial intacto  
* Preparado para compliance y soporte

---

---

## **âœ… PASO 15 â€” LIFECYCLE DE USUARIOS**

### **Objetivo**

Definir **cÃ³mo evoluciona un usuario** desde su creaciÃ³n hasta su eliminaciÃ³n lÃ³gica, **sin perder trazabilidad ni seguridad**.

---

### **ğŸ§­ Estados permitidos**

* `pending` â†’ creado, email no verificado  
* `active` â†’ puede operar  
* `locked` â†’ bloqueo automÃ¡tico temporal  
* `disabled` â†’ bloqueo manual administrativo  
* `deleted` â†’ eliminaciÃ³n lÃ³gica (no visible, no accesible)

---

### **ğŸ” Transiciones vÃ¡lidas**

1. **pending â†’ active**  
   * Requiere:  
     * verificaciÃ³n de email  
     * aceptaciÃ³n legal vigente  
   * Evento: `user_activated`.  
2. **active â†’ locked**  
   * AutomÃ¡tico por seguridad (intentos fallidos).  
   * Se define `locked_until`.  
   * Evento: `user_auto_locked`.  
3. **locked â†’ active**  
   * AutomÃ¡tico al vencer `locked_until`.  
   * Evento: `user_auto_unlocked`.  
4. **active â†’ disabled**  
   * Manual (admin/superadmin).  
   * No reversible sin intervenciÃ³n explÃ­cita.  
   * Evento: `user_disabled`.  
5. **disabled â†’ active**  
   * Manual (admin/superadmin).  
   * Evento: `user_reenabled`.  
6. **active / disabled â†’ deleted**  
   * EliminaciÃ³n lÃ³gica.  
   * Usuario:  
     * pierde acceso  
     * conserva historial  
   * Evento: `user_deleted_logical`.

---

### **ğŸ”’ Reglas duras**

* **Nunca** borrado fÃ­sico.  
* Usuario `deleted`:  
  * no inicia sesiÃ³n  
  * no acepta invitaciones  
  * no acepta legales  
* Bloqueos automÃ¡ticos:  
  * **no** cambian membresÃ­as  
* Bloqueos manuales:  
  * revocan **todas** las sesiones.  
* Cambios de estado **siempre auditados**.

---

### **ğŸ§± RelaciÃ³n con empresas**

* Eliminar lÃ³gicamente un usuario:  
  * **no elimina** empresas  
  * **no elimina** auditorÃ­a  
  * memberships pasan a `revoked`  
* No se puede eliminar:  
  * si es **Ãºltimo owner** de alguna empresa  
  * sin transferir ownership antes

---

### **âœ” Resultado**

* Ciclo de vida claro  
* Seguridad total  
* Sin pÃ©rdida histÃ³rica  
* Compatible con crecimiento y compliance

---

---

## **âœ… PASO 16 â€” LIFECYCLE DE MEMBRESÃAS Y ROLES**

### **Objetivo**

Definir **cÃ³mo un usuario entra, cambia y sale de una empresa**, y cÃ³mo evolucionan sus roles **sin romper ownership ni seguridad**.

---

## **ğŸ§­ Estados de company\_memberships**

* `invited` â†’ invitaciÃ³n emitida, no aceptada  
* `active` â†’ miembro operativo  
* `revoked` â†’ acceso retirado por la empresa  
* `left` â†’ salida voluntaria del usuario  
* `deleted` â†’ eliminaciÃ³n lÃ³gica (histÃ³rica)

---

## **ğŸ” Transiciones vÃ¡lidas (membership)**

1. **invited â†’ active**  
   * InvitaciÃ³n aceptada.  
   * Evento: `membership_activated`.  
2. **invited â†’ revoked**  
   * InvitaciÃ³n cancelada.  
   * Evento: `membership_invite_revoked`.  
3. **active â†’ revoked**  
   * AcciÃ³n de owner/admin.  
   * Evento: `membership_revoked`.  
4. **active â†’ left**  
   * AcciÃ³n del usuario.  
   * Evento: `membership_left`.  
5. **revoked / left â†’ active**  
   * Solo por nueva invitaciÃ³n.  
   * Evento: `membership_reactivated`.  
6. **any â†’ deleted**  
   * EliminaciÃ³n lÃ³gica histÃ³rica.  
   * Evento: `membership_deleted_logical`.

---

## **ğŸ§­ Estados de membership\_roles**

* `active`  
* `deleted`

---

## **ğŸ” Transiciones vÃ¡lidas (roles)**

1. **AsignaciÃ³n inicial**  
   * Se crea un rol activo.  
   * Evento: `role_assigned`.  
2. **Cambio de rol**  
   * Nuevo rol activo.  
   * Rol previo pasa a `deleted`.  
   * Evento: `role_changed`.  
3. **EliminaciÃ³n lÃ³gica**  
   * Solo si existe otro rol activo.  
   * Evento: `role_deleted_logical`.

---

## **ğŸ”’ Reglas duras**

* Un membership tiene **un solo rol activo**.  
* Una empresa **no puede quedar sin owner**.  
* No se puede:  
  * revocar  
  * cambiar rol  
  * eliminar  
    a un membership si rompe la regla de ownership.  
* Todos los cambios:  
  * son explÃ­citos  
  * son auditados.

---

## **ğŸ§± RelaciÃ³n con usuarios y empresas**

* Desactivar un usuario:  
  * **no borra** memberships  
  * impide operar  
* Archivar empresa:  
  * memberships quedan solo lectura  
* Eliminar empresa lÃ³gicamente:  
  * memberships pasan a `deleted`

---

### **âœ” Resultado**

* Control total de acceso por empresa  
* Ownership protegido  
* Historial intacto  
* Base sÃ³lida para permisos futuros

---

---

## **âœ… PASO 17 â€” CIERRE FORMAL DE FASE 1**

### **Objetivo**

Declarar la **FASE 1 oficialmente terminada**, **congelada** y **lista para ser implementada** sin reinterpretaciones.

---

## **ğŸ§¾ Checklist final (obligatorio)**

### **ğŸ”’ Arquitectura**

* Identidad global definida (users).  
* Multiempresa real sin cruces.  
* Roles gruesos, no permisos finos.  
* Sin borrado fÃ­sico en entidades core.  
* Regla padreâ€“hijo aplicada a todo.

### **ğŸ§­ Ciclos de vida**

* Usuarios: definidos y auditados.  
* Empresas: definidos y auditados.  
* MembresÃ­as y roles: definidos y protegidos.  
* Sesiones y seguridad: definidos end-to-end.

### **ğŸ” Seguridad**

* Login seguro sin filtrado de informaciÃ³n.  
* Bloqueos automÃ¡ticos y manuales.  
* Tokens seguros y revocables.  
* AuditorÃ­a de eventos crÃ­ticos y de seguridad.

### **ğŸ§¾ AuditorÃ­a y legal**

* Audit log universal, append-only.  
* Eventos de seguridad separados y auditados.  
* AceptaciÃ³n legal versionada e inmutable.

### **ğŸ§± Scope**

* Alcance incluido/excluido documentado.  
* Fase 1 **no contiene negocio**.  
* Fase 1 **no contiene contabilidad**.  
* Fase 1 **no contiene permisos finos**.

---

## **ğŸ”’ Estado oficial**

* **Fase:** CORE PLATFORM â€“ FASE 1  
* **Estado:** CERRADA / CONGELADA  
* **Modificable:** âŒ No  
* **Cambios:** solo mediante apertura formal de Fase 2+  
* **Uso:** contrato tÃ©cnico y de producto

---

## **ğŸ“Œ DeclaraciÃ³n final**

â€œEste documento define el nÃºcleo inmutable del sistema.  
Cualquier implementaciÃ³n debe ajustarse a estas reglas sin excepciÃ³n.â€

Con esto:

* no hay deuda conceptual  
* no hay ambigÃ¼edades  
* no hay decisiones postergadas  
* el sistema es escalable y seguro por diseÃ±o

---



===== ARCHIVO: ğŸ“˜ FASE 2 - SISA ERP.md =====
# **ğŸ“˜ FASE 2 â€” SISA ERP**

## **PASO 2 â€” DOCUMENTACIÃ“N OPERATIVA COMPLETA Y DEFINITIVA**

**Contrato de arquitectura â€¢ Sin cÃ³digo â€¢ Sin SQL â€¢ Sin implementaciÃ³n**

---

# **ğŸ§­ 0\. PROPÃ“SITO DE LA FASE 2**

FASE 2 define el **ERP Operativo**:

* registra hechos operativos reales  
* organiza relaciones entre empresas  
* maneja tiempos, estados y responsabilidades  
* produce datos **consistentes, inmutables y auditables**  
* prepara la informaciÃ³n para que **ACCCORE (Fase 3\)** genere contabilidad

FASE 2 **no interpreta**, solo **registra**.

---

# **ğŸ§± 1\. PRINCIPIOS RECTORES (INAMOVIBLES)**

### **1.1 No existe borrado fÃ­sico**

Todo registro permanece.  
Solo existe:

* `status`  
* `deleted_at`  
* estados terminales (`cancelled`, `voided`, `completed`, etc.)

### **1.2 Regla 4equim (Padreâ€“Hijo)**

No se puede cerrar o invalidar un padre si hay hijos activos contradictorios:

Ejemplos:

* una factura `issued` no puede `voided` si tiene receipts `completed`  
* una venta no puede `cancelled` si tiene invoice activa  
* un job no puede eliminarse si tiene ejecuciÃ³n

### **1.3 Audit Trail Obligatorio**

Toda acciÃ³n significativa genera:

* actor  
* timestamp  
* entidad \+ id  
* estado anterior â†’ nuevo  
* motivo (si aplica)  
* dependencias vinculadas

Intentos bloqueados **tambiÃ©n se auditan**.

### **1.4 Idempotencia real**

La misma operaciÃ³n repetida:

* no duplica efectos  
* responde â€œok, ya estaba hechoâ€  
* se puede registrar como no-op relevante

### **1.5 Estados terminales**

No retroceden:

* `completed`  
* `cancelled`  
* `voided`  
* `reversed`  
* `deleted`

### **1.6 Inmutabilidad de datos operativos**

Una vez emitidos/confirmados:

âŒ No se modifican importes  
âŒ No se cambian Ã­tems  
âŒ No se cambian fechas reales  
âœ” Se permiten **ajustes** mediante eventos explÃ­citos

---

# **ğŸ§± 2\. CLIENTES Y PROVEEDORES â€” DEFINICIÃ“N FINAL**

**No existen tablas clients ni providers.**

Regla absoluta:

Cliente y proveedor son solamente **roles** de una **empresa existente en la tabla `companies`**.

Referencias vÃ¡lidas:

* `client_company_id` â†’ `companies.id`  
* `provider_company_id` â†’ `companies.id`

Una empresa puede ser:

* cliente  
* proveedor  
* ambas  
* ninguna

No se duplican datos.  
No se reescribe CUIT.  
No se generan inconsistencias legales.

---

# **ğŸ§± 3\. ENTIDADES OPERATIVAS DE FASE 2**

FASE 2 define:

* **Sales** (ventas operativas)  
* **Purchases** (compras operativas)  
* **Quotes** (presupuestos)  
* **Jobs** (Ã³rdenes de trabajo)  
* **Invoices** (documento operativo)  
* **Receipts** (cobros)  
* **Payments** (pagos)  
* **Adjustments** (ajustes operativos)

Todas:

* pertenecen a una empresa  
* tienen lifecycle  
* generan auditorÃ­a  
* respetan regla 4equim  
* NO generan asientos contables  
* NO interpretan fiscalidad

---

# **ğŸ§± 4\. LIFECYCLE POR ENTIDAD**

(MÃ¡quinas de estado completas, definitivas)

---

# **4.1 JOBS / WORK ORDERS â€” Modelo Final**

## **Estados vÃ¡lidos**

* `planned`  
* `in_progress`  
* `paused`  
* `completed` (terminal)  
* `cancelled` (terminal)

## **âŒ Transiciones prohibidas**

* `completed â†’ *`  
* `cancelled â†’ *`  
* `in_progress â†’ planned`  
* `paused â†’ planned` (NO permitido)

## **âœ” Transiciones vÃ¡lidas**

* `planned â†’ in_progress`  
* `planned â†’ cancelled`  
* `in_progress â†’ paused`  
* `paused â†’ in_progress`  
* `in_progress â†’ completed`  
* `paused â†’ completed` (requiere evidencia real)

## **Precondiciones obligatorias**

### **Para `planned â†’ in_progress`**

* **start\_datetime obligatorio**  
* responsable asignado  
* tipo de job definido  
* empresa activa

### **Para `in_progress â†’ completed`**

Debe existir evidencia:

* timestamps reales de inicio/fin  
* tareas ejecutadas  
* tiempos registrados  
* evento explÃ­cito de cierre

### **CancelaciÃ³n**

* desde `planned`: libre con motivo  
* desde `in_progress`: permitido con evidencia \+ motivo  
  (no se borra lo ya ejecutado)

---

# **4.2 MODIFICACIÃ“N DE FECHAS â€” SOLUCIÃ“N FINAL Y UNIVERSAL**

### **Principio duro**

El pasado NO se edita.  
Se corrige agregando historia.

### **Tipos de fechas**

* **planificadas** â†’ editables  
* **reales** â†’ inmutables  
* **correcciones** â†’ eventos

## **CÃ³mo se modifica:**

### **Estado `planned`**

âœ” puede cambiar fechas sin restricciones  
âœ” auditado

### **Estados `in_progress` / `paused`**

âŒ NO se edita lo que ya ocurriÃ³  
âœ” se ajusta lo futuro  
âœ” se registra **schedule\_adjusted**

### **Estado `completed`**

âŒ No se puede tocar  
âœ” solo ajustes mediante eventos: `job_time_correction_applied`

---

# **4.3 SALES**

## **Estados**

* `draft`  
* `confirmed`  
* `cancelled` (terminal)

## **Transiciones vÃ¡lidas**

* `draft â†’ confirmed`  
* `draft â†’ cancelled`  
* `confirmed â†’ cancelled` (si no tiene invoice o receipts activos)

## **Precondiciones para `draft â†’ confirmed`**

* company activa  
* client\_company\_id vÃ¡lido  
* items \> 0  
* moneda definida  
* fecha operativa

---

# **4.4 PURCHASES**

SimÃ©trico a Sales:

* `draft â†’ confirmed`  
* `draft â†’ cancelled`  
* `confirmed â†’ cancelled` (sin pagos ni documentos activos)

---

# **4.5 QUOTES (PRESUPUESTOS)**

## **Estados**

* `draft`  
* `sent`  
* `accepted`  
* `rejected`  
* `expired` (terminal)

## **Transiciones**

* `draft â†’ sent`  
* `sent â†’ accepted`  
* `sent â†’ rejected`  
* `sent â†’ expired`

Accepted â†’ terminal lÃ³gico (no vuelve atrÃ¡s)

---

# **4.6 INVOICES (Documento operativo)**

## **Estados**

* `draft`  
* `issued`  
* `voided`

## **Transiciones vÃ¡lidas**

* `draft â†’ issued`  
* `draft â†’ voided`  
* `issued â†’ voided` (sin receipts completed)

---

# **4.7 RECEIPTS (Cobros)**

## **Estados**

* `pending`  
* `completed`  
* `reversed`

## **Transiciones vÃ¡lidas**

* `pending â†’ completed`  
* `pending â†’ reversed`  
* `completed â†’ reversed`

---

# **4.8 PAYMENTS (Pagos)**

SimÃ©trico a receipts.

---

# **4.9 ADJUSTMENTS (Ajustes operativos)**

Se usan para:

* corregir tiempos reales  
* corregir datos histÃ³ricos relevantes  
* sin reescribir el registro original

Estados:

* `draft`  
* `applied` (terminal)  
* `cancelled`

---

# **ğŸ§± 5\. VALIDACIONES CRUZADAS DEL ERP**

### **5.1 Dependencias inconsistentes (bloquea)**

Ejemplos:

* invoice con receipt â†’ no se puede voided  
* sale con invoice â†’ no se puede cancelar  
* purchase con payment â†’ no se puede cancelar

### **5.2 Temporalidad**

No se puede reescribir:

* fechas reales  
* eventos pasados  
* operaciones ya emitidas/confirmadas

### **5.3 Empresas inactivas**

Si `company.status != active`:

* no se pueden crear operaciones nuevas  
* solo lectura y archivado

---

# **ğŸ§± 6\. AUDITORÃA OBLIGATORIA**

Cada transiciÃ³n o cambio relevante genera:

* actor  
* timestamp  
* estado anterior / nuevo  
* payload de cambios  
* motivo (si corresponde)  
* ids referenciados  
* no-op si corresponde

Cambios temporales SIEMPRE auditan valor anterior y nuevo.

---

# **ğŸ§± 7\. EVENTOS OPERATIVOS**

(Base para ACCCORE)

FASE 2 genera eventos como:

* `job_started`  
* `job_paused`  
* `job_completed`  
* `job_cancelled`  
* `schedule_adjusted`  
* `sale_confirmed`  
* `invoice_issued`  
* `receipt_completed`  
* `payment_completed`  
* `correction_applied`  
* etc.

Estos eventos:

* son inmutables  
* no se modifican  
* son el insumo de ACCCORE  
* no contienen lÃ³gica contable

---

# **ğŸ§± 8\. RELACIÃ“N FASE 2 â†’ FASE 3**

FASE 2:

* registra hechos brutos  
* mantiene historia limpia  
* garantiza trazabilidad completa

FASE 3:

* lee eventos  
* genera asientos  
* aplica fiscalidad y reglas contables

FASE 2 NO incluye:

* cuentas contables  
* IVA  
* percepciones  
* amortizaciÃ³n  
* resultados  
* cashflow contable

---



===== ARCHIVO: ğŸ“˜ FASE 3 - ACCCORE (CONTABILIDAD).md =====
---

# **ğŸ“˜ FASE 3 â€” ACCCORE (CONTABILIDAD)**

## **PASO 3.1 â€” FUNDAMENTOS Y ORDEN DE CONSTRUCCIÃ“N CONTABLE**

**Contrato de arquitectura contable â€” Sin cÃ³digo**

---

## **ğŸ¯ PROPÃ“SITO DE ACCCORE**

ACCCORE es el **nÃºcleo contable** del sistema.

Su funciÃ³n es:

* interpretar hechos operativos del ERP (FASE 2\)  
* generar informaciÃ³n contable legal y consistente  
* mantener trazabilidad completa evento â†’ asiento  
* permitir reconstrucciÃ³n histÃ³rica  
* soportar auditorÃ­a y fiscalidad

ğŸ‘‰ **ACCCORE NO REGISTRA HECHOS**  
ğŸ‘‰ **ACCCORE INTERPRETA HECHOS YA CERRADOS**

---

## **ğŸ§± PRINCIPIO MADRE (NO NEGOCIABLE)**

**NO EXISTE CONTABILIDAD SIN EVENTOS OPERATIVOS PREVIOS**

ACCCORE:

* no recibe inputs directos de UI  
* no recibe â€œcrear asientoâ€ manual libre  
* no corrige el pasado  
* no depende de estados actuales, sino de eventos histÃ³ricos

---

## **ğŸ§± ORDEN REAL DE IMPLEMENTACIÃ“N CONTABLE**

1\) Modelo contable base

2\) Plan de cuentas

3\) Periodos contables

4\) Motor de asientos

5\) Mayor contable

6\) Cierres

7\) Reportes

Este orden **NO se altera**.

---

## **ğŸ§± 1ï¸âƒ£ MODELO CONTABLE BASE**

### **Entidades conceptuales mÃ­nimas**

* Account (Cuenta contable)  
* AccountingPeriod (Periodo)  
* JournalEntry (Asiento)  
* JournalLine (Debe / Haber)  
* AccountingEventLink (vÃ­nculo a evento ERP)

ğŸ‘‰ **Nada mÃ¡s al principio**.

---

## **ğŸ§± 2ï¸âƒ£ PLAN DE CUENTAS**

### **Reglas duras**

* Plan Ãºnico por empresa  
* Cuentas jerÃ¡rquicas  
* Cuentas:  
  * activo  
  * pasivo  
  * patrimonio  
  * resultados  
* No se eliminan  
* Se archivan  
* Se versionan implÃ­citamente por uso histÃ³rico

### **Estado de cuentas**

* active  
* archived

---

## **ğŸ§± 3ï¸âƒ£ PERIODOS CONTABLES**

### **Concepto**

La contabilidad se organiza en **periodos cerrables**:

* mensual (base)  
* anual (agrupaciÃ³n)

### **Reglas**

* Un asiento pertenece a un solo periodo  
* Periodo cerrado:  
  * no admite nuevos asientos  
  * no admite modificaciones  
* Reapertura:  
  * solo owner  
  * evento auditado

---

## **ğŸ§± 4ï¸âƒ£ MOTOR DE ASIENTOS (CORE CONTABLE)**

### **FunciÃ³n**

Transformar **eventos ERP** en **asientos contables**.

### **Reglas crÃ­ticas**

* Cada evento ERP:  
  * puede generar 0, 1 o N asientos  
* Un evento:  
  * se procesa una sola vez (idempotencia)  
* Cada asiento:  
  * estÃ¡ vinculado al evento origen  
* Debe \= Haber (siempre)

ğŸ‘‰ **No hay asientos â€œsueltosâ€**

---

## **ğŸ§± 5ï¸âƒ£ MAYOR CONTABLE**

### **FunciÃ³n**

AcumulaciÃ³n histÃ³rica de movimientos:

* por cuenta  
* por periodo  
* por empresa

### **Reglas**

* El mayor es **derivado**, no fuente  
* Nunca se edita manualmente  
* Se recalcula si es necesario

---

## **ğŸ§± 6ï¸âƒ£ CIERRES CONTABLES**

### **Proceso**

1. Validar periodos  
2. Verificar balance  
3. Cerrar periodo  
4. Bloquear escrituras  
5. Emitir evento `period_closed`

### **Reglas**

* Periodo cerrado es inmutable  
* Ajustes posteriores:  
  * se hacen en periodos futuros  
* Nunca se reescribe el pasado

---

## **ğŸ§± 7ï¸âƒ£ REPORTES (NO MVP AÃšN)**

Derivan de mayor \+ plan:

* Balance  
* Estado de resultados  
* Libros legales

ğŸ‘‰ **No se implementan antes de cerrar lo anterior**

---

## **ğŸ” AUTORIZACIÃ“N CONTABLE**

* Solo roles finos contables  
* Solo owner puede:  
  * cerrar periodos  
  * reabrir periodos  
* Admin:  
  * NO toca contabilidad  
* Member / Viewer:  
  * NO acceden

---

## **ğŸ§¾ AUDITORÃA CONTABLE**

Debe existir trazabilidad completa:

Evento ERP â†’ Asiento â†’ LÃ­nea â†’ Cuenta â†’ Periodo

Nada puede romper esa cadena.

---

## **ğŸš¨ COSAS QUE NO SE HACEN (NUNCA)**

* âŒ Crear asientos desde UI  
* âŒ Editar asientos  
* âŒ Borrar asientos  
* âŒ Reabrir periodos sin auditorÃ­a  
* âŒ Mezclar contabilidad con ERP  
* âŒ Inferir contabilidad por estado actual

---

---

# **ğŸ“˜ FASE 3 â€” ACCCORE (CONTABILIDAD)**

## **PASO 3.2 â€” DISEÃ‘O DEL PLAN DE CUENTAS BASE (ARGENTINA-READY)**

**Contrato de arquitectura contable â€” Sin cÃ³digo**

---

## **ğŸ¯ OBJETIVO**

Definir un **Plan de Cuentas base**, mÃ­nimo pero **legalmente vÃ¡lido en Argentina**, que:

* sea **genÃ©rico y reutilizable**  
* soporte **ERP multiempresa**  
* permita **reconstrucciÃ³n histÃ³rica**  
* no mezcle fiscalidad con operaciÃ³n  
* escale sin romper compatibilidad

Este plan **no es el definitivo de cada empresa**, es el **baseline obligatorio**.

---

## **ğŸ§± PRINCIPIOS INMUTABLES**

1. **Plan Ãºnico por empresa**  
2. **Cuentas jerÃ¡rquicas** (padre/hijo)  
3. **Nunca se borran cuentas**  
4. **Una cuenta usada no cambia de tipo**  
5. **El pasado no se reescribe**  
6. **La contabilidad nace del ERP, no del usuario**

---

## **ğŸ§± ESTRUCTURA GENERAL DEL PLAN**

ClasificaciÃ³n contable estÃ¡ndar:

1 \- ACTIVO  
2 \- PASIVO  
3 \- PATRIMONIO NETO  
4 \- RESULTADOS (+)  
5 \- RESULTADOS (âˆ’)

Cada nivel admite **subniveles ilimitados**.

---

## **ğŸ§± 1ï¸âƒ£ ACTIVO (1.x)**

### **1.1 Activo Corriente**

* 1.1.1 Caja  
* 1.1.2 Bancos  
* 1.1.3 Valores a Depositar  
* 1.1.4 CrÃ©ditos por Ventas  
* 1.1.5 Otros CrÃ©ditos  
* 1.1.6 IVA CrÃ©dito Fiscal  
* 1.1.7 Anticipos a Proveedores  
* 1.1.8 MercaderÃ­as / Stock

### **1.2 Activo No Corriente**

* 1.2.1 Bienes de Uso  
* 1.2.2 AmortizaciÃ³n Acumulada  
* 1.2.3 Inversiones  
* 1.2.4 Activos Intangibles

---

## **ğŸ§± 2ï¸âƒ£ PASIVO (2.x)**

### **2.1 Pasivo Corriente**

* 2.1.1 Proveedores  
* 2.1.2 Documentos a Pagar  
* 2.1.3 Remuneraciones a Pagar  
* 2.1.4 Cargas Sociales a Pagar  
* 2.1.5 IVA DÃ©bito Fiscal  
* 2.1.6 Impuestos a Pagar  
* 2.1.7 Anticipos de Clientes

### **2.2 Pasivo No Corriente**

* 2.2.1 PrÃ©stamos Bancarios  
* 2.2.2 Deudas a Largo Plazo

---

## **ğŸ§± 3ï¸âƒ£ PATRIMONIO NETO (3.x)**

* 3.1 Capital Social  
* 3.2 Ajustes al Patrimonio  
* 3.3 Resultados Acumulados  
* 3.4 Resultado del Ejercicio

---

## **ğŸ§± 4ï¸âƒ£ RESULTADOS POSITIVOS (4.x)**

### **4.1 Ingresos Operativos**

* 4.1.1 Ventas  
* 4.1.2 Servicios Prestados

### **4.2 Ingresos No Operativos**

* 4.2.1 Intereses Ganados  
* 4.2.2 Diferencias de Cambio

---

## **ğŸ§± 5ï¸âƒ£ RESULTADOS NEGATIVOS (5.x)**

### **5.1 Costos**

* 5.1.1 Costo de MercaderÃ­as Vendidas  
* 5.1.2 Costo de Servicios Prestados

### **5.2 Gastos Operativos**

* 5.2.1 Sueldos y Jornales  
* 5.2.2 Cargas Sociales  
* 5.2.3 Alquileres  
* 5.2.4 Servicios  
* 5.2.5 Mantenimiento  
* 5.2.6 Honorarios  
* 5.2.7 Impuestos y Tasas  
* 5.2.8 Gastos Bancarios

### **5.3 Gastos No Operativos**

* 5.3.1 Intereses Perdidos  
* 5.3.2 Diferencias de Cambio

---

## **ğŸ§± CODIFICACIÃ“N DE CUENTAS**

### **Reglas**

* CÃ³digo numÃ©rico jerÃ¡rquico (`1.1.4`, `5.2.3`)  
* El cÃ³digo **no define lÃ³gica**, solo orden  
* El tipo de cuenta define comportamiento:  
  * ACTIVO / PASIVO / PATRIMONIO / RESULTADO+

---

## **ğŸ§± ESTADOS DE CUENTAS**

* `active`  
* `archived`

### **Reglas duras**

* Una cuenta **archivada**:  
  * no admite nuevos asientos  
  * conserva historial  
* Una cuenta **usada**:  
  * no cambia de tipo  
  * no cambia de jerarquÃ­a padre

---

## **ğŸ§± RELACIÃ“N CON EL ERP (FASE 2\)**

Las cuentas **NO se usan directamente desde el ERP**.

El ERP genera **eventos** como:

* `invoice_issued`  
* `receipt_completed`  
* `payment_completed`  
* `job_completed`

ACCCORE traduce esos eventos a asientos usando **reglas contables** (PASO 3.3).

---

## **ğŸ§¾ EJEMPLO CONCEPTUAL (SIN CÃ“DIGO)**

Evento:

invoice\_issued

Asiento:

Debe: 1.1.4 CrÃ©ditos por Ventas  
Haber: 4.1.1 Ventas  
Haber: 2.1.5 IVA DÃ©bito Fiscal

âš ï¸ Esto es **ejemplo conceptual**, no implementaciÃ³n.

---

## **ğŸ” AUTORIZACIÃ“N**

* Solo `accounting_operator` y `accounting_admin`  
* Cierre y reapertura:  
  * solo `owner`  
* Admin / Member / Viewer:  
  * âŒ sin acceso

---

## **ğŸš¨ COSAS QUE NO SE HACEN**

* âŒ Borrar cuentas  
* âŒ Editar tipo de cuenta usada  
* âŒ Postear manualmente sin evento  
* âŒ Mezclar impuestos con ingresos  
* âŒ Crear cuentas â€œhardcodeadasâ€ por UI

---

---

# **ğŸ“˜ FASE 3 â€” ACCCORE (CONTABILIDAD)**

## **PASO 3.3 â€” MOTOR DE ASIENTOS CONTABLES (EVENT â†’ JOURNAL)**

**Contrato de arquitectura â€” Sin cÃ³digo**

---

## **ğŸ¯ OBJETIVO**

Definir el **Motor de Asientos Contables**, responsable de:

* transformar **eventos del ERP** en **asientos contables**  
* garantizar **integridad**, **idempotencia** y **trazabilidad**  
* impedir creaciÃ³n manual o implÃ­cita de asientos  
* asegurar cumplimiento legal y contable

Este motor es el **corazÃ³n de ACCCORE**.

---

## **ğŸ§± PRINCIPIOS NO NEGOCIABLES**

1. **Los asientos nacen SOLO de eventos ERP**  
2. **Cada evento se procesa una sola vez**  
3. **Debe \= Haber siempre**  
4. **Nada se edita, todo se deriva**  
5. **El pasado no se corrige**  
6. **Toda traducciÃ³n es auditable**

---

## **ğŸ§± ENTRADA DEL MOTOR**

### **Eventos vÃ¡lidos**

* `invoice_issued`  
* `invoice_voided`  
* `receipt_completed`  
* `receipt_reversed`  
* `payment_completed`  
* `payment_reversed`  
* `job_completed`  
* `adjustment_event` (siempre explÃ­cito)

### **Reglas**

* Evento **cerrado**  
* Evento **vÃ¡lido**  
* Evento **no procesado**  
* Evento **pertenece a empresa activa**

Si falla alguna â†’ **RECHAZO \+ AUDITORÃA**

---

## **ğŸ§± SALIDA DEL MOTOR**

* 0, 1 o N **JournalEntry**  
* Cada JournalEntry tiene:  
  * fecha contable  
  * periodo contable  
  * referencia al evento  
  * estado `posted`

---

## **ğŸ§± ESTRUCTURA DE ASIENTO**

### **JournalEntry**

* empresa  
* periodo  
* evento origen  
* timestamp de contabilizaciÃ³n  
* estado

### **JournalLine**

* cuenta  
* debe / haber  
* importe  
* moneda  
* metadata mÃ­nima

---

## **ğŸ§± IDempotencia (CRÃTICO)**

### **Regla**

Un evento ERP **no puede generar asientos dos veces**.

### **Mecanismo conceptual**

* Cada evento tiene:  
  * `accounting_processed = false`  
* El motor:  
  * marca el evento al procesar  
  * rechaza reprocesos

### **Reprocesamiento**

* Solo mediante comando explÃ­cito  
* Evento auditado  
* Nunca automÃ¡tico

---

## **ğŸ§± SELECCIÃ“N DE PERIODO CONTABLE**

### **Regla base**

* El asiento se imputa al periodo:  
  * correspondiente a la **fecha del evento**  
* Si el periodo estÃ¡ cerrado:  
  * evento se rechaza  
  * o se difiere (segÃºn polÃ­tica futura)

âš ï¸ MVP: **rechazo duro**

---

## **ğŸ§± REGLAS DE TRADUCCIÃ“N (EJEMPLOS CONCEPTUALES)**

### **ğŸ“„ `invoice_issued`**

Debe: CrÃ©ditos por Ventas  
Haber: Ventas  
Haber: IVA DÃ©bito Fiscal

---

### **ğŸ’° `receipt_completed`**

Debe: Caja / Bancos  
Haber: CrÃ©ditos por Ventas

---

### **ğŸ’¸ `payment_completed`**

Debe: Proveedores  
Haber: Caja / Bancos

---

### **ğŸ” Reversiones (`*_reversed`)**

**Nunca se borra el asiento original**

Se genera un **asiento espejo**:

* Debe â†” Haber  
* Mismo importe  
* Referencia al evento de reversiÃ³n

---

## **ğŸ§± VALIDACIONES CONTABLES**

Antes de postear:

* Debe \= Haber  
* Cuentas activas  
* Periodo abierto  
* Evento vÃ¡lido  
* Empresa coincide  
* Moneda vÃ¡lida

Si falla â†’ **NO POSTEAR**

---

## **ğŸ§¾ AUDITORÃA CONTABLE**

Registrar:

* evento ERP  
* asientos generados  
* lÃ­neas  
* cuentas  
* periodo  
* usuario (si aplica)  
* timestamp

---

## **ğŸ§± ERRORES Y RECHAZOS**

Un rechazo:

* NO se corrige  
* NO se reintenta automÃ¡ticamente  
* genera evento `accounting_rejected`

Motivos:

* periodo cerrado  
* evento invÃ¡lido  
* inconsistencia contable

---

## **ğŸš¨ COSAS PROHIBIDAS**

* âŒ Crear asientos manuales  
* âŒ Editar asientos  
* âŒ Borrar asientos  
* âŒ Postear en periodos cerrados  
* âŒ Reprocesar sin auditorÃ­a  
* âŒ Generar asientos desde UI

---

## **ğŸ” AUTORIZACIÃ“N**

* Posteo automÃ¡tico: sistema  
* Reprocesos:  
  * solo `accounting_admin`  
* Cierre de periodo:  
  * solo `owner`

---

## **âœ… RESULTADO DEL PASO 3.3**

Al finalizar este paso:

* tenÃ©s un motor determinÃ­stico  
* eventos â†’ asientos trazables  
* contabilidad inmutable  
* sistema audit-ready  
* base sÃ³lida para fiscalidad

---

---

# **ğŸ“˜ FASE 3 â€” ACCCORE (CONTABILIDAD)**

## **PASO 3.4 â€” PERIODOS CONTABLES Y CIERRES**

**Contrato de arquitectura contable â€” Sin cÃ³digo**

---

## **ğŸ¯ OBJETIVO**

Definir el **modelo de periodos contables** y el **proceso de cierre**, garantizando que:

* la contabilidad sea **inmutable**  
* el pasado **no se reescriba**  
* los asientos queden **legalmente protegidos**  
* los errores se corrijan **hacia adelante**  
* exista **trazabilidad completa**

Este paso convierte a ACCCORE en un sistema **legalmente serio**.

---

## **ğŸ§± PRINCIPIO MADRE**

**UN PERIODO CERRADO ES INVIOLABLE**

No admite:

* nuevos asientos  
* modificaciones  
* reversiones directas

Cualquier correcciÃ³n ocurre **en periodos futuros**.

---

## **ğŸ§± DEFINICIÃ“N DE PERIODO CONTABLE**

Un **Accounting Period** representa un intervalo temporal cerrado.

### **Propiedades conceptuales**

* empresa  
* fecha\_inicio  
* fecha\_fin  
* estado  
* timestamp de cierre (si aplica)

### **Estados posibles**

* `open`  
* `closed`  
* `reopened` (estado tÃ©cnico, no operativo)

---

## **ğŸ§± GRANULARIDAD**

### **MVP**

* Periodos **mensuales**  
* AÃ±o contable \= agrupaciÃ³n de periodos

âš ï¸ No se permite:

* periodos diarios  
* periodos arbitrarios  
* periodos solapados

---

## **ğŸ§± REGLAS DE ASIGNACIÃ“N DE ASIENTOS**

* Cada asiento pertenece a **un solo periodo**  
* El periodo se determina por:  
  * fecha del evento ERP  
* No se reasigna un asiento a otro periodo

Si el periodo correspondiente estÃ¡ cerrado:

* el evento **se rechaza** (MVP)  
* se audita el rechazo

---

## **ğŸ§± PROCESO DE CIERRE CONTABLE**

### **Secuencia obligatoria**

1. Verificar que el periodo estÃ© `open`  
2. Validar integridad contable  
3. Verificar Debe \= Haber global  
4. Confirmar ausencia de asientos pendientes  
5. Ejecutar cierre  
6. Cambiar estado a `closed`  
7. Emitir evento `period_closed`  
8. Bloquear escrituras

---

## **ğŸ§± VALIDACIONES PRE-CIERRE**

Antes de cerrar:

* No hay asientos desbalanceados  
* No hay eventos ERP sin procesar  
* Todas las cuentas son vÃ¡lidas  
* No hay inconsistencias monetarias  
* AuditorÃ­a completa

Si falla alguna â†’ **NO cerrar**

---

## **ğŸ§± EFECTOS DEL CIERRE**

Un periodo cerrado:

* âŒ no acepta nuevos asientos  
* âŒ no admite modificaciones  
* âŒ no permite reversiones  
* âŒ no permite reprocesos  
* âœ… conserva trazabilidad total

---

## **ğŸ§± REAPERTURA DE PERIODO (EXCEPCIONAL)**

### **Regla dura**

**Reabrir un periodo es una excepciÃ³n grave**

### **AutorizaciÃ³n**

* Solo `owner`  
* Nunca `admin`  
* Nunca automÃ¡tica

---

### **Proceso de reapertura**

1. Solicitud explÃ­cita  
2. Motivo obligatorio  
3. AuditorÃ­a reforzada  
4. Cambio temporal a `reopened`  
5. Acciones estrictamente necesarias  
6. Nuevo cierre inmediato  
7. Evento `period_reopened`

âš ï¸ La reapertura **no borra historia**, solo habilita acciones controladas.

---

## **ğŸ§± AJUSTES POST-CIERRE**

### **Regla**

Los errores detectados **despuÃ©s del cierre**:

* NO modifican el periodo cerrado  
* generan **asientos de ajuste** en el periodo actual

Ejemplos:

* ajustes contables  
* diferencias  
* reclasificaciones

---

## **ğŸ§¾ AUDITORÃA CONTABLE**

Debe registrarse:

* cierre de periodo  
* reapertura  
* usuario responsable  
* timestamp  
* motivo  
* impactos derivados

La auditorÃ­a es **append-only**.

---

## **ğŸ” AUTORIZACIÃ“N**

* Cerrar periodo:  
  * `owner`  
* Reabrir periodo:  
  * `owner`  
* Postear asientos:  
  * sistema (motor)  
* Admin / Member / Viewer:  
  * âŒ sin acceso

---

## **ğŸš¨ COSAS PROHIBIDAS**

* âŒ Cerrar periodos automÃ¡ticamente  
* âŒ Reabrir sin auditorÃ­a  
* âŒ Editar asientos post-cierre  
* âŒ Borrar periodos  
* âŒ Saltar validaciones  
* âŒ Corregir el pasado

---

---

# **ğŸ“˜ FASE 3 â€” ACCCORE (CONTABILIDAD)**

## **PASO 3.5 â€” MAYOR CONTABLE Y DERIVACIONES**

**Contrato de arquitectura contable â€” Sin cÃ³digo**

---

## **ğŸ¯ OBJETIVO**

Definir el **Mayor Contable** como estructura derivada que:

* consolida los asientos  
* permite informes financieros  
* mantiene trazabilidad completa  
* no introduce mutabilidad  
* puede recalcularse sin pÃ©rdida de informaciÃ³n

El mayor **NO es fuente de verdad**, es **resultado**.

---

## **ğŸ§± PRINCIPIO FUNDAMENTAL**

**LA FUENTE DE VERDAD SON LOS ASIENTOS, NO EL MAYOR**

Si el mayor y los asientos difieren,  
**los asientos ganan siempre**.

---

## **ğŸ§± DEFINICIÃ“N DE MAYOR CONTABLE**

El **General Ledger (Mayor)** representa:

* acumulaciÃ³n de movimientos por cuenta  
* ordenados por periodo  
* con saldos progresivos

  ### **Entidades conceptuales**

* LedgerAccount (vista por cuenta)  
* LedgerPeriod (vista por periodo)  
* LedgerBalance (saldo acumulado)

âš ï¸ Son **estructuras derivadas**, no editables.

---

## **ğŸ§± CONSTRUCCIÃ“N DEL MAYOR**

### **Fuente**

* JournalEntry  
* JournalLine  
* Account  
* AccountingPeriod

  ### **Proceso conceptual**

1. Seleccionar asientos posteados  
2. Agrupar por cuenta  
3. Ordenar cronolÃ³gicamente  
4. Calcular saldos  
5. Persistir o materializar  
   ---

   ## **ğŸ§± TIPOS DE MAYOR**

   ### **1ï¸âƒ£ Mayor por Cuenta**

* Movimientos detallados  
* Saldo acumulado  
* Base para auditorÃ­a  
  ---

  ### **2ï¸âƒ£ Mayor por Periodo**

* Movimientos del periodo  
* Saldo inicial  
* Saldo final  
  ---

  ### **3ï¸âƒ£ Mayor HistÃ³rico**

* Arrastre inter-periodo  
* Base para balances anuales  
  ---

  ## **ğŸ§± REGLAS DE SALDO**

* Activo:  
  * Debe incrementa  
  * Haber decrementa  
* Pasivo / Patrimonio:  
  * Haber incrementa  
  * Debe decrementa  
* Resultados:  
  * Se acumulan por periodo

Las reglas dependen del **tipo de cuenta**, no del evento.

---

## **ğŸ§± RECÃLCULO DEL MAYOR**

### **CuÃ¡ndo recalcular**

* reprocesamiento autorizado  
* reapertura de periodo  
* correcciÃ³n de asientos futuros  
* inconsistencia detectada

  ### **Regla**

* El recÃ¡lculo:  
  * no modifica asientos  
  * no borra historia  
  * es idempotente

  ---

  ## **ğŸ§± RELACIÃ“N CON CIERRES**

* Periodos cerrados:  
  * mayor queda congelado  
* Periodos abiertos:  
  * mayor puede recalcularse

  ---

  ## **ğŸ§± INFORMES DERIVADOS (NO MVP)**

El mayor alimenta:

* Balance General  
* Estado de Resultados  
* Libros legales

âš ï¸ No se implementan antes del cierre total del nÃºcleo.

---

## **ğŸ§¾ TRAZABILIDAD TOTAL**

Cada saldo debe poder rastrearse:

* Saldo â†’ Cuenta â†’ LÃ­nea â†’ Asiento â†’ Evento ERP


Si no se puede trazar, el dato es invÃ¡lido.

---

## **ğŸ§± AUTORIZACIÃ“N**

* VisualizaciÃ³n:  
  * `accounting_operator`  
  * `accounting_admin`  
* Recalculo:  
  * sistema  
* Admin / Member / Viewer:  
  * âŒ sin acceso

  ---

  ## **ğŸš¨ COSAS PROHIBIDAS**

* âŒ Editar el mayor manualmente  
* âŒ Usar el mayor como input  
* âŒ Ajustar saldos sin asiento  
* âŒ Ocultar movimientos  
* âŒ Calcular balances desde ERP  
  ---



===== ARCHIVO: ğŸ“˜ FASE 3 â€” ACCCORE (CONTABILIDAD) DOCUMENTO COMPLEMENTARIO.md =====
# **ğŸ“˜ FASE 3 â€” ACCCORE (CONTABILIDAD)** 

## **DOCUMENTO COMPLEMENTARIO â€” EVENTO DE APERTURA CONTABLE**

**Contrato de arquitectura â€” Sin cÃ³digo**

---

## **ğŸ¯ OBJETIVO**

Definir **cÃ³mo se inicializa la contabilidad** de una empresa en ACCCORE sin:

* editar saldos

* cargar asientos manuales arbitrarios

* romper trazabilidad

* violar inmutabilidad

ğŸ‘‰ La contabilidad **nunca empieza â€œcon nÃºmeros cargados a manoâ€**,  
 empieza con un **evento explÃ­cito y auditable**.

---

## **ğŸ§± PRINCIPIO FUNDAMENTAL**

**TODO SALDO INICIAL ES EL RESULTADO DE UN EVENTO**

No existen:

* â€œsaldos iniciales editablesâ€

* â€œarranque por UIâ€

* â€œbalances hardcodeadosâ€

---

## **ğŸ§± EVENTO `accounting_opening_event`**

### **DefiniciÃ³n conceptual**

Evento especial que representa:

* el estado patrimonial inicial de la empresa

* el punto cero contable del sistema

* la frontera entre â€œhistÃ³rico externoâ€ y â€œcontabilidad vivaâ€

---

### **CaracterÃ­sticas**

* Se ejecuta **una sola vez por empresa**

* Genera **asientos iniciales**

* Queda ligado al primer periodo contable

* Es **irreversible**

* Es **auditable**

---

## **ğŸ§± CUÃNDO SE USA**

El evento de apertura se utiliza cuando:

* una empresa empieza a usar el sistema

* se migra desde otro sistema contable

* se desea comenzar contabilidad â€œdesde ceroâ€

* se hace onboarding contable formal

---

## **ğŸ§± CUÃNDO NO SE USA**

âŒ Para correcciones  
 âŒ Para ajustes  
 âŒ Para cierres  
 âŒ Para balances provisorios

Es **solo para inicio**.

---

## **ğŸ§± CONTENIDO DEL EVENTO**

Conceptualmente incluye:

* fecha de apertura

* empresa

* periodo contable inicial

* listado de cuentas con saldo inicial

* moneda base

* referencia externa (opcional)

âš ï¸ El sistema **no valida origen externo**, solo consistencia interna.

---

## **ğŸ§± GENERACIÃ“N DE ASIENTOS INICIALES**

El motor contable traduce el evento en:

* mÃºltiples asientos

* uno por bloque lÃ³gico

* siempre balanceados

Ejemplo conceptual:

`Debe: Caja`  
`Debe: Bancos`  
`Debe: CrÃ©ditos por Ventas`  
`Haber: Proveedores`  
`Haber: Capital Social`  
`Haber: Resultados Acumulados`

âš ï¸ Ejemplo ilustrativo, no implementaciÃ³n.

---

## **ğŸ§± REGLAS DE VALIDACIÃ“N**

Antes de aceptar el evento:

* Debe \= Haber

* Cuentas vÃ¡lidas y activas

* Periodo abierto

* Evento no existente previamente

* Empresa activa

* Usuario autorizado

Si falla algo â†’ **RECHAZO \+ AUDITORÃA**

---

## **ğŸ§± RELACIÃ“N CON PERIODOS CONTABLES**

* El evento pertenece al **primer periodo**

* El periodo queda abierto tras la apertura

* El cierre funciona igual que cualquier otro periodo

---

## **ğŸ§± AUDITORÃA REFORZADA**

El evento debe registrar:

* usuario responsable

* fecha/hora

* motivo

* referencia de migraciÃ³n (si aplica)

* asientos generados

* periodo afectado

Este evento **no puede ocultarse**.

---

## **ğŸ§± AUTORIZACIÃ“N**

* Solo `owner`

* Nunca `admin`

* Nunca automÃ¡tica

* Nunca offline

---

## **ğŸ§± PROHIBICIONES ABSOLUTAS**

* âŒ Ejecutar mÃ¡s de un evento de apertura

* âŒ Editar saldos iniciales

* âŒ Borrar el evento

* âŒ Reprocesar sin autorizaciÃ³n

* âŒ Generar apertura implÃ­cita

---

## **ğŸ§± CASO: EMPRESA SIN HISTÃ“RICO**

Si la empresa **no trae saldos**:

* Se ejecuta el evento

* Con **todas las cuentas en cero**

* Queda igualmente auditado

Esto evita â€œcontabilidad fantasmaâ€.

---

## **ğŸ§± TRAZABILIDAD**

`Apertura â†’ Asientos iniciales â†’ Mayor â†’ Reportes`

No hay atajos.

---

---

# **ğŸ“˜ DIAGRAMA VISUAL â€” FLUJO CONTABLE**

## **ERP â†’ ACCCORE â†’ MAYOR**

**Contrato de arquitectura â€” Sin cÃ³digo**

---

## **ğŸ¯ OBJETIVO**

Mostrar de forma **visual y determinÃ­stica**:

* cÃ³mo nace un hecho

* cÃ³mo se transforma en contabilidad

* cÃ³mo se consolida

* dÃ³nde **NO** se puede intervenir

---

## **ğŸ§± VISIÃ“N GENERAL**

`â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”`  
`â”‚     ERP      â”‚`  
`â”‚ (Hechos)     â”‚`  
`â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜`  
       `â”‚`  
       `â”‚ Eventos operativos cerrados`  
       `â–¼`  
`â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”`  
`â”‚     ACCCORE        â”‚`  
`â”‚ Motor de Asientos  â”‚`  
`â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`  
       `â”‚`  
       `â”‚ Asientos contables inmutables`  
       `â–¼`  
`â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”`  
`â”‚   MAYOR CONTABLE   â”‚`  
`â”‚ (Derivado)         â”‚`  
`â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`  
       `â”‚`  
       `â”‚ Derivaciones`  
       `â–¼`  
`â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”`  
`â”‚  REPORTES / FISCO  â”‚`  
`â”‚ (Fuera de MVP)     â”‚`  
`â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`

---

## **ğŸ§± NIVEL 1 â€” ERP (HECHOS)**

`ERP`  
`â”‚`  
`â”œâ”€ Jobs`  
`â”‚   â””â”€ job_completed`  
`â”‚`  
`â”œâ”€ Sales`  
`â”‚   â””â”€ invoice_issued`  
`â”‚`  
`â”œâ”€ Receipts`  
`â”‚   â””â”€ receipt_completed`  
`â”‚`  
`â”œâ”€ Payments`  
`â”‚   â””â”€ payment_completed`  
`â”‚`  
`â””â”€ Reversiones`  
    `â””â”€ *_reversed`

### **Reglas**

* El ERP **NO sabe contabilidad**

* El ERP **NO conoce cuentas**

* El ERP **NO genera asientos**

* El ERP **solo emite eventos cerrados**

---

## **ğŸ§± NIVEL 2 â€” FRONTERA ERP â†’ ACCCORE**

`Evento ERP cerrado`  
`â”‚`  
`â”œâ”€ vÃ¡lido`  
`â”œâ”€ no procesado`  
`â”œâ”€ empresa activa`  
`â””â”€ periodo potencialmente abierto`

Si falla algo:

`Evento â†’ RECHAZO â†’ AuditorÃ­a`

---

## **ğŸ§± NIVEL 3 â€” ACCCORE (INTERPRETACIÃ“N)**

`ACCCORE`  
`â”‚`  
`â”œâ”€ Valida evento`  
`â”œâ”€ Determina periodo contable`  
`â”œâ”€ Aplica reglas de traducciÃ³n`  
`â”œâ”€ Genera JournalEntry`  
`â”œâ”€ Genera JournalLines`  
`â”œâ”€ Marca evento como procesado`  
`â””â”€ Audita todo`

### **Ejemplo conceptual**

`invoice_issued`  
   `â”‚`  
   `â–¼`  
`JournalEntry`  
   `â”œâ”€ Debe: CrÃ©ditos por Ventas`  
   `â”œâ”€ Haber: Ventas`  
   `â””â”€ Haber: IVA DÃ©bito Fiscal`

### **Reglas duras**

* Debe \= Haber

* No ediciÃ³n

* No borrado

* Idempotente

---

## **ğŸ§± NIVEL 4 â€” PERIODOS CONTABLES**

`Periodo OPEN`  
`â”‚`  
`â”œâ”€ acepta asientos`  
`â”‚`  
`Periodo CLOSED`  
`â”‚`  
`â””â”€ rechaza asientos`

Correcciones:

`Error detectado`  
`â”‚`  
`â””â”€ Ajuste en periodo futuro`

---

## **ğŸ§± NIVEL 5 â€” MAYOR CONTABLE (DERIVADO)**

`JournalEntries`  
`â”‚`  
`â”œâ”€ agrupaciÃ³n por cuenta`  
`â”œâ”€ orden cronolÃ³gico`  
`â”œâ”€ cÃ¡lculo de saldos`  
`â””â”€ consolidaciÃ³n por periodo`

Resultado:

`Cuenta â†’ Movimientos â†’ Saldo`

### **Regla clave**

El mayor **se puede recalcular**,  
 los asientos **NO**.

---

## **ğŸ§± TRAZABILIDAD TOTAL**

`Reporte`  
  `â†“`  
`Mayor`  
  `â†“`  
`Cuenta`  
  `â†“`  
`JournalLine`  
  `â†“`  
`JournalEntry`  
  `â†“`  
`Evento ERP`

Si esta cadena se rompe â†’ **dato invÃ¡lido**.

---

## **ğŸš« ZONAS PROHIBIDAS (EXPLÃCITO)**

`UI â”€Xâ†’ Asientos`  
`UI â”€Xâ†’ Mayor`  
`ERP â”€Xâ†’ Mayor`  
`ERP â”€Xâ†’ Contabilidad directa`  
`Mayor â”€Xâ†’ ERP`

No hay excepciones.

---

## **ğŸ” AUTORIZACIÃ“N (RESUMEN)**

* ERP:

  * roles operativos

* ACCCORE:

  * solo sistema \+ roles contables

* Mayor:

  * solo lectura

* Cierres:

  * solo owner

---

---

# **ğŸ“˜ CHECKLIST â€” IMPLEMENTACIÃ“N CONTABLE (ACCCORE)**

**FASE 3 â€” Control de implementaciÃ³n â€” Sin cÃ³digo**

---

## **ğŸ§± 0ï¸âƒ£ REGLAS BASE (GATE INICIAL)**

Si algo de este bloque falla â†’ **NO IMPLEMENTAR CONTABILIDAD**.

* ERP implementado y estable (FASE 2 cerrada)

* Eventos ERP cerrados e inmutables

* AuditorÃ­a operativa funcionando

* No existe contabilidad en ERP

* No existe UI contable directa

---

## **ğŸ§± 1ï¸âƒ£ MODELO CONTABLE BASE**

* Entidad **Account**

* Entidad **AccountingPeriod**

* Entidad **JournalEntry**

* Entidad **JournalLine**

* RelaciÃ³n evento ERP â†’ asiento

* Sin borrado fÃ­sico

* Sin ediciÃ³n de asientos

---

## **ğŸ§± 2ï¸âƒ£ PLAN DE CUENTAS**

* Plan Ãºnico por empresa

* Estructura jerÃ¡rquica

* Tipos de cuenta definidos

* Cuentas activas / archivadas

* Bloqueo de ediciÃ³n en cuentas usadas

* AuditorÃ­a de cambios estructurales

---

## **ğŸ§± 3ï¸âƒ£ PERIODOS CONTABLES**

* Periodos mensuales

* Sin solapamiento

* Estados (`open`, `closed`)

* Periodo Ãºnico por fecha

* ValidaciÃ³n de periodo abierto

* AuditorÃ­a de cambios de estado

---

## **ğŸ§± 4ï¸âƒ£ EVENTO DE APERTURA CONTABLE**

* Evento `accounting_opening_event`

* Ejecutable una sola vez

* Genera asientos iniciales

* Debe \= Haber

* Solo `owner`

* AuditorÃ­a reforzada

---

## **ğŸ§± 5ï¸âƒ£ MOTOR DE ASIENTOS**

* Listener de eventos ERP

* ValidaciÃ³n de evento

* Idempotencia

* TraducciÃ³n evento â†’ asiento

* Asientos espejo para reversiones

* Rechazo auditado

---

## **ğŸ§± 6ï¸âƒ£ VALIDACIONES CONTABLES**

Antes de postear:

* Debe \= Haber

* Cuentas activas

* Periodo abierto

* Empresa correcta

* Evento no procesado

* Moneda vÃ¡lida

---

## **ğŸ§± 7ï¸âƒ£ CIERRES CONTABLES**

* Proceso de cierre

* Validaciones pre-cierre

* Bloqueo post-cierre

* Evento `period_closed`

* Reapertura solo `owner`

* AuditorÃ­a reforzada

---

## **ğŸ§± 8ï¸âƒ£ AJUSTES POST-CIERRE**

* Ajustes solo en periodos futuros

* Evento explÃ­cito

* Sin modificaciÃ³n del pasado

* AuditorÃ­a

---

## **ğŸ§± 9ï¸âƒ£ MAYOR CONTABLE**

* Derivado de asientos

* Recalculable

* No editable

* Por cuenta

* Por periodo

* Trazabilidad completa

---

## **ğŸ§± ğŸ”Ÿ TRAZABILIDAD TOTAL**

* Evento ERP â†’ Asiento

* Asiento â†’ LÃ­nea

* LÃ­nea â†’ Cuenta

* Cuenta â†’ Mayor

* Mayor â†’ Reportes

Si algÃºn eslabÃ³n falta â†’ **dato invÃ¡lido**.

---

## **ğŸ§± 1ï¸âƒ£1ï¸âƒ£ AUTORIZACIÃ“N**

* Roles contables definidos

* Admin sin acceso contable

* Member / Viewer sin acceso

* Owner con control total

* Denegaciones auditadas

---

## **ğŸ§± 1ï¸âƒ£2ï¸âƒ£ AUDITORÃA CONTABLE**

* AuditorÃ­a de asientos

* AuditorÃ­a de cierres

* AuditorÃ­a de reaperturas

* AuditorÃ­a de rechazos

* AuditorÃ­a inmutable

---

## **ğŸš¨ CRITERIOS DE BLOQUEO**

No avanzar si:

* hay asientos editables

* hay borrado fÃ­sico

* hay UI contable directa

* hay lÃ³gica contable en ERP

* hay bypass de cierres

* hay correcciÃ³n del pasado

---

## **âœ… CRITERIO DE â€œCONTABILIDAD LISTAâ€**

La contabilidad se considera **lista** solo si:

* todos los Ã­tems estÃ¡n completos

* no hay TODOs

* no hay atajos

* documentaciÃ³n alineada

* auditorÃ­a verificable

---

---

# **ğŸ“˜ FASE 3 â€” ACCCORE (CONTABILIDAD)**

## **DOCUMENTO COMPLEMENTARIO â€” EVENTO DE AJUSTE CONTABLE**

**Contrato de arquitectura â€” Sin cÃ³digo**

---

## **ğŸ¯ OBJETIVO**

Definir **cÃ³mo se corrigen errores contables** en ACCCORE sin:

* editar asientos existentes

* reabrir periodos innecesariamente

* romper trazabilidad

* violar cierres contables

ğŸ‘‰ **Todo ajuste es un evento nuevo**, nunca una modificaciÃ³n del pasado.

---

## **ğŸ§± PRINCIPIO FUNDAMENTAL**

**EL PASADO NO SE CORRIGE, SE COMPENSA**

La contabilidad avanza por eventos, no por ediciÃ³n.

---

## **ğŸ§± EVENTO `accounting_adjustment_event`**

### **DefiniciÃ³n**

Evento explÃ­cito que representa una **correcciÃ³n contable controlada**, aplicada:

* en un **periodo abierto**

* sobre **errores detectados**

* sin modificar asientos originales

---

## **ğŸ§± CUÃNDO SE USA**

* error de imputaciÃ³n de cuenta

* diferencia detectada post-cierre

* reclasificaciÃ³n contable

* ajuste por redondeo

* correcciÃ³n de criterio contable

---

## **ğŸ§± CUÃNDO NO SE USA**

âŒ para corregir hechos operativos  
 âŒ para â€œarreglar nÃºmerosâ€  
 âŒ para anular eventos ERP  
 âŒ para modificar periodos cerrados  
 âŒ como reemplazo de reversiones

---

## **ğŸ§± RELACIÃ“N CON CIERRES**

* El ajuste:

  * **nunca** se aplica en un periodo cerrado

  * siempre se registra en el **periodo actual**

* El periodo cerrado permanece intacto

---

## **ğŸ§± CONTENIDO DEL EVENTO**

Conceptualmente incluye:

* empresa

* fecha del ajuste

* periodo contable actual

* motivo obligatorio

* referencia a asientos afectados (informativo)

* usuario responsable

---

## **ğŸ§± GENERACIÃ“N DE ASIENTOS DE AJUSTE**

El motor contable traduce el evento en:

* uno o mÃ¡s asientos

* balanceados

* claramente identificados como **ajuste**

Ejemplo conceptual:

`Debe: Gasto mal imputado`  
`Haber: Cuenta correcta`

âš ï¸ El asiento original **no se toca**.

---

## **ğŸ§± VALIDACIONES PREVIAS**

Antes de aceptar el evento:

* Periodo abierto

* Debe \= Haber

* Cuentas vÃ¡lidas

* Motivo presente

* Usuario autorizado

Si falla algo â†’ **RECHAZO \+ AUDITORÃA**

---

## **ğŸ§± AUDITORÃA REFORZADA**

Debe registrarse:

* evento de ajuste

* usuario

* fecha

* motivo

* asientos generados

* referencias histÃ³ricas

Este evento **no puede ocultarse**.

---

## **ğŸ§± AUTORIZACIÃ“N**

* Crear ajuste:

  * `accounting_admin`

* Ejecutar cierre posterior:

  * `owner`

Admin:

* âŒ no puede ajustar periodos cerrados

* âŒ no puede borrar ajustes

---

## **ğŸ§± PROHIBICIONES ABSOLUTAS**

* âŒ Editar asientos originales

* âŒ Ajustar en periodos cerrados

* âŒ Usar ajustes para corregir ERP

* âŒ Omitir motivo

* âŒ Borrar eventos de ajuste

---

## **ğŸ§± TRAZABILIDAD**

`Error â†’ Adjustment Event â†’ Asiento de Ajuste â†’ Mayor`

El historial completo **queda visible**.

---

## **ğŸ§± CASO ESPECIAL â€” AJUSTES MENORES**

Diferencias mÃ­nimas:

* redondeos

* centavos

* ajustes tÃ©cnicos

Se permiten:

* solo mediante evento

* solo con motivo

* solo en periodo abierto

Nunca silenciosos.

---

## **âœ… RESULTADO**

Con este evento:

* el sistema permite correcciones

* sin romper cierres

* sin reescribir historia

* con auditorÃ­a completa

---

---

# **ğŸ“˜ FASE 3 â€” ACCCORE (CONTABILIDAD)**

## **POLÃTICA DE MIGRACIÃ“N HISTÃ“RICA**

**Contrato de arquitectura â€” Sin cÃ³digo**

---

## **ğŸ¯ OBJETIVO**

Definir **cÃ³mo migrar informaciÃ³n histÃ³rica** desde sistemas externos a ACCCORE sin:

* reescribir el pasado

* inventar asientos

* romper cierres

* perder trazabilidad

* mezclar contabilidad vieja con nueva

ğŸ‘‰ La migraciÃ³n **delimita pasado externo vs contabilidad viva**.

---

## **ğŸ§± PRINCIPIO FUNDAMENTAL**

**EL SISTEMA NO â€œIMPORTA CONTABILIDADâ€,**  
 **IMPORTA UN ESTADO CONTABLE INICIAL**

ACCCORE **no reproduce** la historia completa de otros sistemas.  
 ACCCORE **arranca desde un punto cero explÃ­cito**.

---

## **ğŸ§± ESTRATEGIAS DE MIGRACIÃ“N PERMITIDAS**

Solo existen **DOS** estrategias vÃ¡lidas.

---

## **ğŸ…°ï¸ ESTRATEGIA A â€” MIGRACIÃ“N POR SALDOS (RECOMENDADA)**

### **Concepto**

* Se migran **saldos finales consolidados**

* No se migran asientos histÃ³ricos

* El pasado queda **fuera del sistema**

---

### **Proceso**

1. Extraer balance final del sistema anterior

2. Validar consistencia externa

3. Ejecutar `accounting_opening_event`

4. Generar asientos iniciales

5. Comenzar contabilidad viva en ACCCORE

---

### **Ventajas**

* limpia

* rÃ¡pida

* auditable

* sin deuda tÃ©cnica

* sin contaminar el sistema

---

### **Desventajas**

* no se navega detalle histÃ³rico interno

* el pasado queda como referencia externa

---

## **ğŸ…±ï¸ ESTRATEGIA B â€” MIGRACIÃ“N POR EVENTOS CONSOLIDADOS (EXCEPCIONAL)**

### **Concepto**

* Se migran **eventos resumidos**

* No asientos uno a uno

* Se agrupa por periodo

---

### **Reglas duras**

* Un evento por periodo

* Evento explÃ­cito de tipo:

  * `historical_adjustment_event`

* Claramente marcado como migrado

* No editable

* No reversible

---

### **Uso permitido**

* exigencia legal

* auditorÃ­as especÃ­ficas

* necesidad contractual

âš ï¸ **No es MVP**, solo bajo justificaciÃ³n formal.

---

## **ğŸ§± ESTRATEGIA PROHIBIDA (IMPORTANTE)**

âŒ Importar asientos histÃ³ricos uno a uno  
 âŒ Importar movimientos sin evento  
 âŒ Mezclar fechas pasadas con periodos vivos  
 âŒ Editar el pasado para â€œhacerlo coincidirâ€  
 âŒ Simular historia dentro de ACCCORE

Esto **rompe el sistema**.

---

## **ğŸ§± EVENTO DE MIGRACIÃ“N**

### **Evento `accounting_opening_event`**

* Es el **Ãºnico** evento vÃ¡lido para iniciar

* Marca el lÃ­mite histÃ³rico

* Todo lo anterior es â€œexternoâ€

---

### **Metadata obligatoria**

* sistema de origen

* fecha de corte

* responsable

* referencia documental

---

## **ğŸ§± PERIODOS Y MIGRACIÃ“N**

* El primer periodo contable:

  * inicia despuÃ©s del corte

* Periodos anteriores:

  * **no existen** en ACCCORE

Esto es deliberado.

---

## **ğŸ§± AUDITORÃA DE MIGRACIÃ“N**

Debe registrarse:

* evento de apertura

* origen de datos

* fecha de corte

* responsable

* cuentas y saldos

* documentos de respaldo

La auditorÃ­a **nunca se borra**.

---

## **ğŸ§± VALIDACIONES PREVIAS A MIGRACIÃ“N**

Antes de ejecutar:

* Balance externo equilibrado

* Cuentas mapeadas al plan base

* IVA separado correctamente

* Periodo inicial abierto

* AutorizaciÃ³n owner

* DocumentaciÃ³n respaldatoria

Si falla algo â†’ **NO migrar**

---

## **ğŸ§± CASO: EMPRESA SIN HISTÃ“RICO**

* Se ejecuta evento de apertura

* Con todas las cuentas en cero

* Se audita igual

Esto evita â€œcontabilidad fantasmaâ€.

---

## **ğŸ§± CONSULTA DE HISTÃ“RICO EXTERNO**

El sistema **puede**:

* guardar PDFs

* adjuntar balances externos

* referenciar documentos

Pero:

* âŒ no los interpreta

* âŒ no los mezcla

* âŒ no los convierte en asientos

---

## **ğŸ§± TRAZABILIDAD**

`Sistema anterior`  
      `â†“`  
`Documento externo`  
      `â†“`  
`Evento de apertura`  
      `â†“`  
`Asientos iniciales`  
      `â†“`  
`Mayor`

No hay otra cadena vÃ¡lida.

---

## **ğŸ§± AUTORIZACIÃ“N**

* Ejecutar migraciÃ³n:

  * solo `owner`

* Nunca `admin`

* Nunca automÃ¡tica

* Nunca offline

---

## **ğŸš¨ RIESGOS EVITADOS CON ESTA POLÃTICA**

* doble contabilidad

* balances inconsistentes

* ajustes eternos

* cierres invÃ¡lidos

* auditorÃ­as fallidas

---

## **âœ… RESULTADO**

Con esta polÃ­tica:

* la migraciÃ³n es segura

* el sistema queda limpio

* el pasado queda delimitado

* ACCCORE arranca fuerte

---



===== ARCHIVO: ğŸ“˜ PERMISOS FINOS - ACL _ RBAC EXTENDIDO (MÃ“DULO TRANSVERSAL).md =====
# **ğŸ“˜ PERMISOS FINOS â€” ACL / RBAC EXTENDIDO (MÃ“DULO TRANSVERSAL)**

**Contrato de Arquitectura â€” Sin implementaciÃ³n â€” Sin cÃ³digo**

---

## **ğŸ¯ PROPÃ“SITO DEL MÃ“DULO**

Este mÃ³dulo define **quÃ© puede hacer cada usuario** dentro del sistema, de forma:

* granular

* auditable

* reproducible

* independiente del negocio

* independiente de la contabilidad

Los permisos finos **NO forman parte del Core**, **NO pertenecen al ERP**, y **NO son contabilidad**.

Son una **capa transversal**, apoyada sobre el Core.

---

## **ğŸ§± POSICIÃ“N EN LA ARQUITECTURA**

`1) Core Platform`  
`2) Permisos Finos (ACL / RBAC)`  
`3) ERP Operativo`  
`4) Contabilidad (ACCCORE)`

### **Dependencias**

* Depende de: Core Platform

* NO depende de: ERP, Contabilidad

* Es requerido por: ERP y Contabilidad

---

## **ğŸ§± PRINCIPIOS INMUTABLES**

### **1ï¸âƒ£ SeparaciÃ³n total de responsabilidades**

* Core â†’ identidad y pertenencia

* Permisos Finos â†’ autorizaciÃ³n

* ERP â†’ lÃ³gica operativa

* Contabilidad â†’ interpretaciÃ³n financiera

Nunca se mezclan.

---

### **2ï¸âƒ£ Permisos explÃ­citos**

Si una acciÃ³n no tiene permiso explÃ­cito:

* estÃ¡ prohibida

* no se infiere

* no se hereda implÃ­citamente

---

### **3ï¸âƒ£ EvaluaciÃ³n determinÃ­stica**

Dado:

* usuario

* empresa

* acciÃ³n

ğŸ‘‰ el resultado de autorizaciÃ³n es **siempre el mismo**.

---

### **4ï¸âƒ£ AuditorÃ­a obligatoria**

Toda decisiÃ³n relevante de autorizaciÃ³n:

* puede auditarse

* puede reproducirse

* puede explicarse

---

## **ğŸ§± COMPONENTES DEL MÃ“DULO**

---

### **ğŸ”¹ 1\) PERMISSIONS (Permisos atÃ³micos)**

Un permiso representa **una acciÃ³n concreta** del sistema.

Ejemplos:

* `jobs.view`

* `jobs.create`

* `jobs.update`

* `jobs.complete`

* `jobs.cancel`

* `invoices.issue`

* `invoices.void`

* `receipts.complete`

* `payments.execute`

* `accounting.view_reports`

* `accounting.post_entries`

* `settings.manage`

* `users.invite`

#### **Reglas**

* Son atÃ³micos

* No dependen del rol

* No dependen de la UI

* No contienen lÃ³gica

---

### **ğŸ”¹ 2\) PERMISSION GROUPS (opcional)**

Agrupan permisos por dominio funcional:

* Jobs

* Sales

* Purchases

* Invoices

* Accounting

* Configuration

* Security

Solo sirven para organizaciÃ³n y UI.

---

### **ğŸ”¹ 3\) ROLES FINOS (RBAC EXTENDIDO)**

Un rol fino es **un conjunto de permisos**, no una jerarquÃ­a.

Ejemplos:

* `erp_operator`

* `erp_manager`

* `finance_viewer`

* `finance_operator`

* `accounting_admin`

* `company_admin_extended`

#### **Reglas**

* Un rol **no hereda** de otro

* Los permisos se asignan explÃ­citamente

* Un rol puede cambiar sin afectar al Core

---

### **ğŸ”¹ 4\) ASIGNACIÃ“N DE ROLES FINOS POR EMPRESA**

Los roles finos se asignan **por empresa**, no globalmente.

Un mismo usuario puede ser:

---

## **ğŸ§© TABLA ACTUALIZADA â€” ROLES/PERMISOS (ACL/RBAC)**

> ConsolidaciÃ³n de polÃ­ticas de autorizaciÃ³n aplicables a permisos finos.

| Regla | DescripciÃ³n |
|---|---|
| Roles gruesos **no otorgan** permisos finos | El rol grueso solo limita el universo posible. |
| Hardâ€‘deny por rol grueso | Si el rol grueso prohÃ­be, **DENY** aunque haya rol fino. |
| Permiso explÃ­cito requerido | Si no existe permiso atÃ³mico explÃ­cito â†’ **DENY**. |
| Sin herencia implÃ­cita | NingÃºn rol fino hereda de otro. |
| Overrides explÃ­citos | Si estÃ¡n definidos, prevalecen. |
| AuditorÃ­a obligatoria | Toda denegaciÃ³n crÃ­tica y acciÃ³n de seguridad/contabilidad debe auditarse. |

---

## **âœ… CHECKLIST PREâ€‘IMPLEMENTACIÃ“N (ACL/RBAC)**

- [ ] SeparaciÃ³n de capas: ACL es transversal, no pertenece a Core/ERP/Contabilidad.
- [ ] Permisos **atÃ³micos** y **explÃ­citos** (si no existe â†’ DENY).
- [ ] Sin herencia implÃ­cita entre roles finos.
- [ ] Hardâ€‘deny por rol grueso aplicado antes de permisos finos.
- [ ] Overrides explÃ­citos definidos y auditables.
- [ ] AuditorÃ­a obligatoria en denegaciones crÃ­ticas y acciones sensibles.

---

## **ğŸ§­ REGLAS EXACTAS PARA BACKEND (POLICIES/ACL)**

1. Validar `X-Company-Id` y membership activa.
2. Evaluar **rol grueso** â†’ aplicar hardâ€‘deny si corresponde.
3. Evaluar **roles finos** asignados por empresa.
4. Verificar **permiso atÃ³mico explÃ­cito**.
5. Resolver **overrides explÃ­citos** (si existen).
6. Registrar auditorÃ­a en denegaciones crÃ­ticas y acciones sensibles.
7. Resultado final: **ALLOW** o **DENY** determinÃ­stico.

* `erp_manager` en Empresa A

* `finance_viewer` en Empresa B

Siempre respetando:

* membership activa

* empresa activa

---

### **ğŸ”¹ 5\) OVERRIDES POR USUARIO**

AdemÃ¡s del rol fino, se permiten:

* permisos adicionales

* revocaciones puntuales

Ejemplos:

* permitir `jobs.cancel` a un usuario puntual

* negar `accounting.post_entries` aunque el rol lo tenga

Los overrides:

* son explÃ­citos

* son auditables

* nunca implÃ­citos

---

## **ğŸ§± FLUJO DE EVALUACIÃ“N DE PERMISOS**

`1) Usuario autenticado`  
`2) Empresa activa`  
`3) Membership activa`  
`4) Rol grueso vÃ¡lido (Core)`  
`5) Rol fino asignado`  
`6) Overrides aplicados`  
`7) EvaluaciÃ³n del permiso solicitado`

Resultado:

* ALLOW

* DENY

Sin estados intermedios.

---

## **ğŸ§¾ AUDITORÃA DE AUTORIZACIÃ“N**

Se debe poder registrar:

* usuario

* empresa

* permiso evaluado

* resultado

* motivo

* timestamp

Especialmente para:

* acciones sensibles

* denegaciones crÃ­ticas

* cambios de configuraciÃ³n

---

## **ğŸ§± RELACIÃ“N CON ROLES GRUESOS (CORE)**

Roles del Core:

* owner

* admin

* member

* viewer

### **Regla dura**

Los roles gruesos:

* **no otorgan permisos finos automÃ¡ticamente**

* solo habilitan **posibilidad de asignaciÃ³n**

Ejemplo:

* `viewer` â†’ nunca puede recibir permisos de escritura

* `owner` â†’ puede recibir cualquier permiso fino

---

## **ğŸ§± RELACIÃ“N CON ERP Y CONTABILIDAD**

ERP y Contabilidad:

* **consultan** permisos

* **no los definen**

* **no los modifican**

Esto permite:

* agregar mÃ³dulos sin duplicar lÃ³gica

* auditar accesos

* cambiar permisos sin tocar negocio

---

## **ğŸ§± SCOPE DEL MÃ“DULO**

### **Incluye**

* permisos atÃ³micos

* roles finos

* asignaciÃ³n por empresa

* overrides

* auditorÃ­a

### **NO incluye**

* autenticaciÃ³n

* sesiones

* lÃ³gica de negocio

* contabilidad

* UI

---

## **ğŸ”’ ESTADO DEL DOCUMENTO**

* MÃ³dulo: Permisos Finos

* Tipo: Transversal

* Estado: DEFINIDO

* Modificable: solo agregando permisos nuevos

* EliminaciÃ³n de permisos existentes: âŒ prohibida

---

## **âœ… CONCLUSIÃ“N**

Este mÃ³dulo:

* evita mezclar identidad con negocio

* permite escalar sin deuda

* habilita multiempresa real

* protege auditorÃ­a y trazabilidad

* es compatible con cualquier ERP o mÃ³dulo futuro


===== ARCHIVO: ğŸ“˜ PERMISOS GRUESOS - POLÃTICAS DE AUTORIZACIÃ“N POR ROL GRUESO (CORE ROLES).md =====
# **ğŸ“˜ POLÃTICAS DE AUTORIZACIÃ“N POR ROL GRUESO (CORE ROLES)**

**Contrato de Arquitectura â€” Sin cÃ³digo â€” Sin implementaciÃ³n**

---

## **ğŸ¯ PROPÃ“SITO**

Este documento define **quÃ© estÃ¡ permitido y quÃ© estÃ¡ prohibido** para cada **rol grueso** del Core:

* `owner`  
* `admin`  
* `member`  
* `viewer`

Los roles gruesos **NO otorgan permisos finos directamente**.  
Definen **lÃ­mites mÃ¡ximos**, **restricciones duras** y **capacidades de asignaciÃ³n**.

---

## **ğŸ§± PRINCIPIOS INMUTABLES**

1. Los roles gruesos **no ejecutan acciones**  
2. Los roles gruesos **limitan el universo de permisos finos posibles**  
3. NingÃºn rol fino puede violar la polÃ­tica del rol grueso  
4. El Core **no conoce permisos finos**, solo polÃ­ticas  
5. Toda violaciÃ³n â†’ **DENY** \+ evento auditable

---

## **ğŸ§­ CAPAS DE DECISIÃ“N**

Rol Grueso (Core)  
        â†“ limita  
Roles Finos (ACL)  
        â†“ combinan  
Permisos AtÃ³micos

Si una acciÃ³n no estÃ¡ permitida por el **rol grueso**,  
**no importa** quÃ© rol fino tenga el usuario â†’ **DENY**.

---

## **ğŸ‘‘ ROL: OWNER**

### **ğŸ¯ PropÃ³sito**

Control total de la empresa.  
Responsable legal y operativo.

---

### **âœ… Puede**

* Asignar **cualquier rol fino**  
* Ejecutar **cualquier permiso fino**  
* Administrar usuarios y memberships  
* Modificar configuraciÃ³n de empresa  
* Acceder a ERP completo  
* Acceder a contabilidad completa  
* Cerrar y reabrir perÃ­odos contables  
* Ver y exportar auditorÃ­a  
* Delegar permisos  
* Transferir ownership

---

### **âŒ No puede**

* Eliminar fÃ­sicamente datos  
* Eliminar auditorÃ­a  
* Romper regla 4equim  
* Dejar la empresa sin owner

---

### **ğŸ”’ Restricciones duras**

* Siempre debe existir **al menos un owner**  
* Todas las acciones crÃ­ticas son auditadas

---

## **ğŸ›  ROL: ADMIN**

### **ğŸ¯ PropÃ³sito**

GestiÃ³n operativa y administrativa de la empresa.

---

### **âœ… Puede**

* Asignar **roles finos no crÃ­ticos**  
* Operar ERP completo  
* Gestionar jobs, ventas, compras  
* Emitir invoices  
* Gestionar cobros y pagos  
* Ver reportes operativos  
* Ver auditorÃ­a (solo lectura)

---

### **âŒ No puede**

* Asignar permisos contables crÃ­ticos  
* Cerrar o reabrir perÃ­odos contables  
* Modificar reglas contables  
* Eliminar owners  
* Transferir ownership  
* Cambiar polÃ­ticas de autorizaciÃ³n

---

### **ğŸ”’ Restricciones duras**

* No puede auto-elevarse a owner  
* No puede modificar polÃ­ticas de rol grueso

---

## **ğŸ‘· ROL: MEMBER**

### **ğŸ¯ PropÃ³sito**

EjecuciÃ³n operativa.

---

### **âœ… Puede**

* Ejecutar acciones **solo si tiene rol fino compatible**  
* Operar jobs  
* Registrar tiempos  
* Crear operaciones borrador  
* Subir y asociar archivos  
* Ver informaciÃ³n operativa propia

---

### **âŒ No puede**

* Asignar roles (finos o gruesos)  
* Cancelar operaciones crÃ­ticas  
* Emitir invoices  
* Confirmar ventas/compras  
* Acceder a contabilidad  
* Ver auditorÃ­a  
* Cambiar configuraciÃ³n de empresa

---

### **ğŸ”’ Restricciones duras**

* Nunca puede recibir permisos contables  
* Nunca puede administrar usuarios

---

## **ğŸ‘€ ROL: VIEWER**

### **ğŸ¯ PropÃ³sito**

Lectura y observaciÃ³n.

---

### **âœ… Puede**

* Ver informaciÃ³n permitida  
* Ver jobs, ventas, invoices (read-only)  
* Ver reportes operativos bÃ¡sicos

---

### **âŒ No puede**

* Crear, modificar o cancelar nada  
* Registrar tiempos  
* Subir archivos  
* Ver contabilidad  
* Ver auditorÃ­a  
* Gestionar usuarios  
* Ejecutar acciones

---

### **ğŸ”’ Restricciones duras**

* Todos los permisos deben ser `.view`  
* Cualquier permiso de escritura â†’ DENY

---

## **ğŸ§± MATRIZ RESUMEN**

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
â”‚ AcciÃ³n â”‚ Owner    â”‚ Admin    â”‚ Member   â”‚ Viewer   â”‚  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ ERP    â”‚ FULL     â”‚ FULL     â”‚ LIMITADO â”‚ READ     â”‚  
â”‚ ACL    â”‚ FULL     â”‚ PARCIAL  â”‚ NO       â”‚ NO       â”‚  
â”‚ Contab â”‚ FULL     â”‚ NO       â”‚ NO       â”‚ NO       â”‚  
â”‚ Audit  â”‚ FULL     â”‚ READ     â”‚ NO       â”‚ NO       â”‚  
â”‚ Config â”‚ FULL     â”‚ LIMITED  â”‚ NO       â”‚ NO       â”‚  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

---

## **ğŸ§© TABLA ACTUALIZADA â€” ROLES GRUESOS Y LÃMITES**

> ConsolidaciÃ³n de lÃ­mites duros y capacidades mÃ¡ximas. Los roles gruesos **no** otorgan permisos finos.

| Rol grueso | LÃ­mite duro (hardâ€‘deny) | Capacidades mÃ¡ximas permitidas | AsignaciÃ³n de roles finos |
|---|---|---|---|
| **owner** | No puede eliminar datos fÃ­sicos, eliminar auditorÃ­a, romper 4equim, dejar empresa sin owner | Acceso total a ERP, contabilidad completa, cierres contables, auditorÃ­a, configuraciÃ³n, usuarios | Puede asignar **cualquier rol fino** |
| **admin** | No puede permisos contables crÃ­ticos, cerrar/reabrir perÃ­odos, modificar reglas contables, eliminar owners, transferir ownership | ERP completo, gestiÃ³n operativa, invoices, cobros/pagos, reportes operativos, auditorÃ­a solo lectura | Puede asignar **roles finos no crÃ­ticos** |
| **member** | Sin contabilidad, sin gestiÃ³n de usuarios, sin roles, sin acciones crÃ­ticas | OperaciÃ³n limitada, jobs, tiempos, borradores, archivos, info operativa propia | **No** asigna roles finos |
| **viewer** | Solo lectura; cualquier permiso de escritura â†’ DENY | Lectura operativa bÃ¡sica (jobs/ventas/invoices read-only) | **No** asigna roles finos |

---

## **âœ… CHECKLIST PREâ€‘IMPLEMENTACIÃ“N (ROLES GRUESOS)**

- [ ] Los roles gruesos **no** otorgan permisos finos.
- [ ] Hardâ€‘deny aplicado **antes** de evaluar roles finos.
- [ ] `viewer` es **solo lectura** (cualquier escritura â†’ DENY).
- [ ] `member` sin contabilidad y sin gestiÃ³n de usuarios.
- [ ] `admin` sin permisos contables crÃ­ticos.
- [ ] `owner` con bypass explÃ­cito de ACL.
- [ ] AuditorÃ­a obligatoria en acciones crÃ­ticas y denegaciones relevantes.
- [ ] SeparaciÃ³n de capas Core â‰  ACL â‰  ERP â‰  Contabilidad.

## **ğŸ§¾ AUDITORÃA DE POLÃTICAS**

Debe auditarse:

* asignaciÃ³n de rol grueso  
* asignaciÃ³n de rol fino  
* cambios de roles  
* intentos bloqueados por polÃ­tica  
* intentos de elevaciÃ³n indebida

---

## **ğŸ”’ REGLAS FINALES**

* Los roles gruesos **nunca cambian dinÃ¡micamente**  
* Los permisos finos **nunca rompen polÃ­ticas**  
* Toda evaluaciÃ³n es determinÃ­stica  
* Toda denegaciÃ³n crÃ­tica es auditable  
* No hay excepciones implÃ­citas

---

## **âœ… CONCLUSIÃ“N**

Con estas polÃ­ticas:

* El Core mantiene el control  
* ACL es flexible pero segura  
* ERP no conoce seguridad  
* Contabilidad queda protegida  
* El sistema es escalable  
* No hay escalamiento indebido  
* No hay deuda conceptual


