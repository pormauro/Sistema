===== ARCHIVO: FASES.md =====
üß± 1) N√öCLEO (Core Platform)
üìå Identidad, seguridad, multiempresa, auditor√≠a, archivos.

Es el cimiento obligatorio.

Incluye:

Users

User Security Events

User Sessions

Companies

Memberships

Roles

Legal Acceptances

Audit Log

Company Settings

Files + File Links

Instalaci√≥n inicial

Login / Logout

Regla 4equim

Estados l√≥gicos

Multiempresa real

üëâ Sin esto, no existe SISA.
Sin esto, no pod√©s construir ERP.
Sin esto, no pod√©s garantizar contabilidad.

Este m√≥dulo SIEMPRE VA PRIMERO.

üìò 2) NEGOCIO (ERP Operativo)
üìå Registra hechos reales, NO los interpreta contablemente.

Ac√° va todo lo operativo del d√≠a a d√≠a:

Jobs (√≥rdenes de trabajo)

Job Time Entries

Job Checklist Items

Quotes

Sales

Purchases

Invoices

Receipts

Payments

Adjustments

Estados, lifecycles, auditor√≠as

Validaciones cruzadas ERP

üëâ Fase 2 produce eventos operativos inmutables.
These events are the raw material of accounting.

Este m√≥dulo SIEMPRE VA DESPU√âS DEL N√öCLEO
y SIEMPRE VA ANTES de la contabilidad.

Si lo invert√≠s ‚Üí te explota la consistencia temporal.

üìô 3) CONTABILIDAD (ACCCORE ‚Äì Fase 3)
üìå Interpreta los eventos operativos del ERP y produce informaci√≥n contable real.

Incluye:

Plan de cuentas

Asientos contables

Centros de costo

IVA

Percepciones / Retenciones

Cierres contables

Mayor anal√≠tico

Balance, PyG

Devengamientos

Contabilidad por empresa

Auditor√≠a contable

Reglas fiscales

üëâ Contabilidad NO puede existir antes del ERP.
NUNCA se generan asientos directamente desde m√≥dulos operativos.
SIEMPRE debe hacerse desde eventos auditables.

üéØ Resumen brutalmente claro
‚úî 1) CORE

Fundaci√≥n del sistema
(lo que hace posible todo)

‚úî 2) NEGOCIO / ERP

Registra hechos
(no interpreta nada)

‚úî 3) CONTABILIDAD

Interpreta hechos ‚Üí genera asientos

üéØ Orden obligatorio

1Ô∏è‚É£ Core Platform
2Ô∏è‚É£ ERP Operativo (Negocio)
3Ô∏è‚É£ Contabilidad (ACCCORE)

===== ARCHIVO: offline-events.md =====
# Offline Events Queue ‚Äî SISA

## üéØ Objetivo

Definir el **modelo de cola de eventos offline** utilizado por SISA para registrar acciones realizadas sin conectividad y sincronizarlas de forma **segura**, **auditable** y **determinista**.

Esta cola es la **√∫nica v√≠a v√°lida** para introducir cambios offline al sistema.

---

## üß† Principios no negociables

- La cola es **append-only**
- Los eventos **no se editan**
- Los eventos **no se eliminan**
- El servidor es la **fuente de verdad final**
- El orden importa
- La validaci√≥n siempre ocurre **en el servidor**

---

## üß± Concepto central

Un **Offline Event** representa **una acci√≥n del usuario**, no un estado final.

Ejemplo:
- ‚úî ‚ÄúEl usuario inici√≥ el trabajo‚Äù
- ‚ùå ‚ÄúEl trabajo qued√≥ en progreso‚Äù

---

## üßæ Estructura l√≥gica de un Offline Event

Cada evento contiene:

- `event_id` ‚Äî UUID √∫nico
- `entity_type` ‚Äî Job, ChecklistItem, TimeEntry, File
- `entity_id` ‚Äî ID de la entidad afectada
- `action` ‚Äî Acci√≥n ejecutada
- `payload` ‚Äî Datos m√≠nimos necesarios
- `actor_user_id`
- `company_id`
- `device_id`
- `local_timestamp`
- `sequence_number`
- `status` ‚Äî pending / synced / rejected
- `hash` ‚Äî integridad del evento

---

## üßÆ Orden y secuencia

- Cada dispositivo mantiene un `sequence_number` incremental
- El servidor valida:
  - duplicados
  - saltos de secuencia
  - reenv√≠os
- El orden de procesamiento es **estricto por dispositivo**

---

## üîÑ Tipos de eventos permitidos

### Jobs
- `job_started`
- `job_paused`
- `job_resumed`
- `job_note_added`

### Checklists
- `checklist_item_completed`
- `checklist_item_failed`
- `checklist_item_note_added`

### Tiempos
- `time_entry_started`
- `time_entry_stopped`
- `time_entry_corrected`

### Archivos
- `file_captured`
- `file_metadata_updated`

---

## ‚ùå Eventos expl√≠citamente prohibidos offline

- `job_completed`
- `job_cancelled`
- `accounting_entry_created`
- `invoice_created`
- `user_created`
- `role_changed`

Estos eventos **solo existen online**.

---

## üîç Validaci√≥n en el servidor

Cada evento es validado contra:

- Estado actual de la entidad
- M√°quina de estados
- Permisos del usuario
- Empresa activa
- Consistencia temporal
- Duplicaci√≥n

Resultado:
- **Aceptado** ‚Üí aplicado + marcado como synced
- **Rechazado** ‚Üí marcado como rejected + auditado

---

## ‚ö†Ô∏è Manejo de conflictos

Ejemplos:
- Evento aplicado sobre estado inv√°lido
- Evento duplicado
- Evento fuera de orden

Regla:
- El evento **no se reintenta autom√°ticamente**
- Se registra el rechazo
- Se notifica al usuario

---

## üßæ Auditor√≠a

Cada evento queda registrado con:

- Payload original
- Timestamps (local + server)
- Resultado de validaci√≥n
- Motivo de rechazo (si aplica)

Nunca se borra.

---

## üß± Persistencia local

- Base local (SQLite / almacenamiento seguro)
- Cola transaccional
- Confirmaci√≥n expl√≠cita de sync
- Soporte para reintentos manuales

---

## üîê Seguridad

- Eventos firmados con hash
- Asociados a dispositivo y usuario
- No se aceptan eventos sin autenticaci√≥n previa v√°lida

---

## ‚úÖ Conclusi√≥n

La cola de eventos offline en SISA:

- No intenta ‚Äúrecrear estados‚Äù
- No corrige el pasado
- No asume autoridad

Solo **narra hechos**.

El servidor decide qu√© hechos son v√°lidos.

---


===== ARCHIVO: offline-scope-boundary.md =====
# Offline Scope Boundary ‚Äî SISA

## üéØ Objetivo

Definir **l√≠mites expl√≠citos e inquebrantables** sobre qu√© **nunca** puede implementarse en modo offline dentro de SISA.

Este documento existe para:
- prevenir degradaci√≥n arquitect√≥nica
- evitar ‚Äúexcepciones c√≥modas‚Äù
- proteger el core del sistema a largo plazo

---

## üß† Principio absoluto

> **El offline no define verdad, solo registra intentos.**

Cualquier funcionalidad que contradiga este principio  
**queda autom√°ticamente fuera de alcance**.

---

## üö´ Categor√≠as prohibidas para Offline

Las siguientes categor√≠as **no pueden** operar offline, **bajo ning√∫n escenario**.

---

### 1Ô∏è‚É£ Dinero y contabilidad

Incluye (sin excepci√≥n):

- Asientos contables
- Pagos
- Cobros
- Facturaci√≥n
- Notas de cr√©dito / d√©bito
- Cierres contables
- Ajustes de balance
- Reversiones financieras

**Motivo**
- Riesgo legal
- Riesgo fiscal
- Dependencias cruzadas
- Impacto irreversible

‚ùå Nunca offline  
‚ùå Nunca ‚Äúmodo borrador‚Äù offline  
‚ùå Nunca sincronizaci√≥n diferida

---

### 2Ô∏è‚É£ Estados terminales

Estados finales o irreversibles:

- `completed`
- `cancelled`
- `closed`
- `archived`

**Motivo**
- Disparan efectos colaterales
- Pueden cerrar flujos contables u operativos
- Definen historia final

‚úî Pueden **proponerse** offline  
‚ùå Nunca confirmarse offline

---

### 3Ô∏è‚É£ Datos maestros estructurales

Incluye:

- Empresas
- Clientes
- Proveedores
- Productos / servicios
- Carpetas ra√≠z
- Configuraci√≥n global
- Cat√°logos base

**Motivo**
- Alta dependencia
- Riesgo de duplicaci√≥n
- Rompen integridad referencial

‚ùå No se crean offline  
‚ùå No se editan offline  
‚ùå No se eliminan offline

---

### 4Ô∏è‚É£ Seguridad y permisos

Incluye:

- Creaci√≥n de usuarios
- Cambios de rol
- Asignaci√≥n de empresas
- Revocaci√≥n de accesos
- Pol√≠ticas de seguridad

**Motivo**
- Riesgo de escalamiento de privilegios
- Violaci√≥n de modelo de seguridad

‚ùå Nunca offline  
‚ùå Nunca cache editable

---

### 5Ô∏è‚É£ Configuraci√≥n del sistema

Incluye:

- Par√°metros globales
- Reglas de negocio
- M√°quinas de estado
- Flags de comportamiento

**Motivo**
- Cambios sist√©micos
- Impacto transversal
- Dif√≠cil rollback

---

## ‚ö†Ô∏è Zonas grises expl√≠citamente cerradas

Las siguientes ideas **parecen razonables**, pero est√°n **prohibidas**:

- ‚ÄúModo borrador offline‚Äù para facturas
- ‚ÄúPre-crear clientes offline‚Äù
- ‚ÄúCerrar trabajos offline y confirmar despu√©s‚Äù
- ‚ÄúEditar permisos sin conexi√≥n‚Äù
- ‚ÄúSincronizar contabilidad al reconectar‚Äù

Si alguien propone esto:
üëâ la respuesta es **NO**.

---

## ‚úÖ Categor√≠as permitidas Offline (recordatorio)

El offline **solo** se admite para:

- Registro de acciones operativas
- Checklists
- Tiempos trabajados
- Archivos y evidencias
- Observaciones
- Lectura de datos de referencia

Siempre bajo:
- cola de eventos
- validaci√≥n server-side
- auditor√≠a

---

## üß± Regla de decisi√≥n r√°pida

Ante cualquier feature nueva, preguntarse:

1. ¬øAfecta dinero?
2. ¬øDefine una verdad del sistema?
3. ¬øCambia permisos o estructura?
4. ¬øEs irreversible?

Si la respuesta es **s√≠** a cualquiera:
üëâ **No es offline**.

---

## üîê Autoridad final

- Este documento **tiene prioridad** sobre:
  - decisiones de UX
  - pedidos comerciales
  - conveniencias t√©cnicas
- Ninguna feature puede violarlo sin **romper SISA**

---

## ‚úÖ Conclusi√≥n

El offline en SISA:

- es acotado
- es consciente
- es responsable
- es defendible

Este boundary existe para que el sistema **no se desarme con el tiempo**.

---


===== ARCHIVO: offline-strategy.md =====
# Offline Strategy ‚Äî SISA

## üéØ Objetivo

Definir **cu√°ndo**, **d√≥nde** y **por qu√©** SISA aplica el enfoque **offline-first**, evitando inconsistencias, riesgos contables o violaciones de reglas de negocio.

SISA **no es offline-first por defecto**.  
Es **offline-inteligente**.

---

## üß† Principio rector

> **Si el dato representa un hecho ocurrido ‚Üí puede ser offline-first**  
> **Si el dato representa una verdad del sistema ‚Üí es online-only**

Este principio gobierna todas las decisiones offline del sistema.

---

## ‚úÖ Casos donde S√ç aplica Offline-first

### 1. Jobs en ejecuci√≥n

**Contexto**  
Operaci√≥n en campo con conectividad inestable o inexistente.

**Acciones permitidas offline**
- Visualizaci√≥n de Jobs asignados
- Transiciones operativas:
  - `planned ‚Üí in_progress`
  - `in_progress ‚Üí paused`
- Registro de observaciones
- Asociaci√≥n de participantes
- Registro de tramos horarios
- Adjuntar archivos

**Estrategia**
- Cache local estructurada
- Cola de eventos append-only
- Sincronizaci√≥n diferida con validaci√≥n de estado

---

### 2. Checklists / Consignas operativas

**Descripci√≥n**
- √çtems ejecutables
- Pueden realizarse m√∫ltiples veces por Job
- Asociados al momento real de ejecuci√≥n

**Offline**
- Ejecuci√≥n completa offline
- Persistencia local con timestamp real
- Sincronizaci√≥n posterior

---

### 3. Tiempos trabajados

**Caracter√≠sticas**
- Registro de inicio / fin
- M√∫ltiples tramos por Job
- Correcciones permitidas con historial

**Offline**
- Captura local
- Validaci√≥n en sincronizaci√≥n
- Nunca se pisa historial existente

---

### 4. Captura de archivos

**Ejemplos**
- Fotos de equipos
- Videos de fallas
- Evidencias t√©cnicas

**Flujo**
1. Guardado local
2. Asociaci√≥n de metadata
3. Upload diferido
4. Vinculaci√≥n al Job / checklist correspondiente

---

### 5. Datos de referencia (solo lectura)

**Ejemplos**
- Clientes
- Productos / servicios
- Carpetas
- Estados v√°lidos

**Restricci√≥n**
- Lectura offline permitida
- Creaci√≥n y edici√≥n **solo online**

---

## ‚ùå Casos donde NO aplica Offline-first

### 1. Contabilidad

**Prohibido offline**
- Asientos contables
- Pagos
- Facturaci√≥n
- Cierres
- Ajustes

**Motivo**
- Riesgo financiero
- Riesgo legal
- Alta dependencia cruzada

---

### 2. Estados finales de Jobs

Estados:
- `completed`
- `cancelled`

**Regla**
- Nunca se confirman offline
- Pueden proponerse, pero requieren validaci√≥n online

---

### 3. Usuarios y permisos

**Incluye**
- Creaci√≥n de usuarios
- Asignaci√≥n de roles
- Vinculaci√≥n a empresas

**Motivo**
- Riesgo de escalamiento de privilegios
- Seguridad del sistema

---

### 4. Datos maestros estructurales

**Ejemplos**
- Empresas
- Clientes / proveedores
- Productos / servicios
- Configuraci√≥n global
- Estructuras contables

**Regla**
- Siempre online

---

## üß± Pol√≠tica de sincronizaci√≥n

- Todos los eventos offline:
  - Son **append-only**
  - Nunca pisan datos existentes
  - Se validan contra el estado actual
- Conflictos:
  - Se rechazan eventos inv√°lidos
  - Se registran para auditor√≠a
- El servidor es la **fuente de verdad final**

---

## üîç Auditor√≠a

Cada evento offline sincronizado:
- Tiene timestamp local
- Tiene timestamp de servidor
- Guarda autor, contexto y entidad afectada
- Nunca se elimina

---

## ‚ö†Ô∏è Advertencias

- Offline-first mal aplicado **rompe sistemas**
- No se admiten ‚Äúexcepciones por comodidad‚Äù
- Si una acci√≥n afecta:
  - dinero
  - estructura
  - permisos  
  entonces **no es offline**

---

## ‚úÖ Conclusi√≥n

SISA aplica offline-first **solo donde agrega valor real**, sin comprometer:

- consistencia
- seguridad
- auditabilidad
- escalabilidad

Offline no es libertad.  
Es **responsabilidad controlada**.

---


===== ARCHIVO: README.md =====
# SISA ‚Äî Sistema Integrado de Servicios Administrativos

SISA es una **plataforma ERP modular**, dise√±ada para **empresas reales**, con foco en **trazabilidad total**, **control operativo**, **contabilidad s√≥lida** y **escalabilidad progresiva**.

No es un MVP de juguete.  
No es un clon liviano de otro sistema.  
Es un **core empresarial serio**, pensado para crecer sin romperse.

---

## üéØ Objetivo del sistema

Construir un **n√∫cleo administrativo y operativo** que permita:

- Gestionar **empresas, clientes y proveedores**
- Controlar **operaciones (Jobs)** con estados estrictos
- Registrar **consignas, checklists y ejecuci√≥n real**
- Manejar **tiempos trabajados**, participantes y recursos
- Integrar **contabilidad**, **facturaci√≥n** y **auditor√≠a**
- Escalar hacia **automatizaci√≥n, IA y an√°lisis avanzado**

SISA est√° pensado como **base estructural**, no como producto descartable.

---

## üß± Principios no negociables

- ‚ùå **Nada se borra f√≠sicamente**
- ‚úÖ Todo es **auditable**
- ‚úÖ Estados con **m√°quinas de estado estrictas**
- ‚ùå No hay ‚Äúexcepciones m√°gicas‚Äù
- ‚úÖ El sistema refleja la **realidad operativa**
- ‚úÖ Dise√±o orientado a **crecimiento y mantenimiento**

---

## üß© Arquitectura general

SISA se construye por **capas y m√≥dulos independientes**:

### Backend
- API REST
- Arquitectura desacoplada
- Validaciones duras
- Control de permisos por rol y empresa
- Registro hist√≥rico autom√°tico

### Frontend
- App m√≥vil + web
- Offline-first (cuando aplica)
- Sincronizaci√≥n controlada
- UI enfocada en operaci√≥n real, no en est√©tica vac√≠a

### Base de datos
- Modelo relacional estricto
- Historial por entidad
- Estados expl√≠citos
- Relaciones claras y no ambiguas

---

## üì¶ M√≥dulos principales

### üè¢ Empresas
- Multi-empresa real
- Usuarios con roles y permisos
- Ning√∫n usuario existe sin contexto empresarial

### üë• Clientes y Proveedores
- Son **referencias a Company**
- No se duplican datos
- Uso de `client_company_id` / `provider_company_id`

### üõ† Jobs (Operaciones)
- N√∫cleo operativo del sistema
- No contiene fechas ni horarios directos
- Se rige por **m√°quina de estados**
- Estados finales inmutables

Estados t√≠picos:
- planned
- in_progress
- paused
- completed
- cancelled

Transiciones inv√°lidas expl√≠citas (ejemplos):
- completed ‚Üí *
- cancelled ‚Üí *
- in_progress ‚Üí planned
- paused ‚Üí planned

### ‚úÖ Checklists / Consignas
- √çtems operativos ejecutables
- Asociados al momento real de ejecuci√≥n
- Permiten m√∫ltiples ejecuciones por Job
- Cada ejecuci√≥n puede tener distintos participantes

### ‚è± Tiempos y Horarios
- Tablas separadas de Jobs
- Registro real de inicio y fin
- M√∫ltiples tramos por trabajo
- Correcciones posibles **con historial**

### üìä Contabilidad
- Base contable s√≥lida
- Preparada para:
  - facturaci√≥n
  - pagos
  - reportes
  - cierres
- Dise√±ada como **core independiente**

### üìÅ Archivos
- Vinculados a entidades
- Metadata persistente
- Soporte offline
- Historial de cambios

---

## üîê Seguridad y control

- Autenticaci√≥n obligatoria
- Permisos por rol
- Acceso por empresa
- Registro de acciones cr√≠ticas
- Sin endpoints ‚Äúp√∫blicos‚Äù innecesarios

---

## üß† Filosof√≠a de dise√±o

SISA no intenta ‚Äúhacer todo r√°pido‚Äù.  
Intenta **hacer lo correcto primero**.

- Primero estructura
- Despu√©s velocidad
- Luego automatizaci√≥n
- Finalmente inteligencia (IA)

---

## üöÄ Estado del proyecto

SISA se encuentra en **desarrollo activo**, con foco en:

- Consolidaci√≥n del core
- Reglas duras
- Documentaci√≥n exhaustiva
- Base contable profesional

No se prioriza el marketing hasta que el sistema **aguante uso real**.

---

## ‚ö†Ô∏è Advertencia honesta

Este sistema **no es para improvisados**.  
Si busc√°s algo liviano, r√°pido y descartable, **este no es el proyecto**.

Si busc√°s:
- Control real
- Escalabilidad
- Orden
- Longevidad

Entonces est√°s en el lugar correcto.

---

## üìÑ Licencia

Pendiente de definici√≥n.
El core est√° pensado para uso profesional y comercial.

---

## ‚úçÔ∏è Autor

Desarrollado por **Mauro Massa**  
Proyecto SISA ‚Äî Core ERP







===== ARCHIVO: sync-conflict-policy.md =====
# Sync Conflict Policy ‚Äî SISA

## üéØ Objetivo

Definir **c√≥mo SISA detecta, clasifica y resuelve conflictos** durante la sincronizaci√≥n de eventos offline, garantizando:

- consistencia
- auditabilidad
- previsibilidad
- ausencia de efectos colaterales silenciosos

En SISA **no existen conflictos ‚Äúautom√°gicos‚Äù**.

---

## üß† Principio rector

> **El servidor es la √∫nica fuente de verdad.**  
> El cliente offline **propone hechos**, el servidor **decide validez**.

---

## üß© Qu√© es un conflicto

Un conflicto ocurre cuando un **evento offline**:

- contradice el estado actual del sistema
- viola una regla de negocio
- llega fuera de contexto temporal
- fue generado sin permisos v√°lidos
- ya fue aplicado (duplicado)

---

## üß± Clasificaci√≥n de conflictos

### 1Ô∏è‚É£ Conflicto de estado

**Descripci√≥n**  
El evento intenta aplicarse sobre un estado inv√°lido.

**Ejemplo**
- Evento: `job_paused`
- Estado actual: `planned`

**Resoluci√≥n**
- ‚ùå Evento rechazado
- üìÑ Motivo registrado
- üîî Usuario notificado

---

### 2Ô∏è‚É£ Conflicto de transici√≥n prohibida

**Descripci√≥n**  
La acci√≥n viola la m√°quina de estados.

**Ejemplo**
- Evento: `job_resumed`
- Estado actual: `completed`

**Resoluci√≥n**
- ‚ùå Evento rechazado
- üìÑ Auditor√≠a completa
- ‚ùå No se reintenta

---

### 3Ô∏è‚É£ Conflicto de permisos

**Descripci√≥n**
El usuario no tiene permisos v√°lidos al momento de sincronizar.

**Ejemplo**
- Usuario removido de la empresa
- Rol degradado

**Resoluci√≥n**
- ‚ùå Evento rechazado
- üîí Seguridad prioritaria
- üìÑ Registro de intento

---

### 4Ô∏è‚É£ Conflicto temporal

**Descripci√≥n**
El evento presenta incoherencias de tiempo.

**Ejemplos**
- Fin antes del inicio
- Superposici√≥n imposible de tramos
- Timestamp inv√°lido

**Resoluci√≥n**
- ‚ùå Evento rechazado
- üìÑ Se conserva el payload original
- üîî Usuario informado

---

### 5Ô∏è‚É£ Conflicto de duplicaci√≥n

**Descripci√≥n**
El evento ya fue procesado.

**Detecci√≥n**
- `event_id`
- `hash`
- `sequence_number`

**Resoluci√≥n**
- ‚ö†Ô∏è Evento ignorado
- ‚úî Marcado como synced
- üìÑ Sin efectos colaterales

---

### 6Ô∏è‚É£ Conflicto estructural

**Descripci√≥n**
La entidad referenciada ya no existe o cambi√≥ su contexto.

**Ejemplo**
- Job eliminado virtualmente
- Checklist deshabilitado

**Resoluci√≥n**
- ‚ùå Evento rechazado
- üìÑ Registro obligatorio

---

## üîÑ Pol√≠tica de resoluci√≥n

| Tipo de conflicto | Acci√≥n |
|------------------|-------|
| Estado inv√°lido | Rechazo |
| Transici√≥n prohibida | Rechazo |
| Permisos | Rechazo |
| Temporal | Rechazo |
| Duplicado | Ignorar |
| Estructural | Rechazo |

‚ùó **Nunca se corrige un evento autom√°ticamente**  
‚ùó **Nunca se reescribe la historia**

---

## üîÅ Reintentos

- ‚ùå No hay reintentos autom√°ticos
- ‚úî El usuario puede:
  - revisar el motivo
  - repetir la acci√≥n manualmente
  - generar un nuevo evento v√°lido

Cada reintento es **un evento nuevo**, no una modificaci√≥n.

---

## üßæ Auditor√≠a de conflictos

Todo conflicto genera:

- ID del evento
- Tipo de conflicto
- Payload original
- Usuario
- Empresa
- Dispositivo
- Timestamp local y de servidor
- Motivo t√©cnico del rechazo

Estos registros **no se eliminan**.

---

## üîî Comunicaci√≥n al usuario

El sistema debe:

- Informar claramente el rechazo
- Explicar el motivo en lenguaje operativo
- Evitar mensajes gen√©ricos

Ejemplo v√°lido:
> ‚ÄúEl trabajo ya fue completado por otro usuario antes de sincronizar.‚Äù

Ejemplo inv√°lido:
> ‚ÄúError de sincronizaci√≥n.‚Äù

---

## üîê Seguridad

- Un evento rechazado **no degrada** el sistema
- No se bloquea la cola completa
- Cada evento se eval√∫a individualmente
- No hay escalamiento de privilegios offline

---

## üß† Filosof√≠a final

SISA **prefiere rechazar un evento v√°lido**  
antes que **aceptar uno incorrecto**.

La integridad del sistema **est√° por encima de la comodidad del usuario**.

---

## ‚úÖ Conclusi√≥n

La pol√≠tica de conflictos de SISA garantiza que:

- el offline no corrompe el core
- los errores son visibles
- el sistema es defendible
- la historia nunca se reescribe

Sin esta pol√≠tica, el offline es una mentira peligrosa.

---


===== ARCHIVO: sync-conflicts-schema.md =====
# sync_conflicts ‚Äî Schema Definition (SISA)

## üéØ Objetivo

Definir la estructura de la tabla `sync_conflicts`, encargada de **registrar de forma inmutable** todos los conflictos detectados durante la sincronizaci√≥n de eventos offline.

Esta tabla es **parte del sistema de auditor√≠a** y **no admite borrado ni edici√≥n**.

---

## üß† Principios de dise√±o

- Append-only
- Auditor√≠a completa
- Multi-empresa real
- No depende del estado actual para interpretarse
- Reconstrucci√≥n hist√≥rica posible sin ambig√ºedades

---

## üóÑ Tabla: sync_conflicts

### Campos obligatorios

| Campo | Tipo | Descripci√≥n |
|-----|-----|------------|
| `id` | UUID | Identificador √∫nico del registro de conflicto |
| `event_id` | UUID | ID del evento offline que gener√≥ el conflicto |
| `company_id` | UUID | Empresa en la que ocurri√≥ el conflicto |
| `entity_type` | VARCHAR | Tipo de entidad afectada (job, checklist_item, time_entry, file, etc.) |
| `entity_id` | UUID | ID de la entidad afectada |
| `conflict_type` | VARCHAR | Clasificaci√≥n del conflicto |
| `action` | VARCHAR | Acci√≥n intentada (ej: job_paused) |
| `payload` | JSON | Payload original del evento offline |
| `user_id` | UUID | Usuario que gener√≥ el evento |
| `device_id` | VARCHAR | Identificador del dispositivo |
| `local_timestamp` | DATETIME | Timestamp generado en el dispositivo |
| `server_timestamp` | DATETIME | Timestamp del servidor al procesar |
| `rejection_reason` | TEXT | Motivo t√©cnico del rechazo |
| `created_at` | DATETIME | Momento de inserci√≥n del registro |

---

## üßæ conflict_type ‚Äî valores esperados

`conflict_type` **no es libre**, debe responder a un set controlado.

Valores recomendados:

- `invalid_state`
- `invalid_transition`
- `permission_denied`
- `temporal_inconsistency`
- `duplicate_event`
- `structural_conflict`
- `unknown_entity`
- `validation_error`

> ‚ùó No se usan enums r√≠gidos para permitir evoluci√≥n controlada.

---

## üîó Relaciones conceptuales

- `event_id` ‚Üí offline_events.event_id
- `company_id` ‚Üí companies.id
- `user_id` ‚Üí users.id
- `entity_id` ‚Üí entidad correspondiente seg√∫n `entity_type`

‚ö†Ô∏è **No se usan foreign keys obligatorias**  
Motivo: la entidad puede haber sido eliminada virtualmente.

---

## üß± Reglas duras

- Ning√∫n registro se elimina
- Ning√∫n registro se modifica
- No se reutiliza `event_id`
- Un mismo evento genera **m√°ximo un conflicto**
- La ausencia de `company_id` invalida el registro

---

## üîç Casos de uso cubiertos

- Auditor√≠a legal
- Debugging t√©cnico
- Soporte al usuario
- An√°lisis de fallas offline
- M√©tricas de calidad de sincronizaci√≥n

---

## ‚ö†Ô∏è Errores que este schema evita

- Conflictos sin contexto empresarial
- Logs ambiguos
- Reescritura de historia
- Debugging basado en suposiciones
- ‚ÄúFuncion√≥ en mi tel√©fono‚Äù

---

## ‚úÖ Conclusi√≥n

La tabla `sync_conflicts` es:

- un registro de verdad
- una defensa t√©cnica
- una herramienta legal
- un seguro contra corrupci√≥n silenciosa

Si esta tabla existe y se respeta, el offline **no miente**.

---


===== ARCHIVO: xxx_resultado_unificado.txt =====
===== ARCHIVO: FASES.md =====
üß± 1) N√öCLEO (Core Platform)
üìå Identidad, seguridad, multiempresa, auditor√≠a, archivos.

Es el cimiento obligatorio.

Incluye:

Users

User Security Events

User Sessions

Companies

Memberships

Roles

Legal Acceptances

Audit Log

Company Settings

Files + File Links

Instalaci√≥n inicial

Login / Logout

Regla 4equim

Estados l√≥gicos

Multiempresa real

üëâ Sin esto, no existe SISA.
Sin esto, no pod√©s construir ERP.
Sin esto, no pod√©s garantizar contabilidad.

Este m√≥dulo SIEMPRE VA PRIMERO.

üìò 2) NEGOCIO (ERP Operativo)
üìå Registra hechos reales, NO los interpreta contablemente.

Ac√° va todo lo operativo del d√≠a a d√≠a:

Jobs (√≥rdenes de trabajo)

Job Time Entries

Job Checklist Items

Quotes

Sales

Purchases

Invoices

Receipts

Payments

Adjustments

Estados, lifecycles, auditor√≠as

Validaciones cruzadas ERP

üëâ Fase 2 produce eventos operativos inmutables.
These events are the raw material of accounting.

Este m√≥dulo SIEMPRE VA DESPU√âS DEL N√öCLEO
y SIEMPRE VA ANTES de la contabilidad.

Si lo invert√≠s ‚Üí te explota la consistencia temporal.

üìô 3) CONTABILIDAD (ACCCORE ‚Äì Fase 3)
üìå Interpreta los eventos operativos del ERP y produce informaci√≥n contable real.

Incluye:

Plan de cuentas

Asientos contables

Centros de costo

IVA

Percepciones / Retenciones

Cierres contables

Mayor anal√≠tico

Balance, PyG

Devengamientos

Contabilidad por empresa

Auditor√≠a contable

Reglas fiscales

üëâ Contabilidad NO puede existir antes del ERP.
NUNCA se generan asientos directamente desde m√≥dulos operativos.
SIEMPRE debe hacerse desde eventos auditables.

üéØ Resumen brutalmente claro
‚úî 1) CORE

Fundaci√≥n del sistema
(lo que hace posible todo)

‚úî 2) NEGOCIO / ERP

Registra hechos
(no interpreta nada)

‚úî 3) CONTABILIDAD

Interpreta hechos ‚Üí genera asientos

üéØ Orden obligatorio

1Ô∏è‚É£ Core Platform
2Ô∏è‚É£ ERP Operativo (Negocio)
3Ô∏è‚É£ Contabilidad (ACCCORE)

===== ARCHIVO: offline-events.md =====
# Offline Events Queue ‚Äî SISA

## üéØ Objetivo

Definir el **modelo de cola de eventos offline** utilizado por SISA para registrar acciones realizadas sin conectividad y sincronizarlas de forma **segura**, **auditable** y **determinista**.

Esta cola es la **√∫nica v√≠a v√°lida** para introducir cambios offline al sistema.

---

## üß† Principios no negociables

- La cola es **append-only**
- Los eventos **no se editan**
- Los eventos **no se eliminan**
- El servidor es la **fuente de verdad final**
- El orden importa
- La validaci√≥n siempre ocurre **en el servidor**

---

## üß± Concepto central

Un **Offline Event** representa **una acci√≥n del usuario**, no un estado final.

Ejemplo:
- ‚úî ‚ÄúEl usuario inici√≥ el trabajo‚Äù
- ‚ùå ‚ÄúEl trabajo qued√≥ en progreso‚Äù

---

## üßæ Estructura l√≥gica de un Offline Event

Cada evento contiene:

- `event_id` ‚Äî UUID √∫nico
- `entity_type` ‚Äî Job, ChecklistItem, TimeEntry, File
- `entity_id` ‚Äî ID de la entidad afectada
- `action` ‚Äî Acci√≥n ejecutada
- `payload` ‚Äî Datos m√≠nimos necesarios
- `actor_user_id`
- `company_id`
- `device_id`
- `local_timestamp`
- `sequence_number`
- `status` ‚Äî pending / synced / rejected
- `hash` ‚Äî integridad del evento

---

## üßÆ Orden y secuencia

- Cada dispositivo mantiene un `sequence_number` incremental
- El servidor valida:
  - duplicados
  - saltos de secuencia
  - reenv√≠os
- El orden de procesamiento es **estricto por dispositivo**

---

## üîÑ Tipos de eventos permitidos

### Jobs
- `job_started`
- `job_paused`
- `job_resumed`
- `job_note_added`

### Checklists
- `checklist_item_completed`
- `checklist_item_failed`
- `checklist_item_note_added`

### Tiempos
- `time_entry_started`
- `time_entry_stopped`
- `time_entry_corrected`

### Archivos
- `file_captured`
- `file_metadata_updated`

---

## ‚ùå Eventos expl√≠citamente prohibidos offline

- `job_completed`
- `job_cancelled`
- `accounting_entry_created`
- `invoice_created`
- `user_created`
- `role_changed`

Estos eventos **solo existen online**.

---

## üîç Validaci√≥n en el servidor

Cada evento es validado contra:

- Estado actual de la entidad
- M√°quina de estados
- Permisos del usuario
- Empresa activa
- Consistencia temporal
- Duplicaci√≥n

Resultado:
- **Aceptado** ‚Üí aplicado + marcado como synced
- **Rechazado** ‚Üí marcado como rejected + auditado

---

## ‚ö†Ô∏è Manejo de conflictos

Ejemplos:
- Evento aplicado sobre estado inv√°lido
- Evento duplicado
- Evento fuera de orden

Regla:
- El evento **no se reintenta autom√°ticamente**
- Se registra el rechazo
- Se notifica al usuario

---

## üßæ Auditor√≠a

Cada evento queda registrado con:

- Payload original
- Timestamps (local + server)
- Resultado de validaci√≥n
- Motivo de rechazo (si aplica)

Nunca se borra.

---

## üß± Persistencia local

- Base local (SQLite / almacenamiento seguro)
- Cola transaccional
- Confirmaci√≥n expl√≠cita de sync
- Soporte para reintentos manuales

---

## üîê Seguridad

- Eventos firmados con hash
- Asociados a dispositivo y usuario
- No se aceptan eventos sin autenticaci√≥n previa v√°lida

---

## ‚úÖ Conclusi√≥n

La cola de eventos offline en SISA:

- No intenta ‚Äúrecrear estados‚Äù
- No corrige el pasado
- No asume autoridad

Solo **narra hechos**.

El servidor decide qu√© hechos son v√°lidos.

---


===== ARCHIVO: offline-scope-boundary.md =====
# Offline Scope Boundary ‚Äî SISA

## üéØ Objetivo

Definir **l√≠mites expl√≠citos e inquebrantables** sobre qu√© **nunca** puede implementarse en modo offline dentro de SISA.

Este documento existe para:
- prevenir degradaci√≥n arquitect√≥nica
- evitar ‚Äúexcepciones c√≥modas‚Äù
- proteger el core del sistema a largo plazo

---

## üß† Principio absoluto

> **El offline no define verdad, solo registra intentos.**

Cualquier funcionalidad que contradiga este principio  
**queda autom√°ticamente fuera de alcance**.

---

## üö´ Categor√≠as prohibidas para Offline

Las siguientes categor√≠as **no pueden** operar offline, **bajo ning√∫n escenario**.

---

### 1Ô∏è‚É£ Dinero y contabilidad

Incluye (sin excepci√≥n):

- Asientos contables
- Pagos
- Cobros
- Facturaci√≥n
- Notas de cr√©dito / d√©bito
- Cierres contables
- Ajustes de balance
- Reversiones financieras

**Motivo**
- Riesgo legal
- Riesgo fiscal
- Dependencias cruzadas
- Impacto irreversible

‚ùå Nunca offline  
‚ùå Nunca ‚Äúmodo borrador‚Äù offline  
‚ùå Nunca sincronizaci√≥n diferida

---

### 2Ô∏è‚É£ Estados terminales

Estados finales o irreversibles:

- `completed`
- `cancelled`
- `closed`
- `archived`

**Motivo**
- Disparan efectos colaterales
- Pueden cerrar flujos contables u operativos
- Definen historia final

‚úî Pueden **proponerse** offline  
‚ùå Nunca confirmarse offline

---

### 3Ô∏è‚É£ Datos maestros estructurales

Incluye:

- Empresas
- Clientes
- Proveedores
- Productos / servicios
- Carpetas ra√≠z
- Configuraci√≥n global
- Cat√°logos base

**Motivo**
- Alta dependencia
- Riesgo de duplicaci√≥n
- Rompen integridad referencial

‚ùå No se crean offline  
‚ùå No se editan offline  
‚ùå No se eliminan offline

---

### 4Ô∏è‚É£ Seguridad y permisos

Incluye:

- Creaci√≥n de usuarios
- Cambios de rol
- Asignaci√≥n de empresas
- Revocaci√≥n de accesos
- Pol√≠ticas de seguridad

**Motivo**
- Riesgo de escalamiento de privilegios
- Violaci√≥n de modelo de seguridad

‚ùå Nunca offline  
‚ùå Nunca cache editable

---

### 5Ô∏è‚É£ Configuraci√≥n del sistema

Incluye:

- Par√°metros globales
- Reglas de negocio
- M√°quinas de estado
- Flags de comportamiento

**Motivo**
- Cambios sist√©micos
- Impacto transversal
- Dif√≠cil rollback

---

## ‚ö†Ô∏è Zonas grises expl√≠citamente cerradas

Las siguientes ideas **parecen razonables**, pero est√°n **prohibidas**:

- ‚ÄúModo borrador offline‚Äù para facturas
- ‚ÄúPre-crear clientes offline‚Äù
- ‚ÄúCerrar trabajos offline y confirmar despu√©s‚Äù
- ‚ÄúEditar permisos sin conexi√≥n‚Äù
- ‚ÄúSincronizar contabilidad al reconectar‚Äù

Si alguien propone esto:
üëâ la respuesta es **NO**.

---

## ‚úÖ Categor√≠as permitidas Offline (recordatorio)

El offline **solo** se admite para:

- Registro de acciones operativas
- Checklists
- Tiempos trabajados
- Archivos y evidencias
- Observaciones
- Lectura de datos de referencia

Siempre bajo:
- cola de eventos
- validaci√≥n server-side
- auditor√≠a

---

## üß± Regla de decisi√≥n r√°pida

Ante cualquier feature nueva, preguntarse:

1. ¬øAfecta dinero?
2. ¬øDefine una verdad del sistema?
3. ¬øCambia permisos o estructura?
4. ¬øEs irreversible?

Si la respuesta es **s√≠** a cualquiera:
üëâ **No es offline**.

---

## üîê Autoridad final

- Este documento **tiene prioridad** sobre:
  - decisiones de UX
  - pedidos comerciales
  - conveniencias t√©cnicas
- Ninguna feature puede violarlo sin **romper SISA**

---

## ‚úÖ Conclusi√≥n

El offline en SISA:

- es acotado
- es consciente
- es responsable
- es defendible

Este boundary existe para que el sistema **no se desarme con el tiempo**.

---


===== ARCHIVO: offline-strategy.md =====
# Offline Strategy ‚Äî SISA

## üéØ Objetivo

Definir **cu√°ndo**, **d√≥nde** y **por qu√©** SISA aplica el enfoque **offline-first**, evitando inconsistencias, riesgos contables o violaciones de reglas de negocio.

SISA **no es offline-first por defecto**.  
Es **offline-inteligente**.

---

## üß† Principio rector

> **Si el dato representa un hecho ocurrido ‚Üí puede ser offline-first**  
> **Si el dato representa una verdad del sistema ‚Üí es online-only**

Este principio gobierna todas las decisiones offline del sistema.

---

## ‚úÖ Casos donde S√ç aplica Offline-first

### 1. Jobs en ejecuci√≥n

**Contexto**  
Operaci√≥n en campo con conectividad inestable o inexistente.

**Acciones permitidas offline**
- Visualizaci√≥n de Jobs asignados
- Transiciones operativas:
  - `planned ‚Üí in_progress`
  - `in_progress ‚Üí paused`
- Registro de observaciones
- Asociaci√≥n de participantes
- Registro de tramos horarios
- Adjuntar archivos

**Estrategia**
- Cache local estructurada
- Cola de eventos append-only
- Sincronizaci√≥n diferida con validaci√≥n de estado

---

### 2. Checklists / Consignas operativas

**Descripci√≥n**
- √çtems ejecutables
- Pueden realizarse m√∫ltiples veces por Job
- Asociados al momento real de ejecuci√≥n

**Offline**
- Ejecuci√≥n completa offline
- Persistencia local con timestamp real
- Sincronizaci√≥n posterior

---

### 3. Tiempos trabajados

**Caracter√≠sticas**
- Registro de inicio / fin
- M√∫ltiples tramos por Job
- Correcciones permitidas con historial

**Offline**
- Captura local
- Validaci√≥n en sincronizaci√≥n
- Nunca se pisa historial existente

---

### 4. Captura de archivos

**Ejemplos**
- Fotos de equipos
- Videos de fallas
- Evidencias t√©cnicas

**Flujo**
1. Guardado local
2. Asociaci√≥n de metadata
3. Upload diferido
4. Vinculaci√≥n al Job / checklist correspondiente

---

### 5. Datos de referencia (solo lectura)

**Ejemplos**
- Clientes
- Productos / servicios
- Carpetas
- Estados v√°lidos

**Restricci√≥n**
- Lectura offline permitida
- Creaci√≥n y edici√≥n **solo online**

---

## ‚ùå Casos donde NO aplica Offline-first

### 1. Contabilidad

**Prohibido offline**
- Asientos contables
- Pagos
- Facturaci√≥n
- Cierres
- Ajustes

**Motivo**
- Riesgo financiero
- Riesgo legal
- Alta dependencia cruzada

---

### 2. Estados finales de Jobs

Estados:
- `completed`
- `cancelled`

**Regla**
- Nunca se confirman offline
- Pueden proponerse, pero requieren validaci√≥n online

---

### 3. Usuarios y permisos

**Incluye**
- Creaci√≥n de usuarios
- Asignaci√≥n de roles
- Vinculaci√≥n a empresas

**Motivo**
- Riesgo de escalamiento de privilegios
- Seguridad del sistema

---

### 4. Datos maestros estructurales

**Ejemplos**
- Empresas
- Clientes / proveedores
- Productos / servicios
- Configuraci√≥n global
- Estructuras contables

**Regla**
- Siempre online

---

## üß± Pol√≠tica de sincronizaci√≥n

- Todos los eventos offline:
  - Son **append-only**
  - Nunca pisan datos existentes
  - Se validan contra el estado actual
- Conflictos:
  - Se rechazan eventos inv√°lidos
  - Se registran para auditor√≠a
- El servidor es la **fuente de verdad final**

---

## üîç Auditor√≠a

Cada evento offline sincronizado:
- Tiene timestamp local
- Tiene timestamp de servidor
- Guarda autor, contexto y entidad afectada
- Nunca se elimina

---

## ‚ö†Ô∏è Advertencias

- Offline-first mal aplicado **rompe sistemas**
- No se admiten ‚Äúexcepciones por comodidad‚Äù
- Si una acci√≥n afecta:
  - dinero
  - estructura
  - permisos  
  entonces **no es offline**

---

## ‚úÖ Conclusi√≥n

SISA aplica offline-first **solo donde agrega valor real**, sin comprometer:

- consistencia
- seguridad
- auditabilidad
- escalabilidad

Offline no es libertad.  
Es **responsabilidad controlada**.

---


===== ARCHIVO: README.md =====
# SISA ‚Äî Sistema Integrado de Servicios Administrativos

SISA es una **plataforma ERP modular**, dise√±ada para **empresas reales**, con foco en **trazabilidad total**, **control operativo**, **contabilidad s√≥lida** y **escalabilidad progresiva**.

No es un MVP de juguete.  
No es un clon liviano de otro sistema.  
Es un **core empresarial serio**, pensado para crecer sin romperse.

---

## üéØ Objetivo del sistema

Construir un **n√∫cleo administrativo y operativo** que permita:

- Gestionar **empresas, clientes y proveedores**
- Controlar **operaciones (Jobs)** con estados estrictos
- Registrar **consignas, checklists y ejecuci√≥n real**
- Manejar **tiempos trabajados**, participantes y recursos
- Integrar **contabilidad**, **facturaci√≥n** y **auditor√≠a**
- Escalar hacia **automatizaci√≥n, IA y an√°lisis avanzado**

SISA est√° pensado como **base estructural**, no como producto descartable.

---

## üß± Principios no negociables

- ‚ùå **Nada se borra f√≠sicamente**
- ‚úÖ Todo es **auditable**
- ‚úÖ Estados con **m√°quinas de estado estrictas**
- ‚ùå No hay ‚Äúexcepciones m√°gicas‚Äù
- ‚úÖ El sistema refleja la **realidad operativa**
- ‚úÖ Dise√±o orientado a **crecimiento y mantenimiento**

---

## üß© Arquitectura general

SISA se construye por **capas y m√≥dulos independientes**:

### Backend
- API REST
- Arquitectura desacoplada
- Validaciones duras
- Control de permisos por rol y empresa
- Registro hist√≥rico autom√°tico

### Frontend
- App m√≥vil + web
- Offline-first (cuando aplica)
- Sincronizaci√≥n controlada
- UI enfocada en operaci√≥n real, no en est√©tica vac√≠a

### Base de datos
- Modelo relacional estricto
- Historial por entidad
- Estados expl√≠citos
- Relaciones claras y no ambiguas

---

## üì¶ M√≥dulos principales

### üè¢ Empresas
- Multi-empresa real
- Usuarios con roles y permisos
- Ning√∫n usuario existe sin contexto empresarial

### üë• Clientes y Proveedores
- Son **referencias a Company**
- No se duplican datos
- Uso de `client_company_id` / `provider_company_id`

### üõ† Jobs (Operaciones)
- N√∫cleo operativo del sistema
- No contiene fechas ni horarios directos
- Se rige por **m√°quina de estados**
- Estados finales inmutables

Estados t√≠picos:
- planned
- in_progress
- paused
- completed
- cancelled

Transiciones inv√°lidas expl√≠citas (ejemplos):
- completed ‚Üí *
- cancelled ‚Üí *
- in_progress ‚Üí planned
- paused ‚Üí planned

### ‚úÖ Checklists / Consignas
- √çtems operativos ejecutables
- Asociados al momento real de ejecuci√≥n
- Permiten m√∫ltiples ejecuciones por Job
- Cada ejecuci√≥n puede tener distintos participantes

### ‚è± Tiempos y Horarios
- Tablas separadas de Jobs
- Registro real de inicio y fin
- M√∫ltiples tramos por trabajo
- Correcciones posibles **con historial**

### üìä Contabilidad
- Base contable s√≥lida
- Preparada para:
  - facturaci√≥n
  - pagos
  - reportes
  - cierres
- Dise√±ada como **core independiente**

### üìÅ Archivos
- Vinculados a entidades
- Metadata persistente
- Soporte offline
- Historial de cambios

---

## üîê Seguridad y control

- Autenticaci√≥n obligatoria
- Permisos por rol
- Acceso por empresa
- Registro de acciones cr√≠ticas
- Sin endpoints ‚Äúp√∫blicos‚Äù innecesarios

---

## üß† Filosof√≠a de dise√±o

SISA no intenta ‚Äúhacer todo r√°pido‚Äù.  
Intenta **hacer lo correcto primero**.

- Primero estructura
- Despu√©s velocidad
- Luego automatizaci√≥n
- Finalmente inteligencia (IA)

---

## üöÄ Estado del proyecto

SISA se encuentra en **desarrollo activo**, con foco en:

- Consolidaci√≥n del core
- Reglas duras
- Documentaci√≥n exhaustiva
- Base contable profesional

No se prioriza el marketing hasta que el sistema **aguante uso real**.

---

## ‚ö†Ô∏è Advertencia honesta

Este sistema **no es para improvisados**.  
Si busc√°s algo liviano, r√°pido y descartable, **este no es el proyecto**.

Si busc√°s:
- Control real
- Escalabilidad
- Orden
- Longevidad

Entonces est√°s en el lugar correcto.

---

## üìÑ Licencia

Pendiente de definici√≥n.
El core est√° pensado para uso profesional y comercial.

---

## ‚úçÔ∏è Autor

Desarrollado por **Mauro Massa**  
Proyecto SISA ‚Äî Core ERP







===== ARCHIVO: üìò FASE 1 - CORE PLATFORM.md =====


# **üìò CORE PLATFORM** 

**Modelo \+ Reglas \+ Entidades \+ Ciclos de vida \+ Seguridad \+ Auditor√≠a \+ Instalaci√≥n inicial**  
**Sin ambig√ºedades ‚Ä¢ Sin c√≥digo ‚Ä¢ Sin implementaci√≥n ‚Ä¢ Solo contrato de arquitectura**

---

# **üß± 0\) PRINCIPIOS INMUTABLES**

## **0.1 ‚Äî NO EXISTE EL BORRADO F√çSICO**

Todo dato cr√≠tico **nunca se elimina f√≠sicamente**, solo cambia de estado:  
`active`, `inactive`, `archived`, `deleted`.

Toda tabla core debe tener:

* `status`  
* `deleted_at`  
* `created_at`  
* `updated_at`

## **0.2 ‚Äî REGLA PADRE‚ÄìHIJO (4EQUIM)**

Un registro **NO puede eliminarse** si tiene:

* hijos activos  
* contenido asociado  
* dependencias l√≥gicas activas

Opciones permitidas:

1. eliminar primero los hijos  
2. operaci√≥n expl√≠cita ‚Äúeliminar todo el contenido‚Äù  
3. rechazar la operaci√≥n

## **0.3 ‚Äî AUDITOR√çA UNIVERSAL**

Todo cambio relevante ‚Üí audit\_log  
Nunca se modifica  
Nunca se elimina  
Append-only

## **0.4 ‚Äî INSTALACI√ìN INICIAL**

Antes de estar instalado:

* `APP_INSTALLED = false`  
* Primer usuario creado ‚Üí `superadmin`  
* Luego el endpoint queda bloqueado permanentemente

## **0.5 ‚Äî MULTIEMPRESA REAL**

Todo dato operativo requiere `company_id` (cuando corresponde).  
Una sesi√≥n siempre est√° asociada a un contexto de empresa activa.

---

# **üóÇ ENTIDADES UNIFICADAS (POST-FUSI√ìN)**

**Estas son las tablas DEFINITIVAS**.  
Si no aparece ac√°, NO forma parte del Core.

Voy a fusionar donde corresponde para mayor coherencia, simplicidad y potencia.

---

# **1Ô∏è‚É£ USERS (usuarios del sistema)**

## **Prop√≥sito**

Identidad digital global. Sin empresa asociada. Nunca se borra f√≠sicamente.

## **Estados**

`pending`, `active`, `locked`, `disabled`, `deleted`

## **Tabla final (completa)**

Incluye **los campos m√°s completos y seguros** de todas las versiones previas.

users (  
  id CHAR(36) PRIMARY KEY,  
  email VARCHAR(255) NOT NULL UNIQUE,  
  password\_hash VARCHAR(255) NOT NULL,

  status ENUM('pending','active','locked','disabled','deleted') NOT NULL DEFAULT 'pending',  
  locked\_until DATETIME(6) NULL,  
  email\_verified\_at DATETIME(6) NULL,  
  deleted\_at DATETIME(6) NULL,

  created\_at DATETIME(6) NOT NULL,  
  updated\_at DATETIME(6) NOT NULL  
)

---

# **2Ô∏è‚É£ USER\_SECURITY\_EVENTS (FUSI√ìN: login\_attempts \+ seguridad de acceso)**

üí° En vez de dos tablas separadas, lo fusionamos en una estructura de **eventos de seguridad universal**, m√°s poderosa, m√°s auditable y m√°s escalable.

Esto permite registrar:

* login attempts  
* bloqueos autom√°ticos  
* desbloqueos  
* resets  
* captchas  
* eventos de credenciales

## **Tabla final**

user\_security\_events (  
  id CHAR(36) PRIMARY KEY,  
  user\_id CHAR(36) NULL,  
  email VARCHAR(255) NOT NULL,  
  ip\_address VARCHAR(100),  
  user\_agent VARCHAR(500),

  event\_type ENUM(  
    'login\_success',  
    'login\_failed',  
    'password\_reset\_requested',  
    'password\_reset\_used',  
    'email\_verification\_sent',  
    'email\_verified',  
    'auto\_lock',  
    'auto\_unlock',  
    'manual\_lock',  
    'manual\_unlock'  
  ) NOT NULL,

  metadata JSON,  
  created\_at DATETIME(6) NOT NULL,

  INDEX (email),  
  INDEX (user\_id),  
  INDEX (event\_type),  
  INDEX (created\_at)  
)

## **Beneficios**

* sustituye login\_attempts  
* registra todos los eventos de seguridad  
* an√°lisis avanzado de ataques  
* lista para machine learning / anomaly detection

---

# **3Ô∏è‚É£ USER\_ROLES (roles globales)**

user\_roles (  
  id CHAR(36) PRIMARY KEY,  
  user\_id CHAR(36) NOT NULL,  
  role ENUM('superadmin','system') NOT NULL,  
  status ENUM('active','deleted') NOT NULL DEFAULT 'active',  
  deleted\_at DATETIME(6),  
  created\_at DATETIME(6),  
  updated\_at DATETIME(6)  
)

---

# **4Ô∏è‚É£ USER\_SESSIONS (sesiones del usuario)**

## **Mejorada (fusi√≥n de variantes)**

Incluye usuario, empresa activa y seguridad adicional.

user\_sessions (  
  id CHAR(36) PRIMARY KEY,  
  user\_id CHAR(36) NOT NULL,  
  active\_company\_id CHAR(36) NULL,

  refresh\_token VARCHAR(255) NOT NULL UNIQUE,  
  ip\_address VARCHAR(100),  
  user\_agent VARCHAR(500),

  expires\_at DATETIME(6) NOT NULL,  
  revoked\_at DATETIME(6) NULL,  
  created\_at DATETIME(6) NOT NULL,  
  updated\_at DATETIME(6) NOT NULL  
)

---

# **5Ô∏è‚É£ COMPANIES (empresas / tenants)**

Combinando todas las versiones:

companies (  
  id CHAR(36) PRIMARY KEY,  
  legal\_name VARCHAR(255) NOT NULL,  
  trade\_name VARCHAR(255),  
  tax\_id VARCHAR(50),

  status ENUM('active','inactive','archived','deleted') NOT NULL DEFAULT 'active',  
  deleted\_at DATETIME(6),

  created\_at DATETIME(6) NOT NULL,  
  updated\_at DATETIME(6) NOT NULL  
)

Reglas duras:

* no se puede eliminar si tiene owners  
* no se puede eliminar si tiene datos activos  
* no puede quedar sin owner

---

# **6Ô∏è‚É£ COMPANY\_INVITATIONS (invitaciones, versi√≥n final)**

company\_invitations (  
  id CHAR(36) PRIMARY KEY,  
  company\_id CHAR(36) NOT NULL,  
  email VARCHAR(255) NOT NULL,  
  role ENUM('owner','admin','member','viewer') NOT NULL,  
  token CHAR(36) NOT NULL,

  status ENUM('pending','accepted','rejected','expired','revoked') NOT NULL,  
  expires\_at DATETIME(6),  
  accepted\_at DATETIME(6),

  created\_at DATETIME(6) NOT NULL,  
  updated\_at DATETIME(6) NOT NULL  
)

---

# **7Ô∏è‚É£ COMPANY\_MEMBERSHIPS (participaci√≥n)**

company\_memberships (  
  id CHAR(36) PRIMARY KEY,  
  company\_id CHAR(36) NOT NULL,  
  user\_id CHAR(36) NOT NULL,  
  status ENUM('active','invited','revoked','left','deleted') NOT NULL,  
  deleted\_at DATETIME(6),

  created\_at DATETIME(6),  
  updated\_at DATETIME(6)  
)

---

# **8Ô∏è‚É£ MEMBERSHIP\_ROLES (roles dentro de empresa)**

membership\_roles (  
  id CHAR(36) PRIMARY KEY,  
  membership\_id CHAR(36) NOT NULL,  
  role ENUM('owner','admin','member','viewer') NOT NULL,  
  status ENUM('active','deleted') NOT NULL DEFAULT 'active',  
  deleted\_at DATETIME(6),

  created\_at DATETIME(6),  
  updated\_at DATETIME(6)  
)

---

# **9Ô∏è‚É£ COMPANY\_SETTINGS (config por empresa)**

company\_settings (  
  id CHAR(36) PRIMARY KEY,  
  company\_id CHAR(36) NOT NULL,  
  setting\_key VARCHAR(100) NOT NULL,  
  setting\_value TEXT,  
  status ENUM('active','deleted') NOT NULL DEFAULT 'active',  
  deleted\_at DATETIME(6),

  created\_at DATETIME(6),  
  updated\_at DATETIME(6)  
)

---

# **üîü FILES \+ FILE\_LINKS (repositorio universal)**

## **FUSI√ìN:**

La estructura actual ya es correcta y no se fusiona con otras tablas.

### **files**

files (  
  id CHAR(36) PRIMARY KEY,  
  company\_id CHAR(36) NOT NULL,  
  user\_id CHAR(36) NOT NULL,  
  mime\_type VARCHAR(200),  
  size INT,  
  path VARCHAR(500),

  status ENUM('active','archived','deleted') NOT NULL DEFAULT 'active',  
  deleted\_at DATETIME(6),

  created\_at DATETIME(6)  
)

### **file\_links**

file\_links (  
  id CHAR(36) PRIMARY KEY,  
  file\_id CHAR(36) NOT NULL,  
  entity\_type VARCHAR(100) NOT NULL,  
  entity\_id CHAR(36) NOT NULL,  
  status ENUM('active','deleted') NOT NULL DEFAULT 'active',  
  deleted\_at DATETIME(6),

  created\_at DATETIME(6)  
)

---

# **1Ô∏è‚É£1Ô∏è‚É£ AUDIT\_LOG (auditor√≠a universal)**

Versi√≥n mejorada final:

audit\_log (  
  id CHAR(36) PRIMARY KEY,  
  company\_id CHAR(36) NULL,  
  user\_id CHAR(36) NULL,  
  entity\_type VARCHAR(100) NOT NULL,  
  entity\_id CHAR(36) NOT NULL,

  action ENUM('create','update','delete','archive','restore','security') NOT NULL,  
  snapshot\_before JSON,  
  snapshot\_after JSON,  
  metadata JSON,

  created\_at DATETIME(6) NOT NULL  
)

---

# **1Ô∏è‚É£2Ô∏è‚É£ USER\_LEGAL\_ACCEPTANCES**

(Normalizado y completo)

user\_legal\_acceptances (  
  id CHAR(36) PRIMARY KEY,  
  user\_id CHAR(36) NOT NULL,  
  document\_type ENUM('tos','privacy','cookies') NOT NULL,  
  document\_version VARCHAR(50) NOT NULL,  
  accepted\_at DATETIME(6) NOT NULL,

  created\_at DATETIME(6)  
)

---

Perfecto. Ac√° ten√©s el **DOCUMENTO DE SCOPE OFICIAL**.  
Esto es **contrato de alcance**, corto, expl√≠cito y sin interpretaciones.  
---

## **Documento de Scope Oficial (Congelado)**

---

## **üéØ Prop√≥sito del documento**

Este documento define **qu√© incluye y qu√© NO incluye** la **FASE 1 ‚Äì CORE PLATFORM**.

Su funci√≥n es:

* evitar inflaci√≥n de alcance  
* eliminar ambig√ºedades  
* servir como **l√≠mite contractual**  
* permitir avanzar r√°pido a fases posteriores sin rehacer nada

Si algo **no est√° expl√≠citamente incluido**, **no pertenece a la Fase 1**.

---

## **üü¢ ALCANCE INCLUIDO ‚Äî FASE 1**

La Fase 1 cubre **exclusivamente el n√∫cleo estructural del sistema**.

### **1Ô∏è‚É£ Identidad y acceso**

* Usuarios (users)  
* Estados de usuario  
* Bloqueos autom√°ticos y manuales  
* Verificaci√≥n de email  
* Recuperaci√≥n de contrase√±a  
* Aceptaci√≥n de t√©rminos legales  
* Sesiones con refresh tokens  
* Eventos de seguridad (login, locks, resets)

### **2Ô∏è‚É£ Seguridad**

* Registro de intentos de login  
* Detecci√≥n de abuso  
* Bloqueos temporales  
* Auditor√≠a de eventos de seguridad  
* No revelaci√≥n de existencia de usuarios

### **3Ô∏è‚É£ Instalaci√≥n inicial (bootstrap)**

* Sistema inicia sin usuarios  
* Primer usuario ‚Üí `superadmin`  
* Bloqueo permanente del modo instalaci√≥n  
* Sistema idempotente

### **4Ô∏è‚É£ Multiempresa (tenancy)**

* Empresas (companies)  
* Relaci√≥n usuario‚Äìempresa (memberships)  
* Roles por empresa (owner, admin, member, viewer)  
* Protecci√≥n de ownership (no dejar empresa sin owner)  
* Invitaciones a empresas por email  
* Cambio de contexto de empresa por sesi√≥n

### **5Ô∏è‚É£ Configuraci√≥n b√°sica**

* Configuraci√≥n por empresa (company\_settings)  
* Preferencias m√≠nimas de usuario (cuando aplique)

### **6Ô∏è‚É£ Archivos**

* Repositorio universal de archivos  
* Asociaci√≥n flexible de archivos a entidades  
* Prohibici√≥n de borrado f√≠sico autom√°tico

### **7Ô∏è‚É£ Auditor√≠a**

* Auditor√≠a universal de cambios  
* Auditor√≠a de seguridad separada  
* Registros append-only  
* No modificables  
* No eliminables

### **8Ô∏è‚É£ Reglas transversales**

* No borrado f√≠sico  
* Borrado l√≥gico con `status` y `deleted_at`  
* Regla padre‚Äìhijo tipo 4equim  
* UUID globales  
* Preparado para integraciones futuras (sin implementarlas)

---

## **üî¥ ALCANCE EXCLUIDO ‚Äî FASE 1**

**Todo lo siguiente queda EXPL√çCITAMENTE fuera de la Fase 1**  
y ser√° tratado en fases posteriores.

### **‚ùå Negocio / ERP**

* Clientes  
* Proveedores  
* Productos / servicios  
* Ventas  
* Compras  
* Stock  
* √ìrdenes de trabajo  
* Precios  
* Facturaci√≥n

### **‚ùå Contabilidad (ACCCORE)**

* Asientos contables  
* Plan de cuentas  
* Impuestos  
* Balances  
* Cierres contables  
* Reportes financieros

### **‚ùå Permisos finos**

* Permisos por m√≥dulo  
* Permisos por acci√≥n  
* ACL detallado  
* Feature flags por rol

### **‚ùå Automatizaci√≥n y jobs**

* Tareas programadas  
* Workers  
* Colas  
* Procesos autom√°ticos

### **‚ùå Integraciones**

* API p√∫blica  
* Webhooks  
* Integraciones externas  
* Sincronizaci√≥n con terceros

### **‚ùå UI / UX**

* Dise√±o visual  
* Frontend  
* Mobile UI  
* Experiencia de usuario

### **‚ùå Reporting**

* Dashboards  
* M√©tricas de negocio  
* KPIs

---

## **üß± Regla de oro del Scope**

**FASE 1 \= infraestructura, identidad, seguridad y tenant.**  
**FASE 1 ‚â† negocio.**

Cualquier funcionalidad que:

* genere dinero  
* represente operaciones  
* impacte contabilidad  
* dependa de reglas comerciales

üëâ **NO pertenece a Fase 1\.**

---

## **üîí Estado del Scope**

* **Estado:** CONGELADO  
* **Modificable:** ‚ùå No  
* **Cambio de alcance:** solo mediante apertura formal de nueva fase

---

## **‚úÖ Conclusi√≥n**

Este documento:

* cierra definitivamente el alcance de la Fase 1  
* protege al sistema de sobreingenier√≠a  
* habilita avanzar r√°pido a Fase 2 sin deuda  
* sirve como contrato t√©cnico y de producto

---

## **EVENTOS AUDITABLES**

### **Objetivo**

Dejar **expl√≠cito** qu√© acciones **SIEMPRE** generan auditor√≠a.  
Nada queda impl√≠cito. Nada ‚Äúa criterio‚Äù.

---

## **üßæ EVENTOS QUE DEBEN AUDITARSE (OBLIGATORIOS)**

### **Usuarios**

* create user  
* update user  
* change status (pending/active/locked/disabled/deleted)  
* manual lock / unlock  
* email verified  
* password reset (used)

### **Seguridad**

* login\_success  
* login\_failed  
* auto\_lock  
* auto\_unlock  
* session revoked  
* install completed

### **Empresas**

* create company  
* update company  
* change company status  
* archive company  
* delete (l√≥gico) company

### **Membres√≠as**

* invite user  
* accept invitation  
* reject / revoke invitation  
* add membership  
* remove membership (logical)  
* change membership role  
* last owner protection triggered (evento expl√≠cito)

### **Configuraci√≥n**

* create setting  
* update setting  
* delete (logical) setting

### **Archivos**

* upload file  
* link file  
* unlink file  
* archive file  
* delete (logical) file

### **Legal**

* accept TOS / privacy  
* change legal version required

---

## **üìå REGLAS DURAS**

* Todo evento auditado:  
  * **qui√©n** (user\_id o system)  
  * **cu√°ndo**  
  * **qu√© entidad**  
  * **antes / despu√©s**  
* Auditor√≠a:  
  * append-only  
  * no editable  
  * no eliminable  
* Eventos de seguridad **tambi√©n** se reflejan en `audit_log` (tipo `security`).

---

## **FLUJO DE INSTALACI√ìN INICIAL**

### **Objetivo**

Garantizar **arranque desde cero** sin riesgo de takeover.

---

1. **Estado inicial del sistema**  
   * Sistema arranca como **NO INSTALADO**.  
   * No existe ning√∫n usuario v√°lido.  
2. **Endpoint de instalaci√≥n**  
   * Solo disponible mientras `APP_INSTALLED = false`.  
   * Permite crear **UN SOLO usuario inicial**.  
3. **Primer usuario**  
   * Se convierte autom√°ticamente en:  
     * `superadmin`  
     * `owner` de la empresa inicial (si se crea)  
   * Email **debe verificarse**.  
4. **Empresa inicial**  
   * Opcional.  
   * Si se crea, queda asociada al usuario inicial como `owner`.  
5. **Cierre del modo instalaci√≥n**  
   * Al finalizar:  
     * `APP_INSTALLED = true`  
     * Endpoint de instalaci√≥n queda **bloqueado permanentemente**.  
   * Evento auditado: `install_completed`.  
6. **Post-instalaci√≥n**  
   * Cualquier nuevo usuario:  
     * solo por invitaci√≥n  
     * o por flujo controlado normal

---

## **FLUJO DE LOGIN (AUTENTICACI√ìN)**

### **Objetivo**

Permitir acceso seguro al sistema **sin revelar informaci√≥n sensible**, con control de abuso y trazabilidad total.

---

### **üìå Precondiciones**

* Sistema instalado (`APP_INSTALLED = true`)  
* Usuario existente o no (el flujo **no debe revelar** cu√°l de los dos casos aplica)

---

### **üîÅ Flujo secuencial**

1. **Recepci√≥n de credenciales**  
   * Se recibe `email + password`  
   * Respuesta gen√©rica ante error (siempre igual)  
2. **Registro del intento**  
   * Se registra **siempre** un evento de seguridad:  
     * `login_failed` o `login_success`  
   * Se guarda:  
     * email  
     * ip  
     * user\_agent  
     * timestamp  
3. **Validaciones de estado**  
   * Si `status = deleted | disabled` ‚Üí rechazo silencioso  
   * Si `status = locked`:  
     * si `locked_until` venci√≥ ‚Üí desbloqueo autom√°tico \+ evento  
     * si no ‚Üí rechazo  
4. **Chequeo de credenciales**  
   * Comparaci√≥n segura del hash  
   * Sin early-exit (timing attack safe)  
5. **Pol√≠tica de bloqueo autom√°tico**  
   * N intentos fallidos en ventana T ‚Üí `locked`  
   * Se setea `locked_until`  
   * Evento: `auto_lock`  
6. **Login exitoso**  
   * Se crea sesi√≥n:  
     * refresh token √∫nico  
     * expiraci√≥n  
   * Se asigna empresa activa:  
     * √∫ltima usada  
     * o primera disponible  
   * Evento: `login_success`  
7. **Respuesta**  
   * Tokens \+ metadata m√≠nima  
   * Nunca:  
     * estados internos  
     * razones de bloqueo  
     * confirmaci√≥n de existencia de usuario

---

### **üîí Reglas duras**

* El sistema **no dice**:  
  * ‚Äúusuario no existe‚Äù  
  * ‚Äúpassword incorrecto‚Äù  
  * ‚Äúusuario bloqueado‚Äù  
* Todas las respuestas de error son equivalentes.  
* Todos los eventos quedan auditados.  
* Login **nunca** modifica datos de negocio.

---

### **‚úî Resultado**

* Login seguro  
* Sin filtraciones  
* Preparado para rate-limit y MFA futuro  
* Auditable y escalable

---

## **‚úÖ PASO 9 ‚Äî LOGOUT & REVOCACI√ìN DE SESIONES**

### **Objetivo**

Garantizar que **una sesi√≥n pueda invalidarse inmediatamente** sin afectar otras ni dejar residuos de seguridad.

---

### **üîÅ Flujo de logout (usuario)**

1. **Solicitud de logout**  
   * Se recibe identificador de sesi√≥n / refresh token.  
   * No se revela estado previo.  
2. **Revocaci√≥n**  
   * La sesi√≥n se marca como **revocada**.  
   * Se invalida el refresh token.  
3. **Auditor√≠a**  
   * Evento de seguridad registrado:  
     * `session_revoked`  
   * Actor \= usuario.  
4. **Respuesta**  
   * Siempre exitosa (idempotente).

---

### **üîí Revocaci√≥n forzada (sistema)**

Se revocan **todas las sesiones activas** del usuario cuando:

* usuario pasa a `locked`  
* usuario pasa a `disabled`  
* usuario pasa a `deleted`  
* cambio de contrase√±a  
* reset de contrase√±a usado

Eventos auditados correspondientes.

---

### **üß± Reglas duras**

* Logout **no elimina** la sesi√≥n, la invalida.  
* Tokens revocados **no pueden reutilizarse**.  
* Revocar una sesi√≥n **no impacta** otras (salvo revocaci√≥n forzada).  
* Repetir logout **no genera error**.

---

### **‚úî Resultado**

* Cierre de sesi√≥n inmediato  
* Control total del acceso  
* Sin efectos colaterales  
* Auditor√≠a completa

---

---

## **‚úÖ PASO 10 ‚Äî RECUPERACI√ìN DE CONTRASE√ëA**

### **Objetivo**

Permitir restablecer contrase√±a **sin filtrar informaci√≥n**, con control total y trazabilidad.

---

### **üîÅ Flujo end-to-end**

1. **Solicitud de reset**  
   * Se recibe email.  
   * Respuesta **siempre gen√©rica** (exista o no el usuario).  
   * Evento de seguridad registrado:  
     * `password_reset_requested`.  
2. **Generaci√≥n de token**  
   * Token:  
     * √∫nico  
     * de un solo uso  
     * con vencimiento corto.  
   * Asociado al usuario si existe.  
   * Nunca se expone el user\_id.  
3. **Env√≠o**  
   * Se env√≠a link con token.  
   * Reenviable, invalida tokens anteriores activos.  
4. **Uso del token**  
   * Se valida:  
     * no expirado  
     * no usado  
   * Se establece nueva contrase√±a.  
   * Se invalidan **todas las sesiones activas**.  
   * Evento: `password_reset_used`.  
5. **Cierre**  
   * Token marcado como usado.  
   * Usuario queda en estado `active` (si no estaba `disabled/deleted`).

---

### **üîí Reglas duras**

* Nunca se informa si el email existe.  
* Tokens:  
  * no reutilizables  
  * no extensibles  
* Reset **no desbloquea** usuarios `disabled` o `deleted`.  
* Todo el flujo queda auditado.

---

### **‚úî Resultado**

* Recuperaci√≥n segura  
* Sin filtraciones  
* Sin sesiones zombie  
* Lista para producci√≥n real

---

---

## **‚úÖ PASO 11 ‚Äî VERIFICACI√ìN DE EMAIL**

### **Objetivo**

Confirmar la **identidad del email** antes de habilitar acceso operativo.

---

### **üîÅ Flujo end-to-end**

1. **Generaci√≥n del token**  
   * Token:  
     * √∫nico  
     * de un solo uso  
     * con vencimiento.  
   * Asociado al usuario en estado `pending`.  
2. **Env√≠o**  
   * Se env√≠a email con link de verificaci√≥n.  
   * Reenv√≠o permitido.  
   * Cada reenv√≠o invalida tokens previos activos.  
   * Evento: `email_verification_sent`.  
3. **Uso del token**  
   * Validaci√≥n:  
     * existe  
     * no expirado  
     * no usado  
   * Se marca:  
     * `email_verified_at`  
     * `status = active`  
   * Evento: `email_verified`.  
4. **Respuesta**  
   * √âxito gen√©rico.  
   * Nunca revela estado interno previo.

---

### **üîí Reglas duras**

* Un usuario **no puede operar** sin email verificado.  
* Verificar email **no crea sesi√≥n autom√°ticamente**.  
* Tokens:  
  * no reutilizables  
  * no prorrogables.  
* Usuarios `disabled` o `deleted` **no pueden verificarse**.  
* Todo evento queda auditado.

---

### **‚úî Resultado**

* Identidad validada  
* Menos spam / cuentas basura  
* Base legal y de seguridad s√≥lida

---

---

## **‚úÖ PASO 12 ‚Äî ACEPTACI√ìN LEGAL OBLIGATORIA**

### **Objetivo**

Garantizar **cumplimiento legal** antes de cualquier uso operativo del sistema.

---

### **üîÅ Flujo end-to-end**

1. **Definici√≥n de documentos activos**  
   * Tipos: `tos`, `privacy`, `cookies`  
   * Cada uno con **versi√≥n vigente**.  
2. **Chequeo previo**  
   * En login / primera operaci√≥n:  
     * si falta aceptaci√≥n de **alg√∫n documento vigente** ‚Üí acceso **bloqueado** a funciones operativas.  
3. **Presentaci√≥n**  
   * Se muestra documento \+ versi√≥n.  
   * Aceptaci√≥n **expl√≠cita** (no impl√≠cita).  
4. **Registro**  
   * Se guarda:  
     * user\_id  
     * document\_type  
     * document\_version  
     * timestamp  
   * Evento auditado: `legal_accepted`.  
5. **Cambio de versi√≥n**  
   * Nueva versi√≥n invalida aceptaciones previas.  
   * Usuario debe **reaceptar**.

---

### **üîí Reglas duras**

* Sin aceptaci√≥n ‚Üí **no hay operaci√≥n**.  
* Aceptaci√≥n:  
  * es **inmutable**  
  * no se edita  
  * no se elimina.  
* Usuarios `disabled` o `deleted` **no aceptan**.  
* Aceptar legal **no crea sesi√≥n** ni modifica seguridad.

---

### **‚úî Resultado**

* Cobertura legal s√≥lida  
* Prueba hist√≥rica de aceptaci√≥n  
* Preparado para monetizaci√≥n y compliance

---

---

## **‚úÖ PASO 13 ‚Äî FLUJOS MULTIEMPRESA (USO REAL)**

### **Objetivo**

Permitir que un usuario **opere correctamente en m√∫ltiples empresas** sin cruces, sin ambig√ºedad y con control total.

---

### **üè¢ 1\) Creaci√≥n de empresa**

**Qui√©n puede crear**

* Usuario `active`  
* Con rol global v√°lido  
* O miembro con permiso de creaci√≥n (definido a nivel producto)

**Reglas**

* La empresa nace:  
  * `status = active`  
  * con **al menos un owner**  
* El creador queda como `owner` autom√°ticamente.  
* Evento auditado: `company_created`.

---

### **‚úâÔ∏è 2\) Invitaci√≥n a empresa**

**Flujo**

1. Owner/Admin invita por email.  
2. Se crea invitaci√≥n con:  
   * rol asignado  
   * expiraci√≥n  
3. Evento: `company_invite_sent`.

**Reglas**

* Invitaci√≥n:  
  * es √∫nica  
  * no reutilizable  
  * expira  
* Invitar a email ya miembro ‚Üí rechazo expl√≠cito.

---

### **‚úÖ 3\) Aceptaci√≥n / rechazo**

**Aceptar**

* Si usuario existe ‚Üí se crea membership.  
* Si no existe ‚Üí se crea usuario `pending`.  
* Se asigna rol.  
* Evento: `company_invite_accepted`.

**Rechazar**

* No crea membership.  
* Evento: `company_invite_rejected`.

---

### **üîÅ 4\) Cambio de contexto de empresa**

**Reglas**

* Un usuario solo puede operar dentro de:  
  * una empresa activa  
  * de la que sea miembro activo  
* El contexto:  
  * se guarda por sesi√≥n  
  * no es impl√≠cito  
* Evento: `company_context_changed`.

---

### **üîí 5\) Protecci√≥n de ownership**

* Una empresa **nunca** puede quedar sin `owner`.  
* Intentar remover al √∫ltimo owner:  
  * operaci√≥n bloqueada  
  * evento auditado: `last_owner_protection`.

---

### **üß± 6\) Salida de empresa**

**Reglas**

* Un usuario puede salir de una empresa.  
* No puede salir si es el √∫ltimo owner.  
* Evento: `membership_left`.

---

### **‚úî Resultado**

* Multiempresa real  
* Sin fugas de datos  
* Flujos claros para usuarios reales  
* Preparado para escalar a ERP

---

---

## **‚úÖ PASO 14 ‚Äî LIFECYCLE DE EMPRESAS**

### **Objetivo**

Definir **c√≥mo una empresa cambia de estado** sin p√©rdida de datos ni inconsistencias.

---

### **üß≠ Estados permitidos**

* `active` ‚Üí operativa  
* `inactive` ‚Üí pausada (sin nuevas operaciones)  
* `archived` ‚Üí hist√≥rica, solo lectura  
* `deleted` ‚Üí eliminaci√≥n l√≥gica (no visible, no operable)

---

### **üîÅ Transiciones v√°lidas**

1. **active ‚Üí inactive**  
   * Permitido siempre.  
   * No elimina datos.  
   * Evento: `company_deactivated`.  
2. **inactive ‚Üí active**  
   * Permitido si no hay bloqueos legales.  
   * Evento: `company_reactivated`.  
3. **active / inactive ‚Üí archived**  
   * Requiere:  
     * cero operaciones activas  
     * usuarios notificados  
   * Empresa queda **solo lectura**.  
   * Evento: `company_archived`.  
4. **archived ‚Üí active**  
   * Permitido por owner/superadmin.  
   * Evento: `company_restored`.  
5. **archived ‚Üí deleted**  
   * Requiere:  
     * sin datos activos dependientes  
     * confirmaci√≥n expl√≠cita  
   * Marca `deleted_at`.  
   * Evento: `company_deleted_logical`.

---

### **üîí Reglas duras**

* **Nunca** borrado f√≠sico.  
* **Nunca** dejar empresa sin `owner`.  
* No se puede:  
  * archivar si hay operaciones activas  
  * eliminar si hay dependencias activas  
* Toda transici√≥n es **auditada**.

---

### **‚úî Resultado**

* Ciclo de vida claro y seguro  
* Historial intacto  
* Preparado para compliance y soporte

---

---

## **‚úÖ PASO 15 ‚Äî LIFECYCLE DE USUARIOS**

### **Objetivo**

Definir **c√≥mo evoluciona un usuario** desde su creaci√≥n hasta su eliminaci√≥n l√≥gica, **sin perder trazabilidad ni seguridad**.

---

### **üß≠ Estados permitidos**

* `pending` ‚Üí creado, email no verificado  
* `active` ‚Üí puede operar  
* `locked` ‚Üí bloqueo autom√°tico temporal  
* `disabled` ‚Üí bloqueo manual administrativo  
* `deleted` ‚Üí eliminaci√≥n l√≥gica (no visible, no accesible)

---

### **üîÅ Transiciones v√°lidas**

1. **pending ‚Üí active**  
   * Requiere:  
     * verificaci√≥n de email  
     * aceptaci√≥n legal vigente  
   * Evento: `user_activated`.  
2. **active ‚Üí locked**  
   * Autom√°tico por seguridad (intentos fallidos).  
   * Se define `locked_until`.  
   * Evento: `user_auto_locked`.  
3. **locked ‚Üí active**  
   * Autom√°tico al vencer `locked_until`.  
   * Evento: `user_auto_unlocked`.  
4. **active ‚Üí disabled**  
   * Manual (admin/superadmin).  
   * No reversible sin intervenci√≥n expl√≠cita.  
   * Evento: `user_disabled`.  
5. **disabled ‚Üí active**  
   * Manual (admin/superadmin).  
   * Evento: `user_reenabled`.  
6. **active / disabled ‚Üí deleted**  
   * Eliminaci√≥n l√≥gica.  
   * Usuario:  
     * pierde acceso  
     * conserva historial  
   * Evento: `user_deleted_logical`.

---

### **üîí Reglas duras**

* **Nunca** borrado f√≠sico.  
* Usuario `deleted`:  
  * no inicia sesi√≥n  
  * no acepta invitaciones  
  * no acepta legales  
* Bloqueos autom√°ticos:  
  * **no** cambian membres√≠as  
* Bloqueos manuales:  
  * revocan **todas** las sesiones.  
* Cambios de estado **siempre auditados**.

---

### **üß± Relaci√≥n con empresas**

* Eliminar l√≥gicamente un usuario:  
  * **no elimina** empresas  
  * **no elimina** auditor√≠a  
  * memberships pasan a `revoked`  
* No se puede eliminar:  
  * si es **√∫ltimo owner** de alguna empresa  
  * sin transferir ownership antes

---

### **‚úî Resultado**

* Ciclo de vida claro  
* Seguridad total  
* Sin p√©rdida hist√≥rica  
* Compatible con crecimiento y compliance

---

---

## **‚úÖ PASO 16 ‚Äî LIFECYCLE DE MEMBRES√çAS Y ROLES**

### **Objetivo**

Definir **c√≥mo un usuario entra, cambia y sale de una empresa**, y c√≥mo evolucionan sus roles **sin romper ownership ni seguridad**.

---

## **üß≠ Estados de company\_memberships**

* `invited` ‚Üí invitaci√≥n emitida, no aceptada  
* `active` ‚Üí miembro operativo  
* `revoked` ‚Üí acceso retirado por la empresa  
* `left` ‚Üí salida voluntaria del usuario  
* `deleted` ‚Üí eliminaci√≥n l√≥gica (hist√≥rica)

---

## **üîÅ Transiciones v√°lidas (membership)**

1. **invited ‚Üí active**  
   * Invitaci√≥n aceptada.  
   * Evento: `membership_activated`.  
2. **invited ‚Üí revoked**  
   * Invitaci√≥n cancelada.  
   * Evento: `membership_invite_revoked`.  
3. **active ‚Üí revoked**  
   * Acci√≥n de owner/admin.  
   * Evento: `membership_revoked`.  
4. **active ‚Üí left**  
   * Acci√≥n del usuario.  
   * Evento: `membership_left`.  
5. **revoked / left ‚Üí active**  
   * Solo por nueva invitaci√≥n.  
   * Evento: `membership_reactivated`.  
6. **any ‚Üí deleted**  
   * Eliminaci√≥n l√≥gica hist√≥rica.  
   * Evento: `membership_deleted_logical`.

---

## **üß≠ Estados de membership\_roles**

* `active`  
* `deleted`

---

## **üîÅ Transiciones v√°lidas (roles)**

1. **Asignaci√≥n inicial**  
   * Se crea un rol activo.  
   * Evento: `role_assigned`.  
2. **Cambio de rol**  
   * Nuevo rol activo.  
   * Rol previo pasa a `deleted`.  
   * Evento: `role_changed`.  
3. **Eliminaci√≥n l√≥gica**  
   * Solo si existe otro rol activo.  
   * Evento: `role_deleted_logical`.

---

## **üîí Reglas duras**

* Un membership tiene **un solo rol activo**.  
* Una empresa **no puede quedar sin owner**.  
* No se puede:  
  * revocar  
  * cambiar rol  
  * eliminar  
    a un membership si rompe la regla de ownership.  
* Todos los cambios:  
  * son expl√≠citos  
  * son auditados.

---

## **üß± Relaci√≥n con usuarios y empresas**

* Desactivar un usuario:  
  * **no borra** memberships  
  * impide operar  
* Archivar empresa:  
  * memberships quedan solo lectura  
* Eliminar empresa l√≥gicamente:  
  * memberships pasan a `deleted`

---

### **‚úî Resultado**

* Control total de acceso por empresa  
* Ownership protegido  
* Historial intacto  
* Base s√≥lida para permisos futuros

---

---

## **‚úÖ PASO 17 ‚Äî CIERRE FORMAL DE FASE 1**

### **Objetivo**

Declarar la **FASE 1 oficialmente terminada**, **congelada** y **lista para ser implementada** sin reinterpretaciones.

---

## **üßæ Checklist final (obligatorio)**

### **üîí Arquitectura**

* Identidad global definida (users).  
* Multiempresa real sin cruces.  
* Roles gruesos, no permisos finos.  
* Sin borrado f√≠sico en entidades core.  
* Regla padre‚Äìhijo aplicada a todo.

### **üß≠ Ciclos de vida**

* Usuarios: definidos y auditados.  
* Empresas: definidos y auditados.  
* Membres√≠as y roles: definidos y protegidos.  
* Sesiones y seguridad: definidos end-to-end.

### **üîê Seguridad**

* Login seguro sin filtrado de informaci√≥n.  
* Bloqueos autom√°ticos y manuales.  
* Tokens seguros y revocables.  
* Auditor√≠a de eventos cr√≠ticos y de seguridad.

### **üßæ Auditor√≠a y legal**

* Audit log universal, append-only.  
* Eventos de seguridad separados y auditados.  
* Aceptaci√≥n legal versionada e inmutable.

### **üß± Scope**

* Alcance incluido/excluido documentado.  
* Fase 1 **no contiene negocio**.  
* Fase 1 **no contiene contabilidad**.  
* Fase 1 **no contiene permisos finos**.

---

## **üîí Estado oficial**

* **Fase:** CORE PLATFORM ‚Äì FASE 1  
* **Estado:** CERRADA / CONGELADA  
* **Modificable:** ‚ùå No  
* **Cambios:** solo mediante apertura formal de Fase 2+  
* **Uso:** contrato t√©cnico y de producto

---

## **üìå Declaraci√≥n final**

‚ÄúEste documento define el n√∫cleo inmutable del sistema.  
Cualquier implementaci√≥n debe ajustarse a estas reglas sin excepci√≥n.‚Äù

Con esto:

* no hay deuda conceptual  
* no hay ambig√ºedades  
* no hay decisiones postergadas  
* el sistema es escalable y seguro por dise√±o

---



===== ARCHIVO: üìò FASE 2 - SISA ERP.md =====
# **üìò FASE 2 ‚Äî SISA ERP**

## **PASO 2 ‚Äî DOCUMENTACI√ìN OPERATIVA COMPLETA Y DEFINITIVA**

**Contrato de arquitectura ‚Ä¢ Sin c√≥digo ‚Ä¢ Sin SQL ‚Ä¢ Sin implementaci√≥n**

---

# **üß≠ 0\. PROP√ìSITO DE LA FASE 2**

FASE 2 define el **ERP Operativo**:

* registra hechos operativos reales  
* organiza relaciones entre empresas  
* maneja tiempos, estados y responsabilidades  
* produce datos **consistentes, inmutables y auditables**  
* prepara la informaci√≥n para que **ACCCORE (Fase 3\)** genere contabilidad

FASE 2 **no interpreta**, solo **registra**.

---

# **üß± 1\. PRINCIPIOS RECTORES (INAMOVIBLES)**

### **1.1 No existe borrado f√≠sico**

Todo registro permanece.  
Solo existe:

* `status`  
* `deleted_at`  
* estados terminales (`cancelled`, `voided`, `completed`, etc.)

### **1.2 Regla 4equim (Padre‚ÄìHijo)**

No se puede cerrar o invalidar un padre si hay hijos activos contradictorios:

Ejemplos:

* una factura `issued` no puede `voided` si tiene receipts `completed`  
* una venta no puede `cancelled` si tiene invoice activa  
* un job no puede eliminarse si tiene ejecuci√≥n

### **1.3 Audit Trail Obligatorio**

Toda acci√≥n significativa genera:

* actor  
* timestamp  
* entidad \+ id  
* estado anterior ‚Üí nuevo  
* motivo (si aplica)  
* dependencias vinculadas

Intentos bloqueados **tambi√©n se auditan**.

### **1.4 Idempotencia real**

La misma operaci√≥n repetida:

* no duplica efectos  
* responde ‚Äúok, ya estaba hecho‚Äù  
* se puede registrar como no-op relevante

### **1.5 Estados terminales**

No retroceden:

* `completed`  
* `cancelled`  
* `voided`  
* `reversed`  
* `deleted`

### **1.6 Inmutabilidad de datos operativos**

Una vez emitidos/confirmados:

‚ùå No se modifican importes  
‚ùå No se cambian √≠tems  
‚ùå No se cambian fechas reales  
‚úî Se permiten **ajustes** mediante eventos expl√≠citos

---

# **üß± 2\. CLIENTES Y PROVEEDORES ‚Äî DEFINICI√ìN FINAL**

**No existen tablas clients ni providers.**

Regla absoluta:

Cliente y proveedor son solamente **roles** de una **empresa existente en la tabla `companies`**.

Referencias v√°lidas:

* `client_company_id` ‚Üí `companies.id`  
* `provider_company_id` ‚Üí `companies.id`

Una empresa puede ser:

* cliente  
* proveedor  
* ambas  
* ninguna

No se duplican datos.  
No se reescribe CUIT.  
No se generan inconsistencias legales.

---

# **üß± 3\. ENTIDADES OPERATIVAS DE FASE 2**

FASE 2 define:

* **Sales** (ventas operativas)  
* **Purchases** (compras operativas)  
* **Quotes** (presupuestos)  
* **Jobs** (√≥rdenes de trabajo)  
* **Invoices** (documento operativo)  
* **Receipts** (cobros)  
* **Payments** (pagos)  
* **Adjustments** (ajustes operativos)

Todas:

* pertenecen a una empresa  
* tienen lifecycle  
* generan auditor√≠a  
* respetan regla 4equim  
* NO generan asientos contables  
* NO interpretan fiscalidad

---

# **üß± 4\. LIFECYCLE POR ENTIDAD**

(M√°quinas de estado completas, definitivas)

---

# **4.1 JOBS / WORK ORDERS ‚Äî Modelo Final**

## **Estados v√°lidos**

* `planned`  
* `in_progress`  
* `paused`  
* `completed` (terminal)  
* `cancelled` (terminal)

## **‚ùå Transiciones prohibidas**

* `completed ‚Üí *`  
* `cancelled ‚Üí *`  
* `in_progress ‚Üí planned`  
* `paused ‚Üí planned` (NO permitido)

## **‚úî Transiciones v√°lidas**

* `planned ‚Üí in_progress`  
* `planned ‚Üí cancelled`  
* `in_progress ‚Üí paused`  
* `paused ‚Üí in_progress`  
* `in_progress ‚Üí completed`  
* `paused ‚Üí completed` (requiere evidencia real)

## **Precondiciones obligatorias**

### **Para `planned ‚Üí in_progress`**

* **start\_datetime obligatorio**  
* responsable asignado  
* tipo de job definido  
* empresa activa

### **Para `in_progress ‚Üí completed`**

Debe existir evidencia:

* timestamps reales de inicio/fin  
* tareas ejecutadas  
* tiempos registrados  
* evento expl√≠cito de cierre

### **Cancelaci√≥n**

* desde `planned`: libre con motivo  
* desde `in_progress`: permitido con evidencia \+ motivo  
  (no se borra lo ya ejecutado)

---

# **4.2 MODIFICACI√ìN DE FECHAS ‚Äî SOLUCI√ìN FINAL Y UNIVERSAL**

### **Principio duro**

El pasado NO se edita.  
Se corrige agregando historia.

### **Tipos de fechas**

* **planificadas** ‚Üí editables  
* **reales** ‚Üí inmutables  
* **correcciones** ‚Üí eventos

## **C√≥mo se modifica:**

### **Estado `planned`**

‚úî puede cambiar fechas sin restricciones  
‚úî auditado

### **Estados `in_progress` / `paused`**

‚ùå NO se edita lo que ya ocurri√≥  
‚úî se ajusta lo futuro  
‚úî se registra **schedule\_adjusted**

### **Estado `completed`**

‚ùå No se puede tocar  
‚úî solo ajustes mediante eventos: `job_time_correction_applied`

---

# **4.3 SALES**

## **Estados**

* `draft`  
* `confirmed`  
* `cancelled` (terminal)

## **Transiciones v√°lidas**

* `draft ‚Üí confirmed`  
* `draft ‚Üí cancelled`  
* `confirmed ‚Üí cancelled` (si no tiene invoice o receipts activos)

## **Precondiciones para `draft ‚Üí confirmed`**

* company activa  
* client\_company\_id v√°lido  
* items \> 0  
* moneda definida  
* fecha operativa

---

# **4.4 PURCHASES**

Sim√©trico a Sales:

* `draft ‚Üí confirmed`  
* `draft ‚Üí cancelled`  
* `confirmed ‚Üí cancelled` (sin pagos ni documentos activos)

---

# **4.5 QUOTES (PRESUPUESTOS)**

## **Estados**

* `draft`  
* `sent`  
* `accepted`  
* `rejected`  
* `expired` (terminal)

## **Transiciones**

* `draft ‚Üí sent`  
* `sent ‚Üí accepted`  
* `sent ‚Üí rejected`  
* `sent ‚Üí expired`

Accepted ‚Üí terminal l√≥gico (no vuelve atr√°s)

---

# **4.6 INVOICES (Documento operativo)**

## **Estados**

* `draft`  
* `issued`  
* `voided`

## **Transiciones v√°lidas**

* `draft ‚Üí issued`  
* `draft ‚Üí voided`  
* `issued ‚Üí voided` (sin receipts completed)

---

# **4.7 RECEIPTS (Cobros)**

## **Estados**

* `pending`  
* `completed`  
* `reversed`

## **Transiciones v√°lidas**

* `pending ‚Üí completed`  
* `pending ‚Üí reversed`  
* `completed ‚Üí reversed`

---

# **4.8 PAYMENTS (Pagos)**

Sim√©trico a receipts.

---

# **4.9 ADJUSTMENTS (Ajustes operativos)**

Se usan para:

* corregir tiempos reales  
* corregir datos hist√≥ricos relevantes  
* sin reescribir el registro original

Estados:

* `draft`  
* `applied` (terminal)  
* `cancelled`

---

# **üß± 5\. VALIDACIONES CRUZADAS DEL ERP**

### **5.1 Dependencias inconsistentes (bloquea)**

Ejemplos:

* invoice con receipt ‚Üí no se puede voided  
* sale con invoice ‚Üí no se puede cancelar  
* purchase con payment ‚Üí no se puede cancelar

### **5.2 Temporalidad**

No se puede reescribir:

* fechas reales  
* eventos pasados  
* operaciones ya emitidas/confirmadas

### **5.3 Empresas inactivas**

Si `company.status != active`:

* no se pueden crear operaciones nuevas  
* solo lectura y archivado

---

# **üß± 6\. AUDITOR√çA OBLIGATORIA**

Cada transici√≥n o cambio relevante genera:

* actor  
* timestamp  
* estado anterior / nuevo  
* payload de cambios  
* motivo (si corresponde)  
* ids referenciados  
* no-op si corresponde

Cambios temporales SIEMPRE auditan valor anterior y nuevo.

---

# **üß± 7\. EVENTOS OPERATIVOS**

(Base para ACCCORE)

FASE 2 genera eventos como:

* `job_started`  
* `job_paused`  
* `job_completed`  
* `job_cancelled`  
* `schedule_adjusted`  
* `sale_confirmed`  
* `invoice_issued`  
* `receipt_completed`  
* `payment_completed`  
* `correction_applied`  
* etc.

Estos eventos:

* son inmutables  
* no se modifican  
* son el insumo de ACCCORE  
* no contienen l√≥gica contable

---

# **üß± 8\. RELACI√ìN FASE 2 ‚Üí FASE 3**

FASE 2:

* registra hechos brutos  
* mantiene historia limpia  
* garantiza trazabilidad completa

FASE 3:

* lee eventos  
* genera asientos  
* aplica fiscalidad y reglas contables

FASE 2 NO incluye:

* cuentas contables  
* IVA  
* percepciones  
* amortizaci√≥n  
* resultados  
* cashflow contable

---



===== ARCHIVO: üìò PERMISOS FINOS - ACL _ RBAC EXTENDIDO (M√ìDULO TRANSVERSAL).md =====
# **üìò PERMISOS FINOS ‚Äî ACL / RBAC EXTENDIDO (M√ìDULO TRANSVERSAL)**

**Contrato de Arquitectura ‚Äî Sin implementaci√≥n ‚Äî Sin c√≥digo**

---

## **üéØ PROP√ìSITO DEL M√ìDULO**

Este m√≥dulo define **qu√© puede hacer cada usuario** dentro del sistema, de forma:

* granular

* auditable

* reproducible

* independiente del negocio

* independiente de la contabilidad

Los permisos finos **NO forman parte del Core**, **NO pertenecen al ERP**, y **NO son contabilidad**.

Son una **capa transversal**, apoyada sobre el Core.

---

## **üß± POSICI√ìN EN LA ARQUITECTURA**

`1) Core Platform`  
`2) Permisos Finos (ACL / RBAC)`  
`3) ERP Operativo`  
`4) Contabilidad (ACCCORE)`

### **Dependencias**

* Depende de: Core Platform

* NO depende de: ERP, Contabilidad

* Es requerido por: ERP y Contabilidad

---

## **üß± PRINCIPIOS INMUTABLES**

### **1Ô∏è‚É£ Separaci√≥n total de responsabilidades**

* Core ‚Üí identidad y pertenencia

* Permisos Finos ‚Üí autorizaci√≥n

* ERP ‚Üí l√≥gica operativa

* Contabilidad ‚Üí interpretaci√≥n financiera

Nunca se mezclan.

---

### **2Ô∏è‚É£ Permisos expl√≠citos**

Si una acci√≥n no tiene permiso expl√≠cito:

* est√° prohibida

* no se infiere

* no se hereda impl√≠citamente

---

### **3Ô∏è‚É£ Evaluaci√≥n determin√≠stica**

Dado:

* usuario

* empresa

* acci√≥n

üëâ el resultado de autorizaci√≥n es **siempre el mismo**.

---

### **4Ô∏è‚É£ Auditor√≠a obligatoria**

Toda decisi√≥n relevante de autorizaci√≥n:

* puede auditarse

* puede reproducirse

* puede explicarse

---

## **üß± COMPONENTES DEL M√ìDULO**

---

### **üîπ 1\) PERMISSIONS (Permisos at√≥micos)**

Un permiso representa **una acci√≥n concreta** del sistema.

Ejemplos:

* `jobs.view`

* `jobs.create`

* `jobs.update`

* `jobs.complete`

* `jobs.cancel`

* `invoices.issue`

* `invoices.void`

* `receipts.complete`

* `payments.execute`

* `accounting.view_reports`

* `accounting.post_entries`

* `settings.manage`

* `users.invite`

#### **Reglas**

* Son at√≥micos

* No dependen del rol

* No dependen de la UI

* No contienen l√≥gica

---

### **üîπ 2\) PERMISSION GROUPS (opcional)**

Agrupan permisos por dominio funcional:

* Jobs

* Sales

* Purchases

* Invoices

* Accounting

* Configuration

* Security

Solo sirven para organizaci√≥n y UI.

---

### **üîπ 3\) ROLES FINOS (RBAC EXTENDIDO)**

Un rol fino es **un conjunto de permisos**, no una jerarqu√≠a.

Ejemplos:

* `erp_operator`

* `erp_manager`

* `finance_viewer`

* `finance_operator`

* `accounting_admin`

* `company_admin_extended`

#### **Reglas**

* Un rol **no hereda** de otro

* Los permisos se asignan expl√≠citamente

* Un rol puede cambiar sin afectar al Core

---

### **üîπ 4\) ASIGNACI√ìN DE ROLES FINOS POR EMPRESA**

Los roles finos se asignan **por empresa**, no globalmente.

Un mismo usuario puede ser:

* `erp_manager` en Empresa A

* `finance_viewer` en Empresa B

Siempre respetando:

* membership activa

* empresa activa

---

### **üîπ 5\) OVERRIDES POR USUARIO**

Adem√°s del rol fino, se permiten:

* permisos adicionales

* revocaciones puntuales

Ejemplos:

* permitir `jobs.cancel` a un usuario puntual

* negar `accounting.post_entries` aunque el rol lo tenga

Los overrides:

* son expl√≠citos

* son auditables

* nunca impl√≠citos

---

## **üß± FLUJO DE EVALUACI√ìN DE PERMISOS**

`1) Usuario autenticado`  
`2) Empresa activa`  
`3) Membership activa`  
`4) Rol grueso v√°lido (Core)`  
`5) Rol fino asignado`  
`6) Overrides aplicados`  
`7) Evaluaci√≥n del permiso solicitado`

Resultado:

* ALLOW

* DENY

Sin estados intermedios.

---

## **üßæ AUDITOR√çA DE AUTORIZACI√ìN**

Se debe poder registrar:

* usuario

* empresa

* permiso evaluado

* resultado

* motivo

* timestamp

Especialmente para:

* acciones sensibles

* denegaciones cr√≠ticas

* cambios de configuraci√≥n

---

## **üß± RELACI√ìN CON ROLES GRUESOS (CORE)**

Roles del Core:

* owner

* admin

* member

* viewer

### **Regla dura**

Los roles gruesos:

* **no otorgan permisos finos autom√°ticamente**

* solo habilitan **posibilidad de asignaci√≥n**

Ejemplo:

* `viewer` ‚Üí nunca puede recibir permisos de escritura

* `owner` ‚Üí puede recibir cualquier permiso fino

---

## **üß± RELACI√ìN CON ERP Y CONTABILIDAD**

ERP y Contabilidad:

* **consultan** permisos

* **no los definen**

* **no los modifican**

Esto permite:

* agregar m√≥dulos sin duplicar l√≥gica

* auditar accesos

* cambiar permisos sin tocar negocio

---

## **üß± SCOPE DEL M√ìDULO**

### **Incluye**

* permisos at√≥micos

* roles finos

* asignaci√≥n por empresa

* overrides

* auditor√≠a

### **NO incluye**

* autenticaci√≥n

* sesiones

* l√≥gica de negocio

* contabilidad

* UI

---

## **üîí ESTADO DEL DOCUMENTO**

* M√≥dulo: Permisos Finos

* Tipo: Transversal

* Estado: DEFINIDO

* Modificable: solo agregando permisos nuevos

* Eliminaci√≥n de permisos existentes: ‚ùå prohibida

---

## **‚úÖ CONCLUSI√ìN**

Este m√≥dulo:

* evita mezclar identidad con negocio

* permite escalar sin deuda

* habilita multiempresa real

* protege auditor√≠a y trazabilidad

* es compatible con cualquier ERP o m√≥dulo futuro



===== ARCHIVO: üìò PERMISOS GRUESOS - POL√çTICAS DE AUTORIZACI√ìN POR ROL GRUESO (CORE ROLES).md =====
# **üìò POL√çTICAS DE AUTORIZACI√ìN POR ROL GRUESO (CORE ROLES)**

**Contrato de Arquitectura ‚Äî Sin c√≥digo ‚Äî Sin implementaci√≥n**

---

## **üéØ PROP√ìSITO**

Este documento define **qu√© est√° permitido y qu√© est√° prohibido** para cada **rol grueso** del Core:

* `owner`  
* `admin`  
* `member`  
* `viewer`

Los roles gruesos **NO otorgan permisos finos directamente**.  
Definen **l√≠mites m√°ximos**, **restricciones duras** y **capacidades de asignaci√≥n**.

---

## **üß± PRINCIPIOS INMUTABLES**

1. Los roles gruesos **no ejecutan acciones**  
2. Los roles gruesos **limitan el universo de permisos finos posibles**  
3. Ning√∫n rol fino puede violar la pol√≠tica del rol grueso  
4. El Core **no conoce permisos finos**, solo pol√≠ticas  
5. Toda violaci√≥n ‚Üí **DENY** \+ evento auditable

---

## **üß≠ CAPAS DE DECISI√ìN**

Rol Grueso (Core)  
        ‚Üì limita  
Roles Finos (ACL)  
        ‚Üì combinan  
Permisos At√≥micos

Si una acci√≥n no est√° permitida por el **rol grueso**,  
**no importa** qu√© rol fino tenga el usuario ‚Üí **DENY**.

---

## **üëë ROL: OWNER**

### **üéØ Prop√≥sito**

Control total de la empresa.  
Responsable legal y operativo.

---

### **‚úÖ Puede**

* Asignar **cualquier rol fino**  
* Ejecutar **cualquier permiso fino**  
* Administrar usuarios y memberships  
* Modificar configuraci√≥n de empresa  
* Acceder a ERP completo  
* Acceder a contabilidad completa  
* Cerrar y reabrir per√≠odos contables  
* Ver y exportar auditor√≠a  
* Delegar permisos  
* Transferir ownership

---

### **‚ùå No puede**

* Eliminar f√≠sicamente datos  
* Eliminar auditor√≠a  
* Romper regla 4equim  
* Dejar la empresa sin owner

---

### **üîí Restricciones duras**

* Siempre debe existir **al menos un owner**  
* Todas las acciones cr√≠ticas son auditadas

---

## **üõ† ROL: ADMIN**

### **üéØ Prop√≥sito**

Gesti√≥n operativa y administrativa de la empresa.

---

### **‚úÖ Puede**

* Asignar **roles finos no cr√≠ticos**  
* Operar ERP completo  
* Gestionar jobs, ventas, compras  
* Emitir invoices  
* Gestionar cobros y pagos  
* Ver reportes operativos  
* Ver auditor√≠a (solo lectura)

---

### **‚ùå No puede**

* Asignar permisos contables cr√≠ticos  
* Cerrar o reabrir per√≠odos contables  
* Modificar reglas contables  
* Eliminar owners  
* Transferir ownership  
* Cambiar pol√≠ticas de autorizaci√≥n

---

### **üîí Restricciones duras**

* No puede auto-elevarse a owner  
* No puede modificar pol√≠ticas de rol grueso

---

## **üë∑ ROL: MEMBER**

### **üéØ Prop√≥sito**

Ejecuci√≥n operativa.

---

### **‚úÖ Puede**

* Ejecutar acciones **solo si tiene rol fino compatible**  
* Operar jobs  
* Registrar tiempos  
* Crear operaciones borrador  
* Subir y asociar archivos  
* Ver informaci√≥n operativa propia

---

### **‚ùå No puede**

* Asignar roles (finos o gruesos)  
* Cancelar operaciones cr√≠ticas  
* Emitir invoices  
* Confirmar ventas/compras  
* Acceder a contabilidad  
* Ver auditor√≠a  
* Cambiar configuraci√≥n de empresa

---

### **üîí Restricciones duras**

* Nunca puede recibir permisos contables  
* Nunca puede administrar usuarios

---

## **üëÄ ROL: VIEWER**

### **üéØ Prop√≥sito**

Lectura y observaci√≥n.

---

### **‚úÖ Puede**

* Ver informaci√≥n permitida  
* Ver jobs, ventas, invoices (read-only)  
* Ver reportes operativos b√°sicos

---

### **‚ùå No puede**

* Crear, modificar o cancelar nada  
* Registrar tiempos  
* Subir archivos  
* Ver contabilidad  
* Ver auditor√≠a  
* Gestionar usuarios  
* Ejecutar acciones

---

### **üîí Restricciones duras**

* Todos los permisos deben ser `.view`  
* Cualquier permiso de escritura ‚Üí DENY

---

## **üß± MATRIZ RESUMEN**

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  
‚îÇ Acci√≥n ‚îÇ Owner    ‚îÇ Admin    ‚îÇ Member   ‚îÇ Viewer   ‚îÇ  
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  
‚îÇ ERP    ‚îÇ FULL     ‚îÇ FULL     ‚îÇ LIMITADO ‚îÇ READ     ‚îÇ  
‚îÇ ACL    ‚îÇ FULL     ‚îÇ PARCIAL  ‚îÇ NO       ‚îÇ NO       ‚îÇ  
‚îÇ Contab ‚îÇ FULL     ‚îÇ NO       ‚îÇ NO       ‚îÇ NO       ‚îÇ  
‚îÇ Audit  ‚îÇ FULL     ‚îÇ READ     ‚îÇ NO       ‚îÇ NO       ‚îÇ  
‚îÇ Config ‚îÇ FULL     ‚îÇ LIMITED  ‚îÇ NO       ‚îÇ NO       ‚îÇ  
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

---

## **üßæ AUDITOR√çA DE POL√çTICAS**

Debe auditarse:

* asignaci√≥n de rol grueso  
* asignaci√≥n de rol fino  
* cambios de roles  
* intentos bloqueados por pol√≠tica  
* intentos de elevaci√≥n indebida

---

## **üîí REGLAS FINALES**

* Los roles gruesos **nunca cambian din√°micamente**  
* Los permisos finos **nunca rompen pol√≠ticas**  
* Toda evaluaci√≥n es determin√≠stica  
* Toda denegaci√≥n cr√≠tica es auditable  
* No hay excepciones impl√≠citas

---

## **‚úÖ CONCLUSI√ìN**

Con estas pol√≠ticas:

* El Core mantiene el control  
* ACL es flexible pero segura  
* ERP no conoce seguridad  
* Contabilidad queda protegida  
* El sistema es escalable  
* No hay escalamiento indebido  
* No hay deuda conceptual



